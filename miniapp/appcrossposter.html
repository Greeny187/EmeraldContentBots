
<!doctype html>
<html lang="de" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Emerald Crossposter</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      color-scheme: dark;
      --bg:#0b0f10; --card:#11181c; --ring:#1f2a2e; --text:#e6f1ff; --muted:#9fb3c8;
      --acc:#2dd4bf; --danger:#ef4444; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    [data-theme="light"]{
      color-scheme: light;
      --bg:#f7fafc; --card:#ffffff; --ring:#e5e7eb; --text:#0b0f10; --muted:#4b5563;
      --acc:#16a34a; --danger:#dc2626; --shadow:0 6px 22px rgba(0,0,0,.12);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    header{padding:16px 20px;border-bottom:1px solid var(--ring)} h1{margin:0;font-size:18px;letter-spacing:.3px}
    main{max-width:900px;margin:0 auto;padding:20px;display:grid;gap:16px;padding-bottom:100px}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:16px}
    .row{display:grid;gap:12px} .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;background:rgba(0,0,0,.2);border:1px solid var(--ring);color:var(--text);border-radius:10px;padding:10px}
    button{background:var(--acc);color:#061316;border:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer;transition:all .2s}
    button:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
    button.ghost{background:rgba(0,0,0,.2);color:var(--text);border:1px solid var(--ring)}
    .pill{font-size:11px;color:var(--muted)} .list{display:grid;gap:10px}
    .item{display:flex;align-items:center;justify-content:space-between;background:rgba(0,0,0,.1);border:1px solid var(--ring);border-radius:10px;padding:10px}
    .muted{color:var(--muted)} .danger{color:var(--danger)} .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    
    /* Footer Bar */
    .footerbar{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(180deg,rgba(0,0,0,0),rgba(0,0,0,.08)),var(--bg);border-top:1px solid var(--ring);padding:10px 16px;display:flex;align-items:center;gap:12px;backdrop-filter:saturate(120%) blur(6px);z-index:100}
    .footerbar .left{display:flex;gap:8px;align-items:center}
    .footerbar .right{margin-left:auto;display:flex;gap:8px}
    
    /* Ad Slot */
    .adslot{display:flex;align-items:center;gap:10px;max-width:340px;min-width:180px;padding:7px 10px;border-radius:12px;border:1px solid var(--ring);background:rgba(0,0,0,.06);cursor:pointer;user-select:none;transition:all .2s}
    .adslot:hover{transform:translateY(-1px);box-shadow:var(--shadow);border-color:var(--acc)}
    .adslot .ad-icon{width:22px;height:22px;border-radius:8px;display:grid;place-items:center;border:1px solid var(--ring);background:rgba(0,0,0,.10);flex:0 0 auto}
    .adslot .ad-text{min-width:0;display:flex;flex-direction:column;gap:2px;line-height:1.1}
    .adslot .ad-title{font-weight:800;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .adslot .ad-sub{font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .adslot .ad-badge{margin-left:auto;flex:0 0 auto;font-size:11px;font-weight:800;padding:4px 8px;border-radius:999px;background:rgba(45,212,191,.15);color:var(--acc)}
    @media (max-width:760px){.adslot{display:none}}
  </style>
</head>
<body>
<header>
  <div class="inline" style="justify-content:space-between;align-items:center">
    <h1>Emerald Crossposter <span class="pill">v0.3</span></h1>
    <select id="language" style="width:auto;padding:6px 10px;border-radius:8px" title="Sprache / Language">
      <option value="de">üá©üá™ Deutsch</option>
      <option value="en">üá¨üáß English</option>
      <option value="fr">üá´üá∑ Fran√ßais</option>
    </select>
  </div>
</header>
<main>
  <section class="card">
    <div class="row">
      <div class="grid-2">
        <div><label>Mandant</label><select id="tenant"></select></div>
        <div><label>Aktiv</label><select id="active"><option value="true" selected>Ja</option><option value="false">Nein</option></select></div>
      </div>
      <div class="grid-2">
        <div><label>Quell‚ÄëChat ID</label><input id="source_chat_id" type="text" placeholder="-100‚Ä¶"/></div>
        <div><label>Ziele (TG Chat IDs / x / Discord‚ÄëWebhook‚ÄëURL, Kommagetrennt)</label><input id="destinations" type="text" placeholder="-1001111, x, https://discord.com/api/webhooks/‚Ä¶/‚Ä¶"/></div>
      </div>
      <div class="grid-2">
        <div><label>Prefix</label><input id="prefix" type="text" placeholder="[News] "/></div>
        <div><label>Suffix</label><input id="suffix" type="text" placeholder="\n#emerald"/></div>
      </div>
      <div class="inline"><input id="plain_text" type="checkbox"/> <label for="plain_text">Plain‚ÄëText (Markdown entfernen)</label></div>
      <div class="grid-2">
        <div><label>Hashtag‚ÄëWhitelist</label><input id="wl" type="text" placeholder="news,update"/></div>
        <div><label>Hashtag‚ÄëBlacklist</label><input id="bl" type="text" placeholder="internal"/></div>
      </div>
      <div class="inline">
        <button id="btn_preview" class="ghost">Vorschau</button>
        <button id="btn_save">Speichern</button>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <div class="inline" style="justify-content:space-between">
        <strong>üíé EMRD Rewards</strong>
        <button id="btn_rewards_info" class="ghost" style="padding:4px 8px;font-size:12px">Info</button>
      </div>
      <div id="rewards_info" class="muted" style="font-size:12px;margin:8px 0">üíé Verdiene EMRD-Punkte f√ºr jede Route!</div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <div class="inline" style="justify-content:space-between">
        <strong>Deine Routen</strong>
        <button id="btn_reload" class="ghost">Neu laden</button>
      </div>
      <div id="routes" class="list"></div>
      <div id="route_detail" class="card" style="display:none;margin-top:16px;border-color:var(--acc)">
        <div class="row">
          <button id="btn_close_detail" class="ghost">√ó Schlie√üen</button>
          <div><label>Route #<span id="detail_id">-</span></label></div>
          <div class="grid-2">
            <div><label>Quelle Chat ID</label><input id="detail_source" type="text" readonly/></div>
            <div><label>Aktiv</label><select id="detail_active"><option value="true">Ja</option><option value="false">Nein</option></select></div>
          </div>
          <div><label>Ziele</label><textarea id="detail_dests" rows="3" readonly></textarea></div>
          <div class="grid-2">
            <div><label>Prefix</label><input id="detail_prefix" type="text"/></div>
            <div><label>Suffix</label><input id="detail_suffix" type="text"/></div>
          </div>
          <div><label>Hashtag-Whitelist</label><input id="detail_wl" type="text"/></div>
          <div><label>Hashtag-Blacklist</label><input id="detail_bl" type="text"/></div>
          <div class="inline">
            <button id="btn_detail_save" style="background:var(--acc);color:#000">Aktualisieren</button>
            <button id="btn_detail_delete" style="background:var(--danger);color:#fff">L√∂schen</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <strong>Activity Log (letzte 50)</strong>
      <div class="grid-2">
        <div><label>Filter Status</label><select id="log_filter"><option value="">Alle</option><option value="sent">Sent</option><option value="error">Error</option></select></div>
        <button id="btn_logs_reload" class="ghost">Neu laden</button>
      </div>
      <div id="logs_list" class="list" style="max-height:300px;overflow-y:auto"></div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <strong>Connectoren</strong>
      <div class="grid-2">
        <div><label>X Access Token (OAuth2 User, Scope: tweet.write)</label><input id="x_token" type="password" placeholder="eyJhbGciOi..."/></div>
        <div class="inline" style="align-items:flex-end">
          <button id="btn_save_connector">Speichern</button>
          <button id="btn_reload_connectors" class="ghost">Neu laden</button>
        </div>
      </div>
      <div id="connectors_list" class="list"></div>
    </div>
  </section>

  <section class="card"><div class="row"><strong>üìä Statistik</strong><pre id="stats" class="muted">‚Äì</pre></div></section>

  <section class="card">
    <div class="row">
      <strong>Test-Nachricht senden</strong>
      <div><label>Route ID</label><input id="test_route_id" type="number" placeholder="z.B. 1"/></div>
      <div><label>Test-Text</label><textarea id="test_text" rows="3" placeholder="Dies ist ein Test #news"></textarea></div>
      <button id="btn_test_send" style="background:#ff8c00">Senden</button>
      <pre id="test_result" class="muted" style="display:none"></pre>
    </div>
  </section>
</main>

<!-- Footer Bar mit Ad Slot -->
<div class="footerbar">
  <div class="left">
    <button class="ghost" id="backBtn" style="padding:6px 10px;font-size:12px">‚Üê Zur√ºck</button>
    <div id="status" class="muted" style="font-size:12px">Bereit</div>
  </div>

  <!-- Werbebanner -->
  <div id="adSlot" class="adslot" title="Werbung" role="button" tabindex="0">
    <div class="ad-icon">üü¢</div>
    <div class="ad-text">
      <div class="ad-title">Kampagnen laden‚Ä¶</div>
      <div class="ad-sub">‚Äî</div>
    </div>
    <div class="ad-badge">AD</div>
  </div>

  <div class="right">
    <button class="ghost" id="themeBtn" style="padding:6px 10px;font-size:12px" title="Design umschalten">üåì</button>
    <button class="ghost" id="resetBtn" style="padding:6px 10px;font-size:12px">Reset</button>
    <button class="ghost" id="closeBtn" style="padding:6px 10px;font-size:12px">Schlie√üen</button>
  </div>
</div>

<script>
  const tg = window.Telegram?.WebApp; tg?.ready();
  const API_BASE = "/miniapi";
  
  // Multilanguage
  let CURRENT_LANG = localStorage.getItem('crossposter_lang') || 'de';
  const STRINGS = {
    de: {
      back: '‚Üê Zur√ºck', ready: 'Bereit', close: 'Schlie√üen',
      tenant: 'Mandant', active: 'Aktiv', source: 'Quell-Chat ID',
      destinations: 'Ziele (TG Chat IDs / x / Discord-Webhook-URL, Kommagetrennt)',
      prefix: 'Prefix', suffix: 'Suffix', preview: 'Vorschau', save: 'Speichern',
      plain_text: 'Plain-Text (Markdown entfernen)', whitelist: 'Hashtag-Whitelist',
      blacklist: 'Hashtag-Blacklist', no_routes: 'Keine Routen gefunden',
      your_routes: 'Deine Routen', load: 'Neu laden', edit: 'Bearbeiten',
      update: 'Aktualisieren', delete: 'L√∂schen', close_detail: '√ó Schlie√üen',
      activity_log: 'Activity Log', filter: 'Filter Status', all: 'Alle',
      connectors: 'Connectoren', x_token: 'X Access Token', stats: 'Statistik',
      test_send: 'Test-Nachricht senden', route_id: 'Route ID', test_text: 'Test-Text',
      send: 'Senden', success: '‚úÖ Route gespeichert', error: '‚ùå Fehler',
      rewards: 'üíé EMRD Rewards', rewards_info: 'üíé Verdiene EMRD-Punkte f√ºr jede Route!',
      loading: '‚è≥ L√§dt‚Ä¶',
    },
    en: {
      back: '‚Üê Back', ready: 'Ready', close: 'Close',
      tenant: 'Tenant', active: 'Active', source: 'Source Chat ID',
      destinations: 'Destinations (TG Chat IDs / x / Discord-Webhook-URL, comma-separated)',
      prefix: 'Prefix', suffix: 'Suffix', preview: 'Preview', save: 'Save',
      plain_text: 'Plain-Text (remove Markdown)', whitelist: 'Hashtag Whitelist',
      blacklist: 'Hashtag Blacklist', no_routes: 'No routes found',
      your_routes: 'Your Routes', load: 'Reload', edit: 'Edit',
      update: 'Update', delete: 'Delete', close_detail: '√ó Close',
      activity_log: 'Activity Log', filter: 'Filter Status', all: 'All',
      connectors: 'Connectors', x_token: 'X Access Token', stats: 'Statistics',
      test_send: 'Send Test Message', route_id: 'Route ID', test_text: 'Test Text',
      send: 'Send', success: '‚úÖ Route saved', error: '‚ùå Error',
      rewards: 'üíé EMRD Rewards', rewards_info: 'üíé Earn EMRD points for every route!',
      loading: '‚è≥ Loading‚Ä¶',
    },
    fr: {
      back: '‚Üê Retour', ready: 'Pr√™t', close: 'Fermer',
      tenant: 'Locataire', active: 'Actif', source: 'ID de chat source',
      destinations: 'Destinations (IDs de chat TG / x / URL de webhook Discord, s√©par√©es par des virgules)',
      prefix: 'Pr√©fixe', suffix: 'Suffixe', preview: 'Aper√ßu', save: 'Enregistrer',
      plain_text: 'Texte brut (supprimer le Markdown)', whitelist: 'Liste blanche des hashtags',
      blacklist: 'Liste noire des hashtags', no_routes: 'Aucun itin√©raire trouv√©',
      your_routes: 'Vos itin√©raires', load: 'Actualiser', edit: 'Modifier',
      update: 'Mettre √† jour', delete: 'Supprimer', close_detail: '√ó Fermer',
      activity_log: 'Journal d\'activit√©', filter: 'Statut du filtre', all: 'Tous',
      connectors: 'Connecteurs', x_token: 'Jeton d\'acc√®s X', stats: 'Statistiques',
      test_send: 'Envoyer un message de test', route_id: 'ID de la route', test_text: 'Texte de test',
      send: 'Envoyer', success: '‚úÖ Route enregistr√©e', error: '‚ùå Erreur',
      rewards: 'üíé R√©compenses EMRD', rewards_info: 'üíé Gagnez des points EMRD pour chaque itin√©raire!',
      loading: '‚è≥ Chargement‚Ä¶',
    }
  };

  function getStr(key) { return (STRINGS[CURRENT_LANG] || STRINGS.de)[key] || key; }
  function setLanguage(lang) {
    CURRENT_LANG = lang;
    localStorage.setItem('crossposter_lang', lang);
    document.documentElement.lang = lang;
    
    // Update backend
    fetch(API_BASE + '/language/set', {
      method: 'POST',
      headers: {...initHeaders()},
      body: JSON.stringify({language: lang})
    }).catch(e => console.warn('[I18N] Backend update failed:', e));
  }

  // AD Campaigns
  let AD_CAMPAIGNS = [];
  let AD_INDEX = 0;
  let AD_TIMER = null;

  function renderAd(idx){
    const slot = document.getElementById('adSlot');
    if(!slot) return;
    const ad = (AD_CAMPAIGNS || [])[idx];
    if(!ad){
      slot.querySelector('.ad-icon').textContent = 'üü¢';
      slot.querySelector('.ad-title').textContent = getStr('loading');
      slot.querySelector('.ad-sub').textContent = '‚Äî';
      slot.querySelector('.ad-badge').textContent = 'AD';
      slot.dataset.url = '';
      return;
    }
    slot.querySelector('.ad-icon').textContent = ad.icon || 'üü¢';
    slot.querySelector('.ad-title').textContent = ad.title || 'Werbung';
    slot.querySelector('.ad-sub').textContent = ad.subtitle || '';
    slot.querySelector('.ad-badge').textContent = ad.badge || 'AD';
    slot.dataset.url = ad.url || '';
  }

  function startAdRotation(){
    if(AD_TIMER) clearInterval(AD_TIMER);
    if(!AD_CAMPAIGNS?.length) return;
    AD_INDEX = 0;
    renderAd(AD_INDEX);
    AD_TIMER = setInterval(()=>{
      if(!AD_CAMPAIGNS?.length) return;
      AD_INDEX = (AD_INDEX + 1) % AD_CAMPAIGNS.length;
      renderAd(AD_INDEX);
    }, 8000);
  }

  function openAd(){
    const url = document.getElementById('adSlot')?.dataset?.url;
    if(!url) return;
    try{
      if(/^https?:\/\/(t\.me|telegram\.me)\//i.test(url) && tg?.openTelegramLink) return tg.openTelegramLink(url);
      if(tg?.openLink) return tg.openLink(url);
      window.open(url, '_blank');
    }catch(e){
      try{ window.open(url, '_blank'); }catch{}
    }
  }

  document.getElementById('adSlot').addEventListener('click', openAd);
  document.getElementById('language').addEventListener('change', (e) => setLanguage(e.target.value));
  document.getElementById('language').value = CURRENT_LANG;

  function initHeaders(){
    const initData = tg?.initData || '';
    return { 'Content-Type':'application/json', 'X-Telegram-Init-Data': initData };
  }
  function parseCSV(v){ return (v||'').split(',').map(s=>s.trim()).filter(Boolean) }
  async function api(path, opts={}){
    const res = await fetch(API_BASE + path, { ...opts, headers: { ...(opts.headers||{}), ...initHeaders() } });
    if(!res.ok){ throw new Error((await res.text()) || res.statusText); }
    return res.json();
  }

  const $tenant = document.getElementById('tenant');
  const $act = document.getElementById('active');
  const $src = document.getElementById('source_chat_id');
  const $dst = document.getElementById('destinations');
  const $pre = document.getElementById('prefix');
  const $suf = document.getElementById('suffix');
  const $pt  = document.getElementById('plain_text');
  const $wl  = document.getElementById('wl');
  const $bl  = document.getElementById('bl');
  const $routes = document.getElementById('routes');
  const $stats  = document.getElementById('stats');
  const $xToken = document.getElementById('x_token');
  const $conList= document.getElementById('connectors_list');
  const $status = document.getElementById('status');

  // Route Detail View
  const $detail = document.getElementById('route_detail');
  const $detailId = document.getElementById('detail_id');
  const $detailSrc = document.getElementById('detail_source');
  const $detailDsts = document.getElementById('detail_dests');
  const $detailActive = document.getElementById('detail_active');
  const $detailPrefix = document.getElementById('detail_prefix');
  const $detailSuffix = document.getElementById('detail_suffix');
  const $detailWl = document.getElementById('detail_wl');
  const $detailBl = document.getElementById('detail_bl');

  // Logs
  const $logsList = document.getElementById('logs_list');
  const $logFilter = document.getElementById('log_filter');
  let currentRoute = null;

  // Rewards Info
  document.getElementById('btn_rewards_info').addEventListener('click', async ()=>{
    try{
      const data = await api('/rewards/info');
      alert(data.message || 'üíé Rewards aktiviert!');
    }catch(e){
      console.error('Rewards info error:', e);
    }
  });

  document.getElementById('btn_preview').addEventListener('click', ()=>{
    const sample = 'Beispieltext f√ºr Crossposting. #news #update';
    const txt = ($pre.value||'') + sample + ($suf.value||'');
    alert('Vorschau (Text):\n\n' + txt);
  });

  document.getElementById('btn_save').addEventListener('click', async ()=>{
    try{
      const tid = Number($tenant.value);
      if(!tid){ alert('Bitte Mandant ausw√§hlen.'); return; }
      const dests = parseCSV($dst.value).map(v=>{
        if (v.toLowerCase() === 'x') return { type: 'x' };
        if (v.startsWith('http') && v.includes('discord.com/api/webhooks')) return { type: 'discord', webhook_url: v };
        const n = Number(v);
        if (!Number.isNaN(n)) return { type: 'telegram', chat_id: n };
        return null;
      }).filter(Boolean);
      const payload = {
        tenant_id: tid,
        source_chat_id: Number($src.value),
        destinations: dests,
        transform: { prefix: $pre.value||'', suffix:$suf.value||'', plain_text: $pt.checked },
        filters: { hashtags_whitelist: parseCSV($wl.value), hashtags_blacklist: parseCSV($bl.value) },
        active: $act.value === 'true'
      };
      await api('/routes', { method:'POST', body: JSON.stringify(payload) });
      
      // Claim rewards
      try{
        await api('/rewards/claim', { method:'POST', body: JSON.stringify({tenant_id: tid}) });
      }catch(e){ console.warn('Rewards claim failed:', e); }
      
      await loadRoutes();
      $status.textContent = getStr('success');
      setTimeout(() => { $status.textContent = getStr('ready'); }, 3000);
    }catch(e){ 
      $status.textContent = getStr('error');
      alert(String(e).slice(0,400)); 
    }
  });

  document.getElementById('btn_reload').addEventListener('click', loadRoutes);

  document.getElementById('btn_save_connector').addEventListener('click', async ()=>{
    try{
      const tid = Number($tenant.value);
      if(!tid){ alert('Bitte Mandant w√§hlen.'); return; }
      const payload = { tenant_id: tid, type: 'x', label: 'default', config: { access_token: $xToken.value }, active: true };
      await api('/connectors', { method:'POST', body: JSON.stringify(payload) });
      await loadConnectors(); 
      $status.textContent = '‚úÖ Connector gespeichert';
      setTimeout(() => { $status.textContent = getStr('ready'); }, 3000);
    }catch(e){ alert(String(e).slice(0,400)); }
  });
  document.getElementById('btn_reload_connectors').addEventListener('click', loadConnectors);

  document.getElementById('btn_close_detail').addEventListener('click', ()=>{ $detail.style.display='none'; currentRoute=null; });

  document.getElementById('btn_detail_save').addEventListener('click', async ()=>{
    try{
      if(!currentRoute) return;
      const tid = Number($tenant.value);
      const rid = Number($detailId.textContent);
      const dests = parseCSV($detailDsts.value).map(v=>{
        if (v.toLowerCase() === 'x') return { type: 'x' };
        if (v.startsWith('http') && v.includes('discord.com/api/webhooks')) return { type: 'discord', webhook_url: v };
        const n = Number(v);
        if (!Number.isNaN(n)) return { type: 'telegram', chat_id: n };
        return null;
      }).filter(Boolean);
      const payload = {
        tenant_id: tid,
        source_chat_id: Number($detailSrc.value),
        destinations: dests,
        transform: { prefix: $detailPrefix.value||'', suffix:$detailSuffix.value||'', plain_text: $pt.checked },
        filters: { hashtags_whitelist: parseCSV($detailWl.value), hashtags_blacklist: parseCSV($detailBl.value) },
        active: $detailActive.value === 'true'
      };
      await api(`/routes/${rid}`, { method:'PATCH', body: JSON.stringify(payload) });
      await loadRoutes(); 
      $status.textContent = '‚úÖ Route aktualisiert';
      $detail.style.display='none'; currentRoute=null;
      setTimeout(() => { $status.textContent = getStr('ready'); }, 3000);
    }catch(e){ alert(String(e).slice(0,400)); }
  });

  document.getElementById('btn_detail_delete').addEventListener('click', async ()=>{
    try{
      if(!currentRoute || !confirm('Wirklich l√∂schen?')) return;
      const tid = Number($tenant.value);
      const rid = Number($detailId.textContent);
      await api(`/routes/${rid}?tenant_id=${tid}`, { method:'DELETE' });
      await loadRoutes(); 
      $status.textContent = '‚úÖ Route gel√∂scht';
      $detail.style.display='none'; currentRoute=null;
      setTimeout(() => { $status.textContent = getStr('ready'); }, 3000);
    }catch(e){ alert(String(e).slice(0,400)); }
  });

  document.getElementById('btn_logs_reload').addEventListener('click', loadLogs);
  document.getElementById('log_filter').addEventListener('change', loadLogs);

  document.getElementById('btn_test_send').addEventListener('click', async ()=>{
    try{
      const tid = Number($tenant.value);
      const rid = Number(document.getElementById('test_route_id').value);
      const txt = document.getElementById('test_text').value;
      if(!rid || !txt) { alert('Route ID und Text erforderlich'); return; }
      const $res = document.getElementById('test_result');
      $res.textContent = getStr('loading');
      $res.style.display='block';
      const res = await api('/test-send', { method:'POST', body: JSON.stringify({tenant_id:tid, route_id:rid, text:txt}) });
      $res.textContent = JSON.stringify(res, null, 2);
    }catch(e){ document.getElementById('test_result').textContent = 'Fehler: ' + String(e); document.getElementById('test_result').style.display='block'; }
  });

  document.getElementById('themeBtn')?.addEventListener('click', ()=>{
    const theme = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('crossposter_theme', theme);
  });

  document.getElementById('backBtn')?.addEventListener('click', ()=>{
    if(tg?.close) tg.close();
  });
  
  document.getElementById('closeBtn')?.addEventListener('click', ()=>{
    if(tg?.close) tg.close();
  });

  async function loadTenants(){
    $tenant.innerHTML = '<option>'+getStr('loading')+'</option>';
    try{
      const list = await api('/tenants');
      $tenant.innerHTML = '';
      list.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = `${t.name} (#${t.id})`;
        $tenant.appendChild(opt);
      });
    }catch(e){
      $tenant.innerHTML = '<option>'+getStr('error')+'</option>';
      console.error('loadTenants error:', e);
    }
  }

  async function loadRoutes(){
    const tid = $tenant.value;
    if(!tid){ $routes.innerHTML = '<span class="muted">Bitte Mandant w√§hlen.</span>'; return; }
    $routes.innerHTML = '<span class="muted">'+getStr('loading')+'</span>';
    try{
      const list = await api('/routes?tenant_id=' + encodeURIComponent(tid));
      if(!list.length){ $routes.innerHTML = '<span class="muted">'+getStr('no_routes')+'</span>'; }
      else {
        $routes.innerHTML = '';
        list.forEach(r => {
          const div = document.createElement('div');
          div.className = 'item';
          const dests = r.destinations.map(d=>{
            if (d.type==='telegram') return `TG:${d.chat_id}`;
            if (d.type==='x') return 'X';
            if (d.type==='discord') return 'Discord';
            return d.type;
          }).join(', ');
          div.innerHTML = `<div style="flex:1"><div><strong>#${r.id}</strong> ‚Äì Quelle: <code>${r.source_chat_id}</code></div><div class="muted" style="font-size:11px">Ziele: ${dests} ¬∑ ${r.active ? '‚úÖ' : '‚ùå'}</div></div><button class="ghost" style="padding:4px 8px;font-size:12px">Bearbeiten</button>`;
          div.querySelector('button').addEventListener('click', () => showRouteDetail(r));
          $routes.appendChild(div);
        });
      }
      try{
        const s = await api('/stats?tenant_id=' + encodeURIComponent(tid));
        $stats.textContent = JSON.stringify(s, null, 2);
      }catch(e){ $stats.textContent = '‚Äì'; }
    }catch(e){
      $routes.innerHTML = '<span class="muted">'+getStr('error')+'</span>';
      console.error('loadRoutes error:', e);
    }
  }

  async function showRouteDetail(r){
    currentRoute = r;
    $detailId.textContent = r.id;
    $detailSrc.value = r.source_chat_id;
    $detailActive.value = r.active ? 'true' : 'false';
    $detailDsts.value = r.destinations.map(d=>{
      if(d.type==='telegram') return d.chat_id;
      if(d.type==='x') return 'x';
      if(d.type==='discord') return d.webhook_url;
      return '';
    }).join(', ');
    $detailPrefix.value = r.transform?.prefix || '';
    $detailSuffix.value = r.transform?.suffix || '';
    $detailWl.value = (r.filters?.hashtags_whitelist || []).join(',');
    $detailBl.value = (r.filters?.hashtags_blacklist || []).join(',');
    $detail.style.display='block';
    await loadLogs();
  }

  async function loadLogs(){
    const tid = $tenant.value;
    const rid = currentRoute?.id;
    if(!tid || !rid){ $logsList.innerHTML = '<span class="muted">Keine Logs.</span>'; return; }
    const filter = $logFilter.value || '';
    try{
      const logs = await api(`/logs?tenant_id=${tid}&route_id=${rid}&status=${filter}&limit=50`);
      if(!logs.length){ $logsList.innerHTML = '<span class="muted">Keine Logs.</span>'; return; }
      $logsList.innerHTML = '';
      logs.forEach(l => {
        const div = document.createElement('div');
        div.className = 'item';
        const color = l.status === 'sent' ? '#2dd4bf' : '#ef4444';
        div.innerHTML = `<div><div style="color:${color};font-weight:600;font-size:12px">${l.status}</div><div class="muted" style="font-size:11px">${new Date(l.created_at).toLocaleString()} ‚Äì ${l.dest_descriptor}</div>${l.error ? '<div style="color:#ef4444;font-size:11px">'+l.error+'</div>' : ''}</div>`;
        $logsList.appendChild(div);
      });
    }catch(e){ $logsList.innerHTML = '<span class="muted">Fehler beim Laden.</span>'; }
  }

  async function loadConnectors(){
    const tid = $tenant.value;
    if(!tid){ $conList.innerHTML = '<span class="muted">Bitte Mandant w√§hlen.</span>'; return; }
    try{
      const list = await api('/connectors?tenant_id=' + encodeURIComponent(tid));
      if(!list.length){ $conList.innerHTML = '<span class="muted">Keine Connectoren.</span>'; return; }
      $conList.innerHTML = '';
      list.forEach(c => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<div><strong>${c.type}</strong> ‚Äì ${c.label||''} ¬∑ ${c.active ? '‚úÖ':'‚ùå'}</div>`;
        $conList.appendChild(div);
      });
    }catch(e){ $conList.innerHTML = '<span class="muted">Fehler.</span>'; }
  }

  async function loadAdCampaigns(){
    try{
      const res = await api('/ads?cid=0');
      if(res.ok && Array.isArray(res.ads)){
        AD_CAMPAIGNS = res.ads;
      }
    }catch(e){
      console.warn('[ADS] load failed:', e);
    }
    startAdRotation();
  }

  (async function init(){
    try { tg?.ready?.(); tg?.expand?.(); }catch(e){}
    
    // Load theme from localStorage
    const savedTheme = localStorage.getItem('crossposter_theme');
    if(savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);
    
    await loadTenants();
    await loadRoutes();
    await loadConnectors();
    await loadAdCampaigns();
    $status.textContent = getStr('ready');
  })();
</script>
</body>
</html>

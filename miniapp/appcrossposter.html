
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Emerald Crossposter</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{--bg:#0b0f10;--card:#11181c;--fg:#e6f1ff;--muted:#9fb3c8;--acc:#2dd4bf;--red:#ef4444}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg)}
    header{padding:16px 20px;border-bottom:1px solid #1f2a2e} h1{margin:0;font-size:18px;letter-spacing:.3px}
    main{max-width:900px;margin:0 auto;padding:20px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid #1f2a2e;border-radius:14px;padding:16px}
    .row{display:grid;gap:12px} .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;background:#0d1418;border:1px solid #223038;color:var(--fg);border-radius:10px;padding:10px}
    button{background:var(--acc);color:#061316;border:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    button.ghost{background:#0d1418;color:var(--fg);border:1px solid #223038}
    .pill{font-size:11px;color:var(--muted)} .list{display:grid;gap:10px}
    .item{display:flex;align-items:center;justify-content:space-between;background:#0d1418;border:1px solid #223038;border-radius:10px;padding:10px}
    .muted{color:var(--muted)} .danger{color:var(--red)} .inline{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
<header><h1>Emerald Crossposter <span class="pill">v0.3</span></h1></header>
<main>
  <section class="card">
    <div class="row">
      <div class="grid-2">
        <div><label>Mandant</label><select id="tenant"></select></div>
        <div><label>Aktiv</label><select id="active"><option value="true" selected>Ja</option><option value="false">Nein</option></select></div>
      </div>
      <div class="grid-2">
        <div><label>Quell‑Chat ID</label><input id="source_chat_id" type="text" placeholder="-100…"/></div>
        <div><label>Ziele (TG Chat IDs / x / Discord‑Webhook‑URL, Kommagetrennt)</label><input id="destinations" type="text" placeholder="-1001111, x, https://discord.com/api/webhooks/…/…"/></div>
      </div>
      <div class="grid-2">
        <div><label>Prefix</label><input id="prefix" type="text" placeholder="[News] "/></div>
        <div><label>Suffix</label><input id="suffix" type="text" placeholder="\n#emerald"/></div>
      </div>
      <div class="inline"><input id="plain_text" type="checkbox"/> <label for="plain_text">Plain‑Text (Markdown entfernen)</label></div>
      <div class="grid-2">
        <div><label>Hashtag‑Whitelist</label><input id="wl" type="text" placeholder="news,update"/></div>
        <div><label>Hashtag‑Blacklist</label><input id="bl" type="text" placeholder="internal"/></div>
      </div>
      <div class="inline">
        <button id="btn_preview" class="ghost">Vorschau</button>
        <button id="btn_save">Speichern</button>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <div class="inline" style="justify-content:space-between">
        <strong>Deine Routen</strong>
        <button id="btn_reload" class="ghost">Neu laden</button>
      </div>
      <div id="routes" class="list"></div>
      <div id="route_detail" class="card" style="display:none;margin-top:16px;border-color:#2dd4bf">
        <div class="row">
          <button id="btn_close_detail" class="ghost">× Schließen</button>
          <div><label>Route #<span id="detail_id">-</span></label></div>
          <div class="grid-2">
            <div><label>Quelle Chat ID</label><input id="detail_source" type="text" readonly/></div>
            <div><label>Aktiv</label><select id="detail_active"><option value="true">Ja</option><option value="false">Nein</option></select></div>
          </div>
          <div><label>Ziele</label><textarea id="detail_dests" rows="3" readonly></textarea></div>
          <div class="grid-2">
            <div><label>Prefix</label><input id="detail_prefix" type="text"/></div>
            <div><label>Suffix</label><input id="detail_suffix" type="text"/></div>
          </div>
          <div><label>Hashtag-Whitelist</label><input id="detail_wl" type="text"/></div>
          <div><label>Hashtag-Blacklist</label><input id="detail_bl" type="text"/></div>
          <div class="inline">
            <button id="btn_detail_save" style="background:#2dd4bf;color:#000">Aktualisieren</button>
            <button id="btn_detail_delete" style="background:#ef4444;color:#fff">Löschen</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <strong>Activity Log (letzte 50)</strong>
      <div class="grid-2">
        <div><label>Filter Status</label><select id="log_filter"><option value="">Alle</option><option value="sent">Sent</option><option value="error">Error</option></select></div>
        <button id="btn_logs_reload" class="ghost">Neu laden</button>
      </div>
      <div id="logs_list" class="list" style="max-height:300px;overflow-y:auto"></div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <strong>Connectoren</strong>
      <div class="grid-2">
        <div><label>X Access Token (OAuth2 User, Scope: tweet.write)</label><input id="x_token" type="password" placeholder="eyJhbGciOi..."/></div>
        <div class="inline" style="align-items:flex-end">
          <button id="btn_save_connector">Speichern</button>
          <button id="btn_reload_connectors" class="ghost">Neu laden</button>
        </div>
      </div>
      <div id="connectors_list" class="list"></div>
    </div>
  </section>

  <section class="card"><div class="row"><strong>Statistik</strong><pre id="stats" class="muted">–</pre></div></section>

  <section class="card">
    <div class="row">
      <strong>Test-Nachricht senden</strong>
      <div><label>Route ID</label><input id="test_route_id" type="number" placeholder="z.B. 1"/></div>
      <div><label>Test-Text</label><textarea id="test_text" rows="3" placeholder="Dies ist ein Test #news"></textarea></div>
      <button id="btn_test_send" style="background:#ff8c00">Senden</button>
      <pre id="test_result" class="muted" style="display:none"></pre>
    </div>
  </section>
</main>

<script>
  const tg = window.Telegram?.WebApp; tg?.ready();
  const API_BASE = "/miniapi";

  function initHeaders(){
    const initData = tg?.initData || '';
    return { 'Content-Type':'application/json', 'X-Telegram-Init-Data': initData };
  }
  function parseCSV(v){ return (v||'').split(',').map(s=>s.trim()).filter(Boolean) }
  async function api(path, opts={}){
    const res = await fetch(API_BASE + path, { ...opts, headers: { ...(opts.headers||{}), ...initHeaders() } });
    if(!res.ok){ throw new Error((await res.text()) || res.statusText); }
    return res.json();
  }

  const $tenant = document.getElementById('tenant');
  const $act = document.getElementById('active');
  const $src = document.getElementById('source_chat_id');
  const $dst = document.getElementById('destinations');
  const $pre = document.getElementById('prefix');
  const $suf = document.getElementById('suffix');
  const $pt  = document.getElementById('plain_text');
  const $wl  = document.getElementById('wl');
  const $bl  = document.getElementById('bl');
  const $routes = document.getElementById('routes');
  const $stats  = document.getElementById('stats');
  const $xToken = document.getElementById('x_token');
  const $conList= document.getElementById('connectors_list');

  // Route Detail View
  const $detail = document.getElementById('route_detail');
  const $detailId = document.getElementById('detail_id');
  const $detailSrc = document.getElementById('detail_source');
  const $detailDsts = document.getElementById('detail_dests');
  const $detailActive = document.getElementById('detail_active');
  const $detailPrefix = document.getElementById('detail_prefix');
  const $detailSuffix = document.getElementById('detail_suffix');
  const $detailWl = document.getElementById('detail_wl');
  const $detailBl = document.getElementById('detail_bl');

  // Logs
  const $logsList = document.getElementById('logs_list');
  const $logFilter = document.getElementById('log_filter');
  let currentRoute = null;

  document.getElementById('btn_preview').addEventListener('click', ()=>{
    const sample = 'Beispieltext für Crossposting. #news #update';
    const txt = ($pre.value||'') + sample + ($suf.value||'');
    alert('Vorschau (Text):\n\n' + txt);
  });

  document.getElementById('btn_save').addEventListener('click', async ()=>{
    try{
      const tid = Number($tenant.value);
      if(!tid){ alert('Bitte Mandant auswählen.'); return; }
      const dests = parseCSV($dst.value).map(v=>{
        if (v.toLowerCase() === 'x') return { type: 'x' };
        if (v.startsWith('http') && v.includes('discord.com/api/webhooks')) return { type: 'discord', webhook_url: v };
        const n = Number(v);
        if (!Number.isNaN(n)) return { type: 'telegram', chat_id: n };
        return null;
      }).filter(Boolean);
      const payload = {
        tenant_id: tid,
        source_chat_id: Number($src.value),
        destinations: dests,
        transform: { prefix: $pre.value||'', suffix:$suf.value||'', plain_text: $pt.checked },
        filters: { hashtags_whitelist: parseCSV($wl.value), hashtags_blacklist: parseCSV($bl.value) },
        active: $act.value === 'true'
      };
      await api('/routes', { method:'POST', body: JSON.stringify(payload) });
      await loadRoutes(); alert('Route gespeichert.');
    }catch(e){ alert(String(e).slice(0,400)); }
  });

  document.getElementById('btn_reload').addEventListener('click', loadRoutes);

  document.getElementById('btn_save_connector').addEventListener('click', async ()=>{
    try{
      const tid = Number($tenant.value);
      if(!tid){ alert('Bitte Mandant wählen.'); return; }
      const payload = { tenant_id: tid, type: 'x', label: 'default', config: { access_token: $xToken.value }, active: true };
      await api('/connectors', { method:'POST', body: JSON.stringify(payload) });
      await loadConnectors(); alert('X-Connector gespeichert.');
    }catch(e){ alert(String(e).slice(0,400)); }
  });
  document.getElementById('btn_reload_connectors').addEventListener('click', loadConnectors);

  document.getElementById('btn_close_detail').addEventListener('click', ()=>{ $detail.style.display='none'; currentRoute=null; });

  document.getElementById('btn_detail_save').addEventListener('click', async ()=>{
    try{
      if(!currentRoute) return;
      const tid = Number($tenant.value);
      const rid = Number($detailId.textContent);
      const dests = parseCSV($detailDsts.value).map(v=>{
        if (v.toLowerCase() === 'x') return { type: 'x' };
        if (v.startsWith('http') && v.includes('discord.com/api/webhooks')) return { type: 'discord', webhook_url: v };
        const n = Number(v);
        if (!Number.isNaN(n)) return { type: 'telegram', chat_id: n };
        return null;
      }).filter(Boolean);
      const payload = {
        tenant_id: tid,
        source_chat_id: Number($detailSrc.value),
        destinations: dests,
        transform: { prefix: $detailPrefix.value||'', suffix:$detailSuffix.value||'', plain_text: $pt.checked },
        filters: { hashtags_whitelist: parseCSV($detailWl.value), hashtags_blacklist: parseCSV($detailBl.value) },
        active: $detailActive.value === 'true'
      };
      await api(`/routes/${rid}`, { method:'PATCH', body: JSON.stringify(payload) });
      await loadRoutes(); alert('Route aktualisiert.');
      $detail.style.display='none'; currentRoute=null;
    }catch(e){ alert(String(e).slice(0,400)); }
  });

  document.getElementById('btn_detail_delete').addEventListener('click', async ()=>{
    try{
      if(!currentRoute || !confirm('Wirklich löschen?')) return;
      const tid = Number($tenant.value);
      const rid = Number($detailId.textContent);
      await api(`/routes/${rid}?tenant_id=${tid}`, { method:'DELETE' });
      await loadRoutes(); alert('Route gelöscht.');
      $detail.style.display='none'; currentRoute=null;
    }catch(e){ alert(String(e).slice(0,400)); }
  });

  document.getElementById('btn_logs_reload').addEventListener('click', loadLogs);
  document.getElementById('log_filter').addEventListener('change', loadLogs);

  document.getElementById('btn_test_send').addEventListener('click', async ()=>{
    try{
      const tid = Number($tenant.value);
      const rid = Number(document.getElementById('test_route_id').value);
      const txt = document.getElementById('test_text').value;
      if(!rid || !txt) { alert('Route ID und Text erforderlich'); return; }
      const $res = document.getElementById('test_result');
      $res.textContent = 'Sende...';
      $res.style.display='block';
      const res = await api('/test-send', { method:'POST', body: JSON.stringify({tenant_id:tid, route_id:rid, text:txt}) });
      $res.textContent = JSON.stringify(res, null, 2);
    }catch(e){ document.getElementById('test_result').textContent = 'Fehler: ' + String(e); document.getElementById('test_result').style.display='block'; }
  });

  document.getElementById('btn_reload_connectors').addEventListener('click', loadConnectors);

  async function loadTenants(){
    $tenant.innerHTML = '<option>Lade…</option>';
    const list = await api('/tenants'); // auto-provision passiert serverseitig
    $tenant.innerHTML = '';
    list.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.id; opt.textContent = `${t.name} (#${t.id})`;
      $tenant.appendChild(opt);
    });
  }

  async function loadRoutes(){
    const tid = $tenant.value;
    if(!tid){ $routes.innerHTML = '<span class="muted">Bitte Mandant wählen.</span>'; return; }
    $routes.innerHTML = 'Lade…';
    const list = await api('/routes?tenant_id=' + encodeURIComponent(tid));
    if(!list.length){ $routes.innerHTML = '<span class="muted">Keine Routen.</span>'; }
    else {
      $routes.innerHTML = '';
      list.forEach(r => {
        const div = document.createElement('div');
        div.className = 'item';
        const dests = r.destinations.map(d=>{
          if (d.type==='telegram') return `TG:${d.chat_id}`;
          if (d.type==='x') return 'X';
          if (d.type==='discord') return 'Discord Webhook';
          return d.type;
        }).join(', ');
        div.innerHTML = `<div style="flex:1"><div><strong>#${r.id}</strong> – Mandant: <code>${r.tenant_id}</code> · Quelle: <code>${r.source_chat_id}</code></div><div class="muted">Ziele: ${dests} · Aktiv: ${r.active ? 'Ja' : 'Nein'}</div></div><button class="ghost" style="padding:4px 8px;font-size:12px">Bearbeiten</button>`;
        div.querySelector('button').addEventListener('click', () => showRouteDetail(r));
        $routes.appendChild(div);
      });
    }
    try{
      const s = await api('/stats?tenant_id=' + encodeURIComponent(tid));
      $stats.textContent = JSON.stringify(s, null, 2);
    }catch(e){ $stats.textContent = '–'; }
  }

  async function showRouteDetail(r){
    currentRoute = r;
    $detailId.textContent = r.id;
    $detailSrc.value = r.source_chat_id;
    $detailActive.value = r.active ? 'true' : 'false';
    $detailDsts.value = r.destinations.map(d=>{
      if(d.type==='telegram') return d.chat_id;
      if(d.type==='x') return 'x';
      if(d.type==='discord') return d.webhook_url;
      return '';
    }).join(', ');
    $detailPrefix.value = r.transform?.prefix || '';
    $detailSuffix.value = r.transform?.suffix || '';
    $detailWl.value = (r.filters?.hashtags_whitelist || []).join(',');
    $detailBl.value = (r.filters?.hashtags_blacklist || []).join(',');
    $detail.style.display='block';
    await loadLogs();
  }

  async function loadLogs(){
    const tid = $tenant.value;
    const rid = currentRoute?.id;
    if(!tid || !rid){ $logsList.innerHTML = '<span class="muted">Keine Logs.</span>'; return; }
    const filter = $logFilter.value || '';
    try{
      const logs = await api(`/logs?tenant_id=${tid}&route_id=${rid}&status=${filter}&limit=50`);
      if(!logs.length){ $logsList.innerHTML = '<span class="muted">Keine Logs.</span>'; return; }
      $logsList.innerHTML = '';
      logs.forEach(l => {
        const div = document.createElement('div');
        div.className = 'item';
        const color = l.status === 'sent' ? '#2dd4bf' : '#ef4444';
        div.innerHTML = `<div><div style="color:${color};font-weight:600">${l.status}</div><div class="muted" style="font-size:11px">${new Date(l.created_at).toLocaleString()} – ${l.dest_descriptor}</div>${l.error ? '<div style="color:#ef4444;font-size:11px">'+l.error+'</div>' : ''}</div>`;
        $logsList.appendChild(div);
      });
    }catch(e){ $logsList.innerHTML = '<span class="muted">Fehler beim Laden.</span>'; }
  }

  async function loadConnectors(){
    const tid = $tenant.value;
    if(!tid){ $conList.innerHTML = '<span class="muted">Bitte Mandant wählen.</span>'; return; }
    const list = await api('/connectors?tenant_id=' + encodeURIComponent(tid));
    if(!list.length){ $conList.innerHTML = '<span class="muted">Keine Connectoren.</span>'; return; }
    $conList.innerHTML = '';
    list.forEach(c => {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<div><strong>${c.type}</strong> – ${c.label||''} · Aktiv: ${c.active ? 'Ja':'Nein'}</div>`;
      $conList.appendChild(div);
    });
  }

  (async function init(){
    await loadTenants();
    await loadRoutes();
    await loadConnectors();
  })();
</script>
</body>
</html>

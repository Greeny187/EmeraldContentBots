<!doctype html>
function saveLocal(v){ localStorage.setItem(storeKey, JSON.stringify(v)) }


// Fill defaults
(function init(){
const s = load();
const map = {
welcome_on:true, welcome_text:'Willkommen {user} ðŸ‘‹', farewell_on:false, farewell_text:'Schade {user}, bis bald!',
rules_on:false, rules_text:'', clean_deleted:false,
spam_level:'mid', links_admins_only:false, whitelist:'', blacklist:'', topic_id:'',
rss_images:true, rss_add:'', rss_del:'',
ai_faq:true, ai_rss:false,
faq_q:'', faq_a:'',
daily_stats:false,
mood_topic:'', mood_question:'Wie war dein Tag von 1â€“5?',
language:'de', night_on:false, night_start:'22:00', night_end:'07:00', night_days:'',
router_rule:''
};
Object.keys(map).forEach(k=>{ const el=document.getElementById(k); if(!el) return; const v=(k in s)?s[k]:map[k]; if(el.type==='checkbox'){el.checked=!!v}else{el.value=v} });
})();


// FAQ buttons â†’ stash into local only
document.getElementById('faq_add').onclick = ()=>{ const s=load(); s.faq_add= { q:document.getElementById('faq_q').value.trim(), a:document.getElementById('faq_a').value.trim() }; saveLocal(s); alert('FAQ zum Senden vorgemerkt. â€žSpeichernâ€œ drÃ¼cken.'); };
document.getElementById('faq_del').onclick = ()=>{ const s=load(); s.faq_del= { q:document.getElementById('faq_q').value.trim() }; saveLocal(s); alert('FAQâ€‘LÃ¶schung vorgemerkt. â€žSpeichernâ€œ drÃ¼cken.'); };


function collect(){
const get = id=>{ const el=document.getElementById(id); return el? (el.type==='checkbox'? el.checked : el.value.trim()) : undefined };
const payload = {
cid, title,
welcome_on:get('welcome_on'), welcome_text:get('welcome_text'),
farewell_on:get('farewell_on'), farewell_text:get('farewell_text'),
rules_on:get('rules_on'), rules_text:get('rules_text'), clean_deleted:get('clean_deleted'),
spam_level:get('spam_level'), links_admins_only:get('links_admins_only'),
whitelist:get('whitelist'), blacklist:get('blacklist'), topic_id:get('topic_id'),
rss_images:get('rss_images'), rss_add:get('rss_add'), rss_del:get('rss_del'),
ai_faq:get('ai_faq'), ai_rss:get('ai_rss'),
faq_add: load().faq_add || null, faq_del: load().faq_del || null,
daily_stats:get('daily_stats'),
mood_topic:get('mood_topic'), mood_question:get('mood_question'),
language:get('language'),
night: { on:get('night_on'), start:get('night_start'), end:get('night_end'), days:get('night_days') },
router_rule:get('router_rule'),
t:Date.now(), by: user? user.id : null
};
saveLocal(payload);
return payload;
}


async function save(){
const payload = collect();
if(tg){ try{ tg.HapticFeedback.impactOccurred('medium'); tg.sendData(JSON.stringify(payload)); tg.close(); return }catch(e){ console.error(e) } }
alert('Gespeichert (lokal). In Telegram wird an den Bot gesendet.');
}


document.getElementById('saveBtn').onclick = save;
document.getElementById('closeBtn').onclick = ()=> tg? tg.close() : window.close();
document.getElementById('resetBtn').onclick = ()=>{ localStorage.removeItem(storeKey); location.reload() };
</script>
</body>
</html>
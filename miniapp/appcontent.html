<!doctype html>
<html lang="de" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Emerald Content ‚Äì Mini-App</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --ring:#1f2937; --text:#e5e7eb; --muted:#94a3b8;
      --brand:#22c55e; --danger:#ef4444; --yellow:#f59e0b; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    [data-theme="light"]{
      --bg:#f7fafc; --panel:#ffffff; --ring:#e5e7eb; --text:#0b1220; --muted:#4b5563;
      --brand:#16a34a; --danger:#dc2626; --yellow:#d97706; --shadow:0 6px 22px rgba(0,0,0,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Ubuntu,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:16px 16px 80px}
    .titlebar{display:flex;align-items:center;gap:10px;margin:2px 0 12px}
    .title{font-weight:800;font-size:22px;letter-spacing:.2px}
    .group-select{padding: 8px 12px;border-radius: 12px;border: 1px solid var(--ring);background: var(--panel);color: var(--text);font-size: 14px;margin-left: auto;}
    .pillbar{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 14px}
    .pill{border:1px solid var(--ring);background:#0000;color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer}
    .pill.active{background:var(--brand);border-color:var(--brand);color:#08140f;font-weight:700}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width:760px){.grid{grid-template-columns:1fr}}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .card{background:var(--panel);border:1px solid var(--ring);border-radius:16px;padding:14px;box-shadow:var(--shadow); display:none}
    .card.active{display:block}
    label{display:block;font-weight:600;margin:6px 0 6px;color:var(--muted)}
    input[type="text"], input[type="number"], input[type="datetime-local"], textarea, select{width:100%;background:#0000;border:1px solid var(--ring);color:var(--text);border-radius:12px;padding:9px 10px}
    textarea{min-height:92px;resize:vertical}
    .switch{display:inline-flex;align-items:center;gap:6px}
    .switch input{accent-color:var(--brand)}
    .sep{height:1px;background:var(--ring);margin:10px 0}
    .list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .item{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px solid var(--ring);border-radius:12px;padding:8px 10px;background:#00000008}
    .item .left{display:flex;flex-direction:column;gap:4px;min-width:0}
    .item .title{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .hint{font-size:12px;color:var(--muted)}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:rgba(127,127,127,.12);padding:2px 6px;border-radius:6px}
    .subsec{margin-top:10px;padding:10px;border:1px dashed var(--ring);border-radius:12px}
    .imgprev{display:block;max-width:180px;max-height:120px;border:1px solid var(--ring);border-radius:12px;object-fit:cover;background:#00000010;transition:all 0.2s ease}
    .imgprev:hover{transform:scale(1.05);border-color:var(--brand);box-shadow:var(--shadow)}
    .row.gap-6{gap:16px}
    .footerbar{position:sticky;bottom:0;left:0;right:0;background:linear-gradient(180deg,rgba(0,0,0,0),rgba(0,0,0,.08)),var(--bg);border-top:1px solid var(--ring);padding:10px 16px;display:flex;align-items:center;gap:12px;backdrop-filter:saturate(120%) blur(6px)}
    .footerbar .right{margin-left:auto;display:flex;gap:8px}
    .footerbar .left{display:flex;gap:8px}
    .btn{border:1px solid var(--ring);background:transparent;color:var(--text);padding:8px 12px;border-radius:12px;cursor:pointer}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#08140f;font-weight:700}
    .btn.ghost{opacity:.9}
    .btn.small{padding:6px 9px;border-radius:10px}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .input-error{border-color:var(--danger)!important;box-shadow:0 0 0 2px rgba(239,68,68,.2)}
    .err{color:var(--danger);font-size:12px;margin:4px 2px 0}
    #startPage{max-width:600px;margin:20px auto;opacity:1;transition:opacity 0.3s ease}
    .welcome-header{text-align:center;margin-bottom:30px}
    .welcome-header h1{font-size:24px;margin-bottom:10px;color:var(--brand)}
    .welcome-header p{color:var(--muted);margin:0}
    .group-list{margin-top:20px}
    .group-item{display:flex;align-items:center;justify-content:space-between;padding:16px;margin:12px 0;background:var(--panel);border:1px solid var(--ring);border-radius:12px;transition:all 0.2s ease}
    .group-item:hover{border-color:var(--brand);transform:translateY(-1px);box-shadow:var(--shadow)}
    .group-info{flex:1}
    .group-title{font-size:16px;font-weight:500;margin-bottom:4px}
    .group-meta{color:var(--muted);font-size:12px}
    #contentArea{opacity:0;transition:opacity 0.3s ease}
    #contentArea.visible{opacity:1}
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<div id="startPage">
  <div class="welcome-header">
    <h1>Emerald Content Bot</h1>
    <p>Verwalte deine Gruppen-Einstellungen</p>
  </div>
  <div class="card active">
    <div id="groupList" class="group-list">
      <p class="hint">Lade Gruppen...</p>
    </div>
  </div>
</div>

<div id="contentArea" style="display:none">
  <div class="titlebar">
    <div class="title">Gruppeneinstellungen</div>
    <select id="groupSelect" class="group-select">
      <option value="">Gruppe w√§hlen...</option>
    </select>
  </div>
  <div class="pillbar" id="tabs">
    <button class="pill active" data-tab="welcome">Begr√º√üung</button>
    <button class="pill" data-tab="rules">Regeln</button>
    <button class="pill" data-tab="farewell">Verabschiedung</button>
    <button class="pill" data-tab="spam">Spam</button>
    <button class="pill" data-tab="rss">RSS</button>
    <button class="pill" data-tab="ai">KI</button>
    <button class="pill" data-tab="faq">FAQ</button>
    <button class="pill" data-tab="night">Nachtmodus</button>
  </div>

  <section class="card active" id="sec-welcome">
    <div class="row">
      <label class="switch"><input type="checkbox" data-key="welcome.on"> Begr√º√üung aktiv</label>
    </div>
    <label>Text</label>
    <textarea data-key="welcome.text" placeholder="Willkommen {user} üëã"></textarea>
  </section>

  <section class="card" id="sec-rules">
    <div class="row">
      <label class="switch"><input type="checkbox" data-key="rules.on"> Regeln aktiv</label>
    </div>
    <label>Text</label>
    <textarea data-key="rules.text" placeholder="Bitte beachte unsere Regeln ‚Ä¶"></textarea>
  </section>

  <section class="card" id="sec-farewell">
    <div class="row">
      <label class="switch"><input type="checkbox" data-key="farewell.on"> Verabschiedung aktiv</label>
    </div>
    <label>Text</label>
    <textarea data-key="farewell.text" placeholder="Tsch√ºss {user}!"></textarea>
  </section>

  <section class="card" id="sec-spam">
    <div class="grid">
      <label class="switch"><input type="checkbox" data-key="spam.on"> Spam-Filter aktiv</label>
      <label class="switch"><input type="checkbox" data-key="spam.block_links"> Links blockieren</label>
    </div>
  </section>

  <section class="card" id="sec-rss">
    <label>RSS-Feed URL
      <input type="text" id="rss_url" placeholder="https://example.com/feed.xml"/>
    </label>
    <button class="btn small" id="rss_add">Hinzuf√ºgen</button>
    <div id="rssList" class="list"></div>
  </section>

  <section class="card" id="sec-ai">
    <div class="row">
      <label class="switch"><input type="checkbox" data-key="ai.on"> KI/FAQ aktiv</label>
    </div>
  </section>

  <section class="card" id="sec-faq">
    <label>Frage
      <input type="text" id="faq_q" placeholder="Deine Frage ‚Ä¶" />
    </label>
    <label>Antwort
      <input type="text" id="faq_a" placeholder="Kurze Antwort ‚Ä¶" />
    </label>
    <button class="btn small" id="faq_add">Hinzuf√ºgen</button>
    <div id="faqList" class="list"></div>
  </section>

  <section class="card" id="sec-night">
    <div class="grid">
      <label class="switch"><input type="checkbox" data-key="night.on"> Nachtmodus aktiv</label>
      <label>Start (HH:MM)
        <input type="text" data-key="night.start" placeholder="22:00" />
      </label>
      <label>Ende (HH:MM)
        <input type="text" data-key="night.end" placeholder="07:00" />
      </label>
    </div>
  </section>
</div>

<div class="footerbar">
  <div class="left">
    <button class="btn ghost" id="backBtn">‚Üê Zur√ºck</button>
    <div id="out" class="hint">Bereit.</div>
  </div>
  <div class="right">
    <button class="btn ghost" id="themeBtn" title="Hell/Dunkel">üåì</button>
    <button class="btn ghost" id="resetBtn">Zur√ºcksetzen</button>
    <button class="btn ghost" id="closeBtn">Schlie√üen</button>
    <button class="btn primary" id="saveBtn" disabled>Speichern</button>
  </div>
</div>

<script>
const qs = (s) => document.querySelector(s);
const qa = (s) => Array.from(document.querySelectorAll(s));
const getUrlParam = (k, def=null) => new URL(location.href).searchParams.get(k) ?? def;

const tg = window.Telegram?.WebApp;
const API_BASE = getUrlParam("api") || "https://emeraldcontent-aac379fc581e.herokuapp.com";
const INIT_DATA = tg?.initData || "";
const uid = parseInt(getUrlParam("uid") || tg?.initDataUnsafe?.user?.id || 0);
let cid = parseInt(getUrlParam("cid") || 0);
const authQS = INIT_DATA ? "" : `&uid=${encodeURIComponent(uid)}`;
let STATE_READY = false;

function setVal(path, val) {
  const el = qa(`[data-key="${path}"]`)[0];
  if(!el) return;
  if(el.type==='checkbox') el.checked = !!val;
  else el.value = (val ?? '');
}

function collect() {
  const out = {};
  qa('[data-key]').forEach(el=>{
    const path = el.getAttribute('data-key');
    const parts = path.split('.');
    let cur = out;
    for(let i=0; i<parts.length-1; i++) {
      if(!(parts[i] in cur)) cur[parts[i]] = {};
      cur = cur[parts[i]];
    }
    const leaf = parts[parts.length-1];
    const val = (el.type==='checkbox') ? !!el.checked : el.value;
    cur[leaf] = val;
  });
  return out;
}

function showStartPage() {
  qs('#startPage').style.display = 'block';
  const area = qs('#contentArea');
  if(area) { area.style.display = 'none'; area.classList.remove('visible'); }
  cid = 0;
}

function showContentArea(gid) {
  cid = parseInt(gid);
  qs('#startPage').style.display = 'none';
  const area = qs('#contentArea');
  if(area) { area.style.display = 'block'; setTimeout(()=>area.classList.add('visible'), 10); }
}

async function loadGroups() {
  const list = qs('#groupList');
  if(!list) return;
  try {
    list.innerHTML = '<p class="hint">‚è≥ Lade Gruppen‚Ä¶</p>';
    const headers = {};
    if(INIT_DATA) headers['X-Telegram-Init-Data'] = INIT_DATA;
    const res = await fetch(`${API_BASE}/miniapp/groups?${authQS}`, {headers});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const groups = data?.groups || [];
    
    const select = qs('#groupSelect');
    if(select) {
      select.innerHTML = '<option value="">Gruppe w√§hlen...</option>' + 
        groups.map(g => `<option value="${g.id}">${g.title || g.id}</option>`).join('');
      if(cid) select.value = cid;
      select.addEventListener('change', ()=>{
        const v = select.value;
        if(v) { showContentArea(v); loadState(); }
      });
    }
    
    if(!groups.length) {
      list.innerHTML = '<p class="hint">Keine Gruppen gefunden. F√ºge den Bot zu deiner Gruppe hinzu.</p>';
    } else {
      list.innerHTML = groups.map(g => 
        `<div class="group-item" data-id="${g.id}">
          <div class="group-info">
            <div class="group-title">${g.title || g.id}</div>
            <div class="group-meta">Telegram-Gruppe</div>
          </div>
          <button class="btn primary small">Verwalten</button>
        </div>`
      ).join('');
      qa('.group-item button').forEach(btn=>{
        btn.onclick = ()=>{
          const gid = btn.closest('.group-item').dataset.id;
          if(gid) { showContentArea(gid); loadState(); }
        };
      });
    }
  } catch(err) {
    console.error('Gruppen laden fehlgeschlagen', err);
    list.innerHTML = `<p class="hint error">Fehler: ${err.message}</p>`;
  }
}

async function loadState() {
  qs('#out').textContent = 'Lade ‚Ä¶';
  try {
    const res = await fetch(`${API_BASE}/miniapp/state?cid=${cid}${authQS}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'X-Telegram-Init-Data': INIT_DATA
      }
    });
    if(!res.ok) throw new Error(await res.text());
    const j = await res.json();
    
    setVal('welcome.on', j.welcome?.on);
    setVal('welcome.text', j.welcome?.text);
    setVal('rules.on', j.rules?.on);
    setVal('rules.text', j.rules?.text);
    setVal('farewell.on', j.farewell?.on);
    setVal('farewell.text', j.farewell?.text);
    setVal('spam.on', j.spam?.on ?? false);
    setVal('spam.block_links', j.spam?.block_links ?? false);
    setVal('ai.on', j.ai?.on ?? false);
    setVal('night.on', j.night?.on ?? false);
    setVal('night.start', j.night?.start || '22:00');
    setVal('night.end', j.night?.end || '07:00');
    
    qs('#out').textContent = 'Bereit.';
    STATE_READY = true;
  } catch(e) {
    console.error(e);
    qs('#out').textContent = 'Fehler beim Laden.';
    STATE_READY = false;
  }
}

async function sendPayload(extra = {}) {
  if(!STATE_READY) { qs('#out').textContent = '‚ö†Ô∏è Erst Daten laden'; return; }
  
  const out = Object.assign({}, collect(), extra);
  qs('#out').textContent = 'Speichere ‚Ä¶';
  
  try {
    try { tg?.sendData?.(JSON.stringify(out)); } catch {}
    const res = await fetch(`${API_BASE}/miniapp/apply?cid=${encodeURIComponent(cid)}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Telegram-Init-Data': INIT_DATA
      },
      body: JSON.stringify(out)
    });
    if(!res.ok) throw new Error(await res.text());
    qs('#out').textContent = '‚úÖ Gespeichert';
    await loadState();
  } catch(e) {
    console.error(e);
    qs('#out').textContent = '‚ö†Ô∏è Fehler';
  }
}

qs('#backBtn')?.addEventListener('click', showStartPage);
qs('#closeBtn')?.addEventListener('click', ()=>{ try{ tg.close(); }catch{ window.close(); } });
qs('#resetBtn')?.addEventListener('click', loadState);
qs('#saveBtn')?.addEventListener('click', ()=>sendPayload());
qs('#themeBtn')?.addEventListener('click', ()=>{
  const cur = document.documentElement.getAttribute('data-theme') || 'dark';
  const next = cur === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('emerald-theme', next);
});

qa('#tabs .pill').forEach(p=>p.addEventListener('click', ()=>{
  qa('#tabs .pill').forEach(x=>x.classList.remove('active'));
  p.classList.add('active');
  qa('section.card').forEach(s=>s.classList.remove('active'));
  qs('#sec-' + p.dataset.tab).classList.add('active');
}));

document.addEventListener('DOMContentLoaded', async ()=>{
  await loadGroups();
  if(cid) { showContentArea(cid); await loadState(); }
  else { showStartPage(); }
});
</script>
</body>
</html>

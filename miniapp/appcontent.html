<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Emerald Content – Mini-App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg:#0a0f14;
      --panel:#0e141b;
      --ring:#243041;
      --text:#d7e0ea;
      --muted:#9aa7b5;
      --brand:#22c55e;
      --danger:#ef4444;
      --yellow:#f59e0b;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    h1{font-size:22px;margin:0 0 12px}
    h2{font-size:16px;margin:10px 0}
    .row{display:block;margin:10px 0}
    .row.single{margin:14px 0}
    .stack{display:flex;gap:8px;align-items:center}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .card{background:var(--panel);border:1px solid var(--ring);border-radius:14px;padding:12px}
    .muted{color:var(--muted)}
    .dim{opacity:.8}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--ring);background:#0b0e12;color:var(--text);cursor:pointer}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#031406}
    .btn.ghost{background:transparent}
    .btn.warn{background:transparent;border-color:var(--danger);color:var(--danger)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin:10px 0 6px}
    .tabs{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--ring);background:#0b0e12;cursor:pointer}
    .tab.active{background:var(--brand);border-color:var(--brand);color:#031406}
    .section{display:none}
    .section.active{display:block}
    label.switch{display:inline-flex;align-items:center;gap:8px;user-select:none;cursor:pointer}
    input[type="text"],input[type="url"],input[type="number"],input[type="time"],textarea,select{
      width:100%;box-sizing:border-box;background:#0b0e12;border:1px solid var(--ring);color:var(--text);
      border-radius:10px;padding:10px;outline:none
    }
    textarea{min-height:110px;resize:vertical}
    .table{width:100%;border-collapse:collapse;margin-top:8px}
    .table th,.table td{border:1px solid #2a3240;padding:6px 8px;text-align:left;font-size:13px}
    .table th{background:#0b0e12}
    .footer{margin-top:16px;display:flex;gap:8px;justify-content:space-between;align-items:center}
    .hint{font-size:12px}
    details summary{cursor:pointer}
    .badge{display:inline-block;padding:2px 8px;border:1px solid var(--ring);border-radius:999px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Emerald Content – Mini-App</h1>

    <div class="toolbar">
      <button class="btn ghost" id="resetBtn">Zurücksetzen</button>
      <button class="btn" id="closeBtn">Schließen</button>
      <button class="btn primary" id="saveBtn">Speichern</button>
    </div>

    <div class="tabs" id="tabs"></div>

    <!-- SECTIONS -->
    <section id="sec-welcome" class="section card">
      <h2>Begrüßung</h2>
      <label class="switch row"><input type="checkbox" data-key="welcome.on" id="welcome_on"> Aktiv</label>
      <div class="row">
        <label>Text</label>
        <textarea data-key="welcome.text" id="welcome_text" placeholder="Willkommenstext …"></textarea>
        <div class="hint muted">Hinweis: Bilder werden weiterhin via Telegram gesendet. Hier siehst du die gespeicherte Vorschau.</div>
      </div>
      <div id="welcome_preview_wrap" class="row" style="display:none">
        <img id="welcome_preview" alt="Welcome Bild" style="max-width:100%;border-radius:12px">
      </div>
    </section>

    <section id="sec-rules" class="section card">
      <h2>Regeln</h2>
      <label class="switch row"><input type="checkbox" data-key="rules.on" id="rules_on"> Aktiv</label>
      <div class="row">
        <label>Text</label>
        <textarea data-key="rules.text" id="rules_text" placeholder="Regeltext …"></textarea>
      </div>
    </section>

    <section id="sec-farewell" class="section card">
      <h2>Verabschiedung</h2>
      <label class="switch row"><input type="checkbox" data-key="farewell.on" id="farewell_on"> Aktiv</label>
      <div class="row">
        <label>Text</label>
        <textarea data-key="farewell.text" id="farewell_text" placeholder="Verabschiedungstext …"></textarea>
      </div>
    </section>

    <section id="sec-spam" class="section card">
      <h2>Spam</h2>
      <div class="grid">
        <label class="switch"><input type="checkbox" data-key="spam.on" id="spam_on"> Spam-Filter aktiv</label>
        <label class="switch"><input type="checkbox" data-key="spam.block_links" id="spam_links"> Links blockieren</label>
        <label class="switch"><input type="checkbox" data-key="spam.block_media" id="spam_media"> Medien blockieren</label>
        <label class="switch"><input type="checkbox" data-key="spam.block_invite_links" id="spam_invites"> Einladungslinks löschen</label>
      </div>
      <div class="row">
        <label>Policy-Topic (ID)</label>
        <input type="text" data-key="spam.policy_topic" id="spam_policy_topic" placeholder="z.B. 123">
      </div>
    </section>

    <section id="sec-rss" class="section card">
      <h2>RSS</h2>
      <div class="grid">
        <label class="switch"><input type="checkbox" data-key="rss.on" id="rss_on"> RSS aktiv</label>
        <label class="switch"><input type="checkbox" data-key="rss.post_images" id="rss_images"> Bilder posten</label>
      </div>
      <div class="row">
        <span id="rssTopicInfo" class="badge">Topic: –</span>
      </div>
      <div class="row">
        <label>Neuen Feed hinzufügen</label>
        <div class="grid">
          <input type="url" data-key="rss.url" id="rss_url" placeholder="https://…">
          <input type="number" data-key="rss.interval" id="rss_interval" placeholder="Intervall (min)">
        </div>
      </div>
      <div class="row">
        <div id="rssList" class="card"></div>
      </div>
    </section>

    <section id="sec-ai" class="section card">
      <h2>KI (Allgemein)</h2>
      <div class="grid">
        <label class="switch"><input type="checkbox" data-key="ai.on" id="ai_on"> KI-Features aktiv</label>
      </div>
      <div class="row">
        <label>FAQ-Prompt / Wissensbasis</label>
        <textarea data-key="ai.faq" id="ai_faq" placeholder="Frage-Antwort-Wissen …"></textarea>
      </div>
    </section>

    <section id="sec-aimod" class="section card">
      <h2>KI-Moderation</h2>
      <div class="grid">
        <label class="switch"><input type="checkbox" id="aimod_enabled"> Aktiv</label>
        <label class="switch"><input type="checkbox" id="aimod_shadow"> Schattenmodus (nur Log)</label>
      </div>
      <div class="grid">
        <label>Topic-ID <input id="aimod_topic" type="number" min="0" step="1" placeholder="0 = Hauptthread"></label>
        <label>Primäraktion
          <select id="aimod_action">
            <option value="delete">Löschen</option>
            <option value="warn">Warnen</option>
            <option value="mute">Stummschalten</option>
          </select>
        </label>
      </div>
      <div class="grid">
        <label>Mute (Minuten) <input id="aimod_mute" type="number" min="0" step="1"></label>
        <label>Warn-Text <input id="aimod_warn" type="text" placeholder="z.B. Bitte Formulierung anpassen …"></label>
      </div>
      <div class="row">
        <label>Appeal-URL <input id="aimod_appeal" type="url" placeholder="https://…"></label>
      </div>
      <fieldset class="row card">
        <legend>Schwellen (0.00–1.00)</legend>
        <div class="grid3">
          <label>Toxicity <input id="thr_toxicity" type="number" min="0" max="1" step="0.01"></label>
          <label>Hate <input id="thr_hate" type="number" min="0" max="1" step="0.01"></label>
          <label>Harassment <input id="thr_harassment" type="number" min="0" max="1" step="0.01"></label>
          <label>Sexual <input id="thr_sexual" type="number" min="0" max="1" step="0.01"></label>
          <label>Self-harm <input id="thr_selfharm" type="number" min="0" max="1" step="0.01"></label>
          <label>Violence <input id="thr_violence" type="number" min="0" max="1" step="0.01"></label>
          <label>Nudity <input id="thr_nudity" type="number" min="0" max="1" step="0.01"></label>
          <label>Weapons <input id="thr_weapons" type="number" min="0" max="1" step="0.01"></label>
          <label>Gore <input id="thr_gore" type="number" min="0" max="1" step="0.01"></label>
          <label>Link-Risiko <input id="thr_link" type="number" min="0" max="1" step="0.01"></label>
        </div>
      </fieldset>
      <div class="grid">
        <label class="switch"><input type="checkbox" id="aimod_exempt_admins"> Admins ausnehmen</label>
        <label class="switch"><input type="checkbox" id="aimod_exempt_owner"> Topic-Owner ausnehmen</label>
      </div>
    </section>

    <section id="sec-faq" class="section card">
      <h2>FAQ</h2>
      <div class="row">
        <label>Neuen FAQ-Eintrag</label>
        <div class="grid">
          <input type="text" id="faq_q" placeholder="Frage …">
          <input type="text" id="faq_a" placeholder="Antwort …">
        </div>
      </div>
      <div class="row">
        <div id="faqList" class="card"></div>
      </div>
    </section>

    <section id="sec-stats" class="section card">
      <h2>Report / Statistik</h2>
      <p id="dailyStatsInfo" class="hint"></p>
      <div id="statsOut" class="row mono"></div>
    </section>

    <section id="sec-mood" class="section card">
      <h2>Mood</h2>
      <div class="row">
        <span class="badge">Aktuelle Frage:</span>
        <span id="moodQuestion" class="mono"></span>
      </div>
      <div class="row stack">
        <button class="btn" id="btnSendMood">Jetzt in der Gruppe senden</button>
      </div>
    </section>

    <section id="sec-night" class="section card">
      <h2>Nachtmodus</h2>
      <div class="grid">
        <label class="switch"><input type="checkbox" data-key="night.on" id="night_on"> Nachtmodus aktiv</label>
        <label>Start <input type="time" data-key="night.start" id="night_start"></label>
        <label>Ende <input type="time" data-key="night.end" id="night_end"></label>
      </div>
      <div class="hint muted">Nachrichten im Zeitraum werden gemäß Regeln behandelt (stumm/ablehnen/löschen – Bot-Konfiguration).</div>
    </section>

    <section id="sec-router" class="section card">
      <h2>Topic-Router</h2>
      <div class="row">
        <label>Neue Regel</label>
        <div class="grid">
          <input type="text" id="router_keywords" placeholder="Keywords (Komma-getrennt)">
          <input type="text" id="router_domains" placeholder="Domains (Komma-getrennt)">
          <input type="number" id="router_target" placeholder="Ziel-Topic-ID">
        </div>
        <div class="row stack">
          <label class="switch"><input type="checkbox" id="router_enabled" checked> Aktiv</label>
          <button class="btn" id="btnAddRule">Regel hinzufügen</button>
        </div>
      </div>
      <div class="row">
        <div id="routerList" class="card"></div>
      </div>
    </section>

    <section id="sec-more" class="section card">
      <h2>Mehr</h2>
      <div class="row">
        <div class="muted">Website: <a href="https://greeny187.github.io/GreenyManagementBots/" target="_blank">greeny187.github.io/GreenyManagementBots</a></div>
        <div class="muted">Support: <a href="https://t.me/+DkUfIvjyej8zNGVi" target="_blank">Telegram</a></div>
      </div>
      <h3>Bereinigung gelöschter Accounts</h3>
      <div class="grid">
        <label>Plan (Cron-ähnlich, optional)<input type="text" id="cleanup_schedule" placeholder="z. B. täglich 03:00"></label>
        <button class="btn" id="btnCleanupNow">Jetzt bereinigen</button>
      </div>
      <div class="hint muted">Hinweis: Sofort-Bereinigung löst den Prozess direkt aus; Planung wird serverseitig gespeichert (falls unterstützt).</div>
    </section>

    <section id="sec-pro" class="section card">
      <h2>Pro</h2>
      <div id="proInfo" class="row single"></div>
      <div id="adBanner" class="row single" style="display:none">
        <div class="card" style="padding:16px;border-radius:12px">
          <b>Unterstütze das Projekt & werde Pro</b>
          <p class="dim">Mit Pro blendest du Werbung aus und schaltest erweiterte Funktionen frei (z. B. KI-Moderation, längere Statistiken).</p>
          <ul style="margin:0 0 8px 18px">
            <li>Website: <a href="https://greeny187.github.io/GreenyManagementBots/" target="_blank">Infos</a></li>
            <li>TON-Wallet: <code class="mono">UQBopac1WFJGC_K48T8JqcbRoH3evUoUDwS2oItlS-SgpR8L</code></li>
            <li>PayPal: <code class="mono">greeny187@outlook.de</code></li>
            <li>Support: <a href="https://t.me/+DkUfIvjyej8zNGVi" target="_blank">Telegram</a></li>
          </ul>
          <div class="row stack">
            <button class="btn" id="buyPro1">Jetzt Pro (1&nbsp;Monat)</button>
            <button class="btn" id="buyPro12">Pro (12&nbsp;Monate)</button>
          </div>
          <div class="hint muted">Diese Buttons senden den Kaufwunsch an den Bot (WebAppData). Die Bezahlung kann mit Telegram Stars / TON / PayPal verknüpft werden.</div>
        </div>
      </div>
    </section>

    <div class="footer">
      <span class="muted hint">© Emerald Content</span>
      <span id="out" class="muted hint"></span>
    </div>
  </div>

  <script>
    // ---- Grundsetup
    const tg = window.Telegram && Telegram.WebApp ? Telegram.WebApp : null;
    if (tg){ try{ tg.expand(); tg.enableClosingConfirmation(); }catch{} }

    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));
    const storeTabKey = "emerald-tab";
    const API_BASE = ""; // relativ

    function getUrlParam(name, def=null){
      const u = new URL(location.href);
      return u.searchParams.get(name) ?? def;
    }
    const cid = getUrlParam("cid","");
    let uid = null; // wird aus initDataUnsafe gelesen
    let lastState = null;

    // ---- Tabs
    const TABS = [
      ['welcome','Begrüßung'],
      ['rules','Regeln'],
      ['farewell','Verabschiedung'],
      ['spam','Spam'],
      ['rss','RSS'],
      ['ai','KI'],
      ['aimod','KI-Moderation'],
      ['faq','FAQ'],
      ['stats','Report'],
      ['mood','Mood'],
      ['night','Nachtmodus'],
      ['router','Router'],
      ['more','Mehr'],
      ['pro','Pro']
    ];

    (function renderTabs(){
      const c = qs("#tabs");
      c.innerHTML = "";
      TABS.forEach(([key,label],i)=>{
        const b = document.createElement("button");
        b.className = "tab";
        b.textContent = label;
        b.dataset.key = key;
        b.onclick = ()=>{
          qsa(".tab").forEach(x=>x.classList.remove("active"));
          b.classList.add("active");
          qsa(".section").forEach(x=>x.classList.remove("active"));
          qs("#sec-"+key).classList.add("active");
          localStorage.setItem(storeTabKey, key);
          if (key === "stats") loadStats(); // Autoload bei Tabwechsel
        };
        c.appendChild(b);
      });
      const last = localStorage.getItem(storeTabKey);
      const btn = last ? qsa(".tab").find(x=>x.dataset.key===last) : null;
      (btn || qsa(".tab")[0]).click();
    })();

    // ---- Helpers
    function setVal(idOrKey, val){
      const el = document.getElementById(idOrKey) || document.querySelector(`[data-key="${idOrKey}"]`);
      if (!el) return;
      if (el.type === "checkbox") el.checked = !!val;
      else el.value = (val ?? "");
    }
    function setCheck(id, on){ const el = document.getElementById(id); if (el) el.checked = !!on; }
    function getVal(id){ const el = document.getElementById(id); if (!el) return ""; return el.value; }
    function isChecked(id){ const el = document.getElementById(id); return !!(el && el.checked); }
    function toInt(v){ const n = parseInt(v,10); return Number.isFinite(n) ? n : 0; }
    function toNum(v){ const n = parseFloat(v); return Number.isFinite(n) ? n : null; }

    function collect(){
      // Alle data-key Felder in verschachteltes Objekt
      const out = {};
      qsa("[data-key]").forEach(el=>{
        const path = el.dataset.key.split(".");
        let ref = out;
        for (let i=0;i<path.length;i++){
          const k = path[i];
          if (i===path.length-1){
            ref[k] = el.type==="checkbox" ? !!el.checked : el.value;
          } else {
            if (!ref[k] || typeof ref[k] !== "object") ref[k] = {};
            ref = ref[k];
          }
        }
      });

      // KI-Moderation anhängen
      out.ai_mod = {
        enabled: isChecked('aimod_enabled'),
        shadow_mode: isChecked('aimod_shadow'),
        topic_id: toInt(getVal('aimod_topic')),
        action_primary: getVal('aimod_action'),
        mute_minutes: toInt(getVal('aimod_mute')),
        warn_text: getVal('aimod_warn'),
        appeal_url: getVal('aimod_appeal'),
        toxicity: toNum(getVal('thr_toxicity')),
        hate: toNum(getVal('thr_hate')),
        sexual: toNum(getVal('thr_sexual')),
        harassment: toNum(getVal('thr_harassment')),
        selfharm: toNum(getVal('thr_selfharm')),
        violence: toNum(getVal('thr_violence')),
        nudity: toNum(getVal('thr_nudity')),
        weapons: toNum(getVal('thr_weapons')),
        gore: toNum(getVal('thr_gore')),
        link_risk: toNum(getVal('thr_link')),
        exempt_admins: isChecked('aimod_exempt_admins'),
        exempt_topic_owner: isChecked('aimod_exempt_owner')
      };

      // Router: Hinzufügen (falls Felder gefüllt)
      const kw = getVal('router_keywords').trim();
      const dm = getVal('router_domains').trim();
      const rt = toInt(getVal('router_target'));
      const en = isChecked('router_enabled');
      if (kw || dm || rt){
        out.router_add = {
          keywords: kw ? kw.split(",").map(s=>s.trim()).filter(Boolean) : [],
          domains: dm ? dm.split(",").map(s=>s.trim()).filter(Boolean) : [],
          target_topic_id: rt,
          enabled: !!en
        };
      }

      // FAQ: Hinzufügen (falls befüllt)
      const fq = getVal('faq_q').trim();
      const fa = getVal('faq_a').trim();
      if (fq && fa){ out.faq_add = { q: fq, a: fa }; }

      // Cleanup-Plan
      const plan = getVal('cleanup_schedule').trim();
      if (plan) out.cleanup_schedule = plan;

      return out;
    }

    function sendPayload(extra={}){
      const out = collect();
      Object.assign(out, extra);
      if (tg){
        try{ tg.HapticFeedback?.impactOccurred?.("medium"); }catch{}
        tg.sendData(JSON.stringify(out));
        qs("#out").textContent = "Gesendet.";
      } else {
        alert("Bitte die Mini-App innerhalb von Telegram öffnen.");
      }
    }

    // ---- RSS / FAQ / Router Render
    function renderRssList(feeds){
      const box = qs("#rssList");
      if (!feeds || !feeds.length){ box.innerHTML = "<p class='muted'>Keine Feeds gespeichert.</p>"; return; }
      box.innerHTML = feeds.map(f => `
        <div class="row stack" style="justify-content:space-between">
          <div>
            <div class="mono">${escapeHtml(f.url||"")}</div>
            <div class="hint">Topic: ${f.topic ?? 0}</div>
          </div>
          <button class="btn warn" onclick="deleteRss('${encodeURIComponent(f.url||"")}')">Löschen</button>
        </div>
      `).join("");
    }
    function renderFaqs(items){
      const box = qs("#faqList");
      if (!items || !items.length){ box.innerHTML = "<p class='muted'>Keine FAQ hinterlegt.</p>"; return; }
      box.innerHTML = items.map(x => `
        <details class="row">
          <summary>${escapeHtml(x.q||"")}</summary>
          <div class="card" style="margin-top:6px"><pre style="white-space:pre-wrap">${escapeHtml(x.a||"")}</pre></div>
          <div class="row"><button class="btn warn" onclick="delFaq('${encodeURIComponent(x.q||"")}')">Löschen</button></div>
        </details>
      `).join("");
    }
    function renderRouterList(items){
      const box = qs("#routerList");
      if (!items || !items.length){ box.innerHTML = "<p class='muted'>Keine Regeln definiert.</p>"; return; }
      box.innerHTML = items.map(r => `
        <div class="row card">
          <div class="stack" style="justify-content:space-between">
            <div>
              <div>ID: <span class="mono">${r.rule_id}</span> – Ziel-Topic: <span class="mono">${r.target_topic_id}</span></div>
              <div class="hint">Aktiv: ${r.enabled ? "Ja" : "Nein"}</div>
              <div class="hint">Keywords: ${escapeHtml((r.keywords||[]).join(", ")) || "—"}</div>
              <div class="hint">Domains: ${escapeHtml((r.domains||[]).join(", ")) || "—"}</div>
            </div>
            <div class="stack">
              <button class="btn" onclick="toggleRule(${r.rule_id}, ${r.enabled?0:1})">${r.enabled?"Deaktivieren":"Aktivieren"}</button>
              <button class="btn warn" onclick="delRule(${r.rule_id})">Löschen</button>
            </div>
          </div>
        </div>
      `).join("");
    }

    // ---- Delete/Toggle Aktionen (senden Einzel-Payloads)
    window.deleteRss = (encUrl)=>{
      sendPayload({ rss_del: decodeURIComponent(encUrl) });
    };
    window.delFaq = (encQ)=>{
      sendPayload({ faq_del: decodeURIComponent(encQ) });
    };
    window.delRule = (rule_id)=>{
      sendPayload({ router_del: Number(rule_id)||0 });
    };
    window.toggleRule = (rule_id, enabled)=>{
      sendPayload({ router_toggle: { rule_id:Number(rule_id)||0, enabled:!!enabled } });
    };

    // ---- State laden
    async function loadState(){
      const out = qs("#out");
      out.textContent = "Lade …";
      try{
        uid = tg?.initDataUnsafe?.user?.id || "";
        const url = `${API_BASE}/miniapp/state${cid&&uid?`?cid=${encodeURIComponent(cid)}&uid=${encodeURIComponent(uid)}`:""}`;
        const r = await fetch(url, { method:"GET" });
        const j = await r.json();
        lastState = j;

        // Basismapping
        setVal("welcome.on", j.welcome?.on);
        setVal("welcome.text", j.welcome?.text);
        setVal("rules.on", j.rules?.on);
        setVal("rules.text", j.rules?.text);
        setVal("farewell.on", j.farewell?.on);
        setVal("farewell.text", j.farewell?.text);

        setVal("spam.on", j.spam?.on);
        setVal("spam.block_links", j.spam?.block_links);
        setVal("spam.block_media", j.spam?.block_media);
        setVal("spam.block_invite_links", j.spam?.block_invite_links);
        setVal("spam.policy_topic", j.spam?.policy_topic);

        setVal("rss.on", j.rss?.on);
        setVal("rss.post_images", j.rss?.post_images);
        setVal("rss.url", j.rss?.url);
        setVal("rss.interval", j.rss?.interval);
        qs("#rssTopicInfo").textContent = `Topic: ${j.rss?.topic ?? 0}`;
        renderRssList(j.rss?.feeds || []);

        setVal("ai.on", j.ai?.on);
        setVal("ai.faq", j.ai?.faq);

        // KI-Moderation
        bindAimod(j.aimod || {});

        // FAQ
        renderFaqs(j.faqs || []);

        // Mood
        qs("#moodQuestion").textContent = j.mood?.question || "Wie ist deine Stimmung?";

        // Nachtmodus (aus 'Mehr' herausgelöst)
        setVal("night.on", j.night?.on);
        setVal("night.start", j.night?.start);
        setVal("night.end", j.night?.end);

        // Router
        renderRouterList(j.router_rules || []);

        // Daily-Report-Hinweis
        qs("#dailyStatsInfo").textContent = j.daily_stats
          ? "📊 Tagesreport aktiv – Versand täglich um 08:00 Uhr."
          : "Tagesreport ist aktuell deaktiviert.";

        // Pro/Ads
        applySubscriptionUI(j.subscription || {active:false,tier:'free',valid_until:null});

        // Welcome Bild-Vorschau
        if (j.welcome?.photo && j.welcome?.photo_id && cid && uid){
          const src = `${API_BASE}/miniapp/file?cid=${encodeURIComponent(cid)}&uid=${encodeURIComponent(uid)}&file_id=${encodeURIComponent(j.welcome.photo_id)}`;
          const img = qs("#welcome_preview");
          const wrap = qs("#welcome_preview_wrap");
          if (img && wrap){ img.src = src; wrap.style.display = ""; }
        }

        out.textContent = "Bereit.";
        // Statistik autoload
        loadStats();
      }catch(e){
        console.error(e);
        out.textContent = "Fehler beim Laden.";
      }
    }

    function bindAimod(m){
      setCheck('aimod_enabled', !!m.enabled);
      setCheck('aimod_shadow', !!m.shadow_mode);
      setVal('aimod_topic', m.topic_id || 0);
      setVal('aimod_action', m.action_primary || 'delete');
      setVal('aimod_mute', m.mute_minutes || 0);
      setVal('aimod_warn', m.warn_text || '');
      setVal('aimod_appeal', m.appeal_url || '');
      setVal('thr_toxicity', m.toxicity ?? '');
      setVal('thr_hate', m.hate ?? '');
      setVal('thr_sexual', m.sexual ?? '');
      setVal('thr_harassment', m.harassment ?? '');
      setVal('thr_selfharm', m.selfharm ?? '');
      setVal('thr_violence', m.violence ?? '');
      setVal('thr_nudity', m.nudity ?? '');
      setVal('thr_weapons', m.weapons ?? '');
      setVal('thr_gore', m.gore ?? '');
      setVal('thr_link', m.link_risk ?? '');
      setCheck('aimod_exempt_admins', !!m.exempt_admins);
      setCheck('aimod_exempt_owner', !!m.exempt_topic_owner);
    }

    // ---- Stats laden (Autoload)
    async function loadStats(){
      const out = qs("#statsOut");
      out.textContent = "Lade …";
      try{
        const url = `${API_BASE}/miniapp/stats${cid&&uid?`?cid=${encodeURIComponent(cid)}&uid=${encodeURIComponent(uid)}`:""}`;
        const r = await fetch(url, { method:"GET" });
        const j = await r.json();
        out.textContent = JSON.stringify(j, null, 2);
      }catch(e){
        console.error(e);
        out.textContent = "Fehler beim Laden der Statistiken.";
      }
    }

    // ---- Pro UI / Werbung
    function applySubscriptionUI(sub){
      const ad = qs("#adBanner");
      const info = qs("#proInfo");
      if (info){
        const label = sub.active ? "✅ PRO aktiv" : "❌ Free";
        const until = sub.valid_until ? ` – gültig bis: ${new Date(sub.valid_until).toLocaleString()}` : "";
        info.innerHTML = `<b>Status:</b> ${label}${until}`;
      }
      if (ad) ad.style.display = sub.active ? "none" : "";
      qs("#buyPro1")?.addEventListener("click", ()=> sendPayload({pro_months:1}));
      qs("#buyPro12")?.addEventListener("click", ()=> sendPayload({pro_months:12}));
    }

    // ---- Mood jetzt senden
    async function sendMood(){
      try{
        const url = `${API_BASE}/miniapp/send_mood?cid=${encodeURIComponent(cid)}&uid=${encodeURIComponent(uid)}`;
        const r = await fetch(url, {method:"GET"});
        const j = await r.json().catch(()=>({}));
        alert(j && j.ok ? "✅ Mood gesendet." : `⚠️ Konnte Mood nicht senden: ${j && j.error || ""}`);
      }catch(e){
        alert("⚠️ Fehler beim Senden.");
      }
    }

    // ---- Speichern / Aktionen
    function save(){ sendPayload({}); }
    function cleanupNow(){ sendPayload({ cleanup_now: true }); }
    function addRouterRule(){ sendPayload({}); } // Felder werden in collect() zu router_add

    // ---- Kleine Utils
    function escapeHtml(s){ return (s??"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])); }

    // ---- Events
    qs("#saveBtn").onclick = save;
    qs("#closeBtn").onclick = ()=> tg ? tg.close() : window.close();
    qs("#resetBtn").onclick = ()=>{ localStorage.removeItem(storeTabKey); location.reload() };
    qs("#btnSendMood").onclick = sendMood;
    qs("#btnAddRule").onclick = addRouterRule;
    qs("#btnCleanupNow").onclick = cleanupNow;

    // ---- Start
    loadState();
  </script>
</body>
</html>

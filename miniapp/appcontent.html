<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Emerald Content – Mini-App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg:#0a0f14;
      --panel:#0e141b;
      --ring:#243041;
      --text:#d7e0ea;
      --muted:#9aa7b5;
      --brand:#22c55e;
      --danger:#ef4444;
      --yellow:#f59e0b;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    h1{font-size:22px;margin:0 0 12px}
    h2{font-size:16px;margin:10px 0}
    .row{display:block;margin:10px 0}
    .row.single{margin:14px 0}
    .card{background:var(--panel);border:1px solid var(--ring);border-radius:14px;padding:12px}
    .stack{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted)}
    .dim{opacity:.8}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--ring);background:#0b0e12;color:var(--text);cursor:pointer}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#031406}
    .btn.ghost{background:transparent}
    .btn.warn{background:transparent;border-color:var(--danger);color:var(--danger)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin:10px 0 6px}
    .tabs{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--ring);background:#0b0e12;cursor:pointer}
    .tab.active{background:var(--brand);border-color:var(--brand);color:#031406}
    .section{display:none}
    .section.active{display:block}
    label.switch{display:inline-flex;align-items:center;gap:8px;user-select:none;cursor:pointer}
    input[type="text"],input[type="url"],textarea,select{
      width:100%;box-sizing:border-box;background:#0b0e12;border:1px solid var(--ring);color:var(--text);
      border-radius:10px;padding:10px;outline:none
    }
    textarea{min-height:110px;resize:vertical}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .table{width:100%;border-collapse:collapse;margin-top:8px}
    .table th,.table td{border:1px solid #2a3240;padding:6px 8px;text-align:left;font-size:13px}
    .table th{background:#0b0e12}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .footer{margin-top:16px;display:flex;gap:8px;justify-content:space-between;align-items:center}
    .hint{font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Emerald Content – Mini-App</h1>

    <div class="toolbar">
      <button class="btn ghost" id="resetBtn">Zurücksetzen</button>
      <button class="btn" id="closeBtn">Schließen</button>
      <button class="btn primary" id="saveBtn">Speichern</button>
    </div>

    <div class="tabs" id="tabs"></div>

    <!-- SECTIONS -->
    <section id="sec-welcome" class="section card">
      <h2>Begrüßung</h2>
      <label class="switch row"><input type="checkbox" id="welcome_on" data-key="welcome.on"> Aktiv</label>
      <div class="row">
        <label>Text</label>
        <textarea id="welcome_text" data-key="welcome.text" placeholder="Willkommenstext …"></textarea>
        <div class="hint muted">Hinweis: Bilder für die Begrüßung werden weiterhin via Telegram gesendet. Hier siehst du nur die gespeicherte Vorschau.</div>
      </div>
      <div id="welcome_preview_wrap" class="row" style="display:none">
        <img id="welcome_preview" alt="Welcome Bild" style="max-width:100%;border-radius:12px">
      </div>
    </section>

    <section id="sec-rules" class="section card">
      <h2>Regeln</h2>
      <label class="switch row"><input type="checkbox" id="rules_on" data-key="rules.on"> Aktiv</label>
      <div class="row">
        <label>Text</label>
        <textarea id="rules_text" data-key="rules.text" placeholder="Regeltext …"></textarea>
      </div>
    </section>

    <section id="sec-farewell" class="section card">
      <h2>Verabschiedung</h2>
      <label class="switch row"><input type="checkbox" id="farewell_on" data-key="farewell.on"> Aktiv</label>
      <div class="row">
        <label>Text</label>
        <textarea id="farewell_text" data-key="farewell.text" placeholder="Verabschiedungstext …"></textarea>
      </div>
    </section>

    <section id="sec-spam" class="section card">
      <h2>Spam</h2>
      <div class="grid">
        <label class="switch"><input type="checkbox" id="spam_on" data-key="spam.on"> Spam-Filter aktiv</label>
        <label class="switch"><input type="checkbox" id="spam_links" data-key="spam.block_links"> Links blockieren</label>
        <label class="switch"><input type="checkbox" id="spam_media" data-key="spam.block_media"> Medien blockieren</label>
        <label class="switch"><input type="checkbox" id="spam_invites" data-key="spam.block_invite_links"> Einladungslinks löschen</label>
      </div>
      <div class="row">
        <label>Policy-Topic (ID)</label>
        <input type="text" id="spam_policy_topic" data-key="spam.policy_topic" placeholder="z.B. 123">
      </div>
    </section>

    <section id="sec-rss" class="section card">
      <h2>RSS</h2>
      <div class="grid">
        <label class="switch"><input type="checkbox" id="rss_on" data-key="rss.on"> RSS aktiv</label>
        <label class="switch"><input type="checkbox" id="rss_images" data-key="rss.post_images"> Bilder posten</label>
      </div>
      <div class="row">
        <label>Feed-URL</label>
        <input type="url" id="rss_url" data-key="rss.url" placeholder="https://…">
      </div>
      <div class="row">
        <label>Intervall (Minuten)</label>
        <input type="text" id="rss_interval" data-key="rss.interval" placeholder="z.B. 10">
      </div>
    </section>

    <section id="sec-ai" class="section card">
      <h2>KI</h2>
      <div class="grid">
        <label class="switch"><input type="checkbox" id="ai_on" data-key="ai.on"> KI-Features aktiv</label>
        <label class="switch"><input type="checkbox" id="ai_auto_mod" data-key="ai.moderation"> Auto-Moderation</label>
      </div>
      <div class="row">
        <label>FAQ Prompt / Wissensbasis</label>
        <textarea id="ai_faq" data-key="ai.faq" placeholder="Frage-Antwort-Wissen …"></textarea>
      </div>
    </section>

    <section id="sec-faq" class="section card">
      <h2>FAQ</h2>
      <div class="row">
        <label>FAQ-Text</label>
        <textarea id="faq_text" data-key="faq.text" placeholder="FAQ …"></textarea>
      </div>
    </section>

    <section id="sec-stats" class="section card">
      <h2>Report / Stats</h2>
      <div class="row stack">
        <button class="btn" id="loadStats">Neu laden</button>
        <span class="muted">zeigt Tageskennzahlen (letzte 24–48h)</span>
      </div>
      <div id="statsOut" class="row mono"></div>
    </section>

    <section id="sec-mood" class="section card">
      <h2>Mood</h2>
      <label class="switch row"><input type="checkbox" id="mood_on" data-key="mood.on"> Mood-Posts aktiv</label>
      <div class="row">
        <label>Stimmungstext (Template)</label>
        <textarea id="mood_text" data-key="mood.text" placeholder="Textvorlage …"></textarea>
      </div>
    </section>

    <section id="sec-more" class="section card">
      <h2>Mehr</h2>
      <div class="row">
        <div class="muted">Website: <a href="https://greeny187.github.io/EmeraldContentBots/" target="_blank">greeny187.github.io/GreenyManagementBots</a></div>
        <div class="muted">Support: <a href="https://t.me/+DkUfIvjyej8zNGVi" target="_blank">Telegram</a></div>
      </div>
    </section>

    <section id="sec-pro" class="section card">
      <h2>Pro</h2>
      <div id="proInfo" class="row single"></div>
      <div id="adBanner" class="row single" style="display:none">
        <div class="card" style="padding:16px;border-radius:12px">
          <b>Unterstütze das Projekt & werde Pro</b>
          <p class="dim">Free-Nutzer sehen dieses Fenster. Mit Pro blendest du Werbung aus und schaltest erweiterte Funktionen (z. B. KI-Features, längere Statistiken) frei.</p>
          <ul style="margin:0 0 8px 18px">
            <li>Website: <a href="https://greeny187.github.io/EmeraldContentBots/" target="_blank">Infos</a></li>
            <li>TON-Wallet: <code class="mono">UQBopac1WFJGC_K48T8JqcbRoH3evUoUDwS2oItlS-SgpR8L</code></li>
            <li>PayPal: <code class="mono">greeny187@outlook.de</code></li>
            <li>Support: <a href="https://t.me/+DkUfIvjyej8zNGVi" target="_blank">Telegram</a></li>
          </ul>
          <div class="row stack">
            <button class="btn" id="buyPro1">Jetzt Pro (1&nbsp;Monat)</button>
            <button class="btn" id="buyPro12">Pro (12&nbsp;Monate)</button>
          </div>
          <div class="hint muted">Hinweis: Diese Buttons senden den Kaufwunsch an den Bot (WebAppData). Die tatsächliche Bezahlung kannst du später mit Telegram Stars / TON / PayPal verknüpfen.</div>
        </div>
      </div>
    </section>

    <div class="footer">
      <span class="muted hint">© Emerald Content</span>
      <span id="out" class="muted hint"></span>
    </div>
  </div>

  <script>
    const tg = window.Telegram && Telegram.WebApp ? Telegram.WebApp : null;
    if (tg){ try{ tg.expand(); tg.enableClosingConfirmation(); }catch{} }
    const storeKey = "emerald-miniapp-cache";

    // Tabs
    const TABS = [
      ['welcome','Begrüßung'],
      ['rules','Regeln'],
      ['farewell','Verabschiedung'],
      ['spam','Spam'],
      ['rss','RSS'],
      ['ai','KI'],
      ['faq','FAQ'],
      ['stats','Report'],
      ['mood','Mood'],
      ['more','Mehr'],
      ['pro','Pro']
    ];

    // Utilities
    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));
    function getUrlParam(name, def=null){
      const u = new URL(location.href);
      return u.searchParams.get(name) ?? def;
    }
    const cid = getUrlParam("cid","");
    const API_BASE = ""; // relative zum Bot-Server

    // Tabs rendern
    (function renderTabs(){
      const c = document.getElementById("tabs");
      c.innerHTML = "";
      TABS.forEach(([key,label],i)=>{
        const b = document.createElement("button");
        b.className = "tab" + (i===0 ? " active":"");
        b.textContent = label;
        b.dataset.key = key;
        b.onclick = ()=>{
          qsa(".tab").forEach(x=>x.classList.remove("active"));
          b.classList.add("active");
          qsa(".section").forEach(x=>x.classList.remove("active"));
          qs("#sec-"+key).classList.add("active");
          localStorage.setItem("emerald-tab", key);
        };
        c.appendChild(b);
      });
      const last = localStorage.getItem("emerald-tab");
      if (last){
        const btn = qsa(".tab").find(x=>x.dataset.key===last);
        if (btn) btn.click();
        else qs(".tab").click();
      } else {
        qs(".tab").click();
      }
    })();

    function setVal(keyPath, val){
      const el = document.querySelector(`[data-key="${keyPath}"]`);
      if (!el) return;
      if (el.type === "checkbox") el.checked = !!val;
      else el.value = (val ?? "");
    }
    function getVal(el){
      if (!el) return undefined;
      if (el.type === "checkbox") return !!el.checked;
      return el.value;
    }
    function collect(){
      // Sammelt alle Felder mit data-key="a.b.c" in ein verschachteltes Objekt
      const out = {};
      qsa("[data-key]").forEach(el=>{
        const path = el.dataset.key.split(".");
        let ref = out;
        for (let i=0;i<path.length;i++){
          const k = path[i];
          if (i===path.length-1){
            ref[k] = getVal(el);
          } else {
            if (!ref[k] || typeof ref[k] !== "object") ref[k] = {};
            ref = ref[k];
          }
        }
      });
      return out;
    }

    async function loadState(){
      const out = document.getElementById("out");
      out.textContent = "Lade …";
      try{
        const user = tg?.initDataUnsafe?.user;
        const uid = user?.id || "";
        const url = `${API_BASE}/miniapp/state` + (cid && uid ? `?cid=${encodeURIComponent(cid)}&uid=${encodeURIComponent(uid)}` : "");
        const r = await fetch(url, { method:"GET" });
        const j = await r.json();

        // Grunddaten auf Felder mappen (sofern vorhanden)
        setVal("welcome.on", j.welcome?.on);
        setVal("welcome.text", j.welcome?.text);
        setVal("rules.on", j.rules?.on);
        setVal("rules.text", j.rules?.text);
        setVal("farewell.on", j.farewell?.on);
        setVal("farewell.text", j.farewell?.text);

        setVal("spam.on", j.spam?.on);
        setVal("spam.block_links", j.spam?.block_links);
        setVal("spam.block_media", j.spam?.block_media);
        setVal("spam.block_invite_links", j.spam?.block_invite_links);
        setVal("spam.policy_topic", j.spam?.policy_topic);

        setVal("rss.on", j.rss?.on);
        setVal("rss.post_images", j.rss?.post_images);
        setVal("rss.url", j.rss?.url);
        setVal("rss.interval", j.rss?.interval);

        setVal("ai.on", j.ai?.on);
        setVal("ai.moderation", j.ai?.moderation);
        setVal("ai.faq", j.ai?.faq);

        setVal("faq.text", j.faq?.text);
        setVal("mood.on", j.mood?.on);
        setVal("mood.text", j.mood?.text);

        // Welcome Preview (sofern Foto hinterlegt)
        if (j.welcome?.photo && j.welcome?.photo_id && cid && uid){
          const src = `${API_BASE}/miniapp/file?cid=${encodeURIComponent(cid)}&uid=${encodeURIComponent(uid)}&file_id=${encodeURIComponent(j.welcome.photo_id)}`;
          const img = document.getElementById("welcome_preview");
          const wrap = document.getElementById("welcome_preview_wrap");
          if (img && wrap){ img.src = src; wrap.style.display = ""; }
        }

        // Subscription / Pro
        const sub = j.subscription || {active:false, tier:"free", valid_until:null};
        const info = document.getElementById("proInfo");
        if (info){
          info.innerHTML = sub.active
           ? (sub.valid_until ? `✅ <b>PRO</b> aktiv bis <span class="mono">${new Date(sub.valid_until).toLocaleString()}</span>` : `✅ <b>PRO</b> aktiv`)
           : `❌ <b>Free</b> – einige Funktionen sind eingeschränkt`;
        }
        const ad = document.getElementById("adBanner");
        if (ad) ad.style.display = sub.active ? "none" : "";

        // Buy Buttons → sendData
        const sendBuy = m => {
          const payload = collect();
          payload.pro_months = m;
          if (tg) tg.sendData(JSON.stringify(payload));
        };
        document.getElementById("buyPro1")?.addEventListener("click", ()=>sendBuy(1));
        document.getElementById("buyPro12")?.addEventListener("click", ()=>sendBuy(12));

        out.textContent = "Bereit.";
      }catch(e){
        console.error(e);
        out.textContent = "Fehler beim Laden.";
      }
    }

    async function loadStats(){
      const out = document.getElementById("statsOut");
      out.textContent = "Lade …";
      try{
        const user = tg?.initDataUnsafe?.user;
        const uid = user?.id || "";
        const url = `${API_BASE}/miniapp/stats` + (cid && uid ? `?cid=${encodeURIComponent(cid)}&uid=${encodeURIComponent(uid)}` : "");
        const r = await fetch(url, { method:"GET" });
        const j = await r.json();
        out.textContent = JSON.stringify(j, null, 2);
      }catch(e){
        console.error(e);
        out.textContent = "Fehler beim Laden der Statistiken.";
      }
    }

    function save(){
      const payload = collect();
      try{
        if (tg){
          tg.HapticFeedback?.impactOccurred?.("medium");
          tg.sendData(JSON.stringify(payload));
          document.getElementById("out").textContent = "Gesendet.";
        }else{
          alert("Bitte die Mini-App innerhalb von Telegram öffnen.");
        }
      }catch(e){
        console.error(e);
        document.getElementById("out").textContent = "Fehler beim Senden.";
      }
    }

    document.getElementById("saveBtn").onclick = save;
    document.getElementById("closeBtn").onclick = ()=> tg ? tg.close() : window.close();
    document.getElementById("resetBtn").onclick = ()=>{ localStorage.removeItem("emerald-tab"); location.reload() };
    document.getElementById("loadStats").onclick = loadStats;

    // Initial laden
    loadState();
  </script>
</body>
</html>

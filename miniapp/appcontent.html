<!doctype html>
<html lang="de" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Emerald Content ‚Äì Mini‚ÄëApp</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --ring:#1f2937; --text:#e5e7eb; --muted:#94a3b8;
      --brand:#22c55e; --danger:#ef4444; --yellow:#f59e0b; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    [data-theme="light"]{
      --bg:#f7fafc; --panel:#ffffff; --ring:#e5e7eb; --text:#0b1220; --muted:#4b5563;
      --brand:#16a34a; --danger:#dc2626; --yellow:#d97706; --shadow:0 6px 22px rgba(0,0,0,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Ubuntu,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:flex-start;margin:4px 0 14px}
    .title{font-weight:700;font-size:20px;letter-spacing:.2px}
    .btn{border:1px solid var(--ring);background:transparent;color:var(--text);padding:8px 12px;border-radius:12px;cursor:pointer}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#08140f;font-weight:700}
    .btn.ghost{opacity:.9}
    .btn.small{padding:6px 9px;border-radius:10px}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width:760px){.grid{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid var(--ring);border-radius:16px;padding:14px;box-shadow:var(--shadow)}
    label{display:block;font-weight:600;margin:6px 0 6px;color:var(--muted)}
    input[type="text"], input[type="number"], input[type="datetime-local"], textarea, select{
      width:100%;background:#0000;border:1px solid var(--ring);color:var(--text);border-radius:12px;padding:9px 10px
    }
    textarea{min-height:92px;resize:vertical}
    .pillbar{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 14px}
    .pill{border:1px solid var(--ring);background:#0000;color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer}
    .pill.active{background:var(--brand);border-color:var(--brand);color:#08140f;font-weight:700}
    section{display:none}
    section.active{display:block}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .hint{font-size:12px;color:var(--muted)}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:rgba(127,127,127,.12);padding:2px 6px;border-radius:6px}
    .list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .item{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px solid var(--ring);border-radius:12px;padding:8px 10px;background:#00000008}
    .item .left{display:flex;flex-direction:column;gap:4px;min-width:0}
    .item .title{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .switch{display:inline-flex;align-items:center;gap:6px}
    .switch input{accent-color:var(--brand)}
    .sep{height:1px;background:var(--ring);margin:10px 0}
    .danger-text{color:var(--danger)}
    footer{margin-top:12px;display:flex;align-items:center;justify-content:space-between;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <div class="title">Emerald Content ‚Äì Mini‚ÄëApp</div>
      <span style="flex:1"></span>
      <button class="btn ghost" id="themeBtn" title="Hell/Dunkel umschalten">üåì</button>
      <button class="btn ghost" id="resetBtn">Zur√ºcksetzen</button>
      <button class="btn ghost" id="closeBtn">Schlie√üen</button>
      <button class="btn primary" id="saveBtn">Speichern</button>
    </div>

    <div class="pillbar" id="tabs">
      <button class="pill active" data-tab="welcome">Begr√º√üung</button>
      <button class="pill" data-tab="rules">Regeln</button>
      <button class="pill" data-tab="farewell">Verabschiedung</button>
      <button class="pill" data-tab="spam">Spam</button>
      <button class="pill" data-tab="rss">RSS</button>
      <button class="pill" data-tab="ai">KI</button>
      <button class="pill" data-tab="aimod">KI‚ÄëModeration</button>
      <button class="pill" data-tab="faq">FAQ</button>
      <button class="pill" data-tab="report">Report</button>
      <button class="pill" data-tab="mood">Mood</button>
      <button class="pill" data-tab="night">Nachtmodus</button>
      <button class="pill" data-tab="router">Router</button>
      <button class="pill" data-tab="more">Mehr</button>
      <button class="pill" data-tab="pro">Pro</button>
    </div>

    <!-- WELCOME -->
    <section class="card active" id="sec-welcome">
      <div class="row">
        <label class="switch"><input type="checkbox" data-key="welcome.on"> Begr√º√üung aktiv</label>
      </div>
      <label>Text</label>
      <textarea data-key="welcome.text" placeholder="Willkommen {user} üëã"></textarea>
      <div class="hint">Variablen: <span class="kbd">{user}</span>, <span class="kbd">{title}</span></div>
    </section>

    <!-- RULES -->
    <section class="card" id="sec-rules">
      <div class="row">
        <label class="switch"><input type="checkbox" data-key="rules.on"> Regeln aktiv</label>
      </div>
      <label>Text</label>
      <textarea data-key="rules.text" placeholder="Bitte beachte unsere Regeln ‚Ä¶"></textarea>
    </section>

    <!-- FAREWELL -->
    <section class="card" id="sec-farewell">
      <div class="row">
        <label class="switch"><input type="checkbox" data-key="farewell.on"> Verabschiedung aktiv</label>
      </div>
      <label>Text</label>
      <textarea data-key="farewell.text" placeholder="Tsch√ºss {user}!"></textarea>
    </section>

    <!-- SPAM -->
    <section class="card" id="sec-spam">
      <div class="grid">
        <label class="switch"><input type="checkbox" data-key="spam.on"> Spam‚ÄëFilter aktiv</label>
        <label class="switch"><input type="checkbox" data-key="spam.block_links"> Links blockieren (nur Admins)</label>
        <label class="switch"><input type="checkbox" data-key="spam.block_media"> Medien blockieren</label>
        <label class="switch"><input type="checkbox" data-key="spam.block_invite_links"> Einladungslinks l√∂schen</label>
      </div>
      <div class="grid">
        <label>Policy‚ÄëTopic (ID)
          <input type="text" data-key="spam.policy_topic" placeholder="z.B. 123" />
        </label>
        <label>Spam‚ÄëAktion
          <select data-key="spam.action" id="spam_action">
            <option value="">‚Äî</option>
            <option value="delete">L√∂schen</option>
            <option value="warn">Warnen</option>
            <option value="mute">Stummschalten</option>
          </select>
        </label>
      </div>
      <div class="grid">
        <label>Whitelist‚ÄëDomains (eine pro Zeile)
          <textarea data-key="spam.whitelist" id="spam_whitelist" placeholder="beispiel.de&#10;links.meine-seite.org"></textarea>
        </label>
        <label>Blacklist‚ÄëDomains (eine pro Zeile)
          <textarea data-key="spam.blacklist" id="spam_blacklist" placeholder="spam.xyz&#10;bad.example"></textarea>
        </label>
      </div>
      <div class="grid">
        <label>T√§gliches Limit pro Nutzer
          <input type="number" data-key="spam.per_user_daily_limit" id="spam_limit" min="0" placeholder="0 = aus">
        </label>
        <label>Quota‚ÄëNotify
          <select data-key="spam.quota_notify" id="spam_quota">
            <option value="">‚Äî</option>
            <option value="off">Aus</option>
            <option value="smart">Smart</option>
            <option value="always">Immer</option>
          </select>
        </label>
      </div>
    </section>

    <!-- RSS -->
    <section class="card" id="sec-rss">
      <div class="grid">
        <label>RSS‚ÄëFeed URL
          <input type="text" id="rss_url" placeholder="https://example.com/feed.xml"/>
        </label>
        <label>Topic (ID)
          <input type="text" id="rss_topic" placeholder="0 = Standard"/>
        </label>
      </div>
      <div class="row">
        <label class="switch"><input type="checkbox" id="rss_postimg"> Beitragsbilder posten</label>
        <label class="switch"><input type="checkbox" id="rss_enabled" checked> Feed aktivieren</label>
        <button class="btn small" id="rss_add">Hinzuf√ºgen</button>
      </div>
      <div class="sep"></div>
      <div id="rssList" class="list"></div>
      <div class="hint">Bestehende Feeds unten verwalten.</div>
    </section>

    <!-- KI (Assistent/FAQ Umschalter) -->
    <section class="card" id="sec-ai">
      <div class="row">
        <label class="switch"><input type="checkbox" data-key="ai.on"> KI/FAQ aktiv</label>
      </div>
      <label>FAQ‚ÄëHinweis / Prompt (optional)</label>
      <textarea data-key="ai.faq" placeholder="Kurzer Hinweistext f√ºr Nutzer ‚Ä¶"></textarea>
    </section>

    <!-- KI‚ÄëModeration -->
    <section class="card" id="sec-aimod">
      <div class="grid">
        <label class="switch"><input type="checkbox" data-key="ai_mod.enabled"> Aktiviert</label>
        <label class="switch"><input type="checkbox" data-key="ai_mod.shadow_mode"> Shadow‚ÄëMode (nur loggen)</label>
      </div>
      <div class="grid">
        <label>Prim√§r‚ÄëAktion
          <select data-key="ai_mod.action_primary">
            <option value="">‚Äî</option>
            <option value="delete">L√∂schen</option>
            <option value="warn">Warnen</option>
            <option value="mute">Stummschalten</option>
          </select>
        </label>
        <label>Mute‚ÄëMinuten
          <input type="number" data-key="ai_mod.mute_minutes" min="0" placeholder="0 = aus" />
        </label>
      </div>
      <div class="grid">
        <label>Warntext
          <input type="text" data-key="ai_mod.warn_text" placeholder="‚ö†Ô∏è Inhalt entfernt (KI‚ÄëModeration)."/>
        </label>
        <label>Appeal‚ÄëURL
          <input type="text" data-key="ai_mod.appeal_url" placeholder="https://‚Ä¶"/>
        </label>
      </div>
      <div class="grid">
        <label>Anfragen / Minute (Max)
          <input type="number" data-key="ai_mod.max_per_min" min="1" placeholder="20" />
        </label>
        <label>Cooldown (Sekunden)
          <input type="number" data-key="ai_mod.cooldown_s" min="0" placeholder="30" />
        </label>
      </div>
      <div class="grid">
        <label class="switch"><input type="checkbox" data-key="ai_mod.exempt_admins"> Admins ausnehmen</label>
        <label class="switch"><input type="checkbox" data-key="ai_mod.exempt_topic_owner"> Topic‚ÄëOwner ausnehmen</label>
      </div>
      <div class="sep"></div>
      <div class="grid">
        <label>Toxicity‚ÄëSchwelle
          <input type="number" step="0.01" min="0" max="1" data-key="ai_mod.toxicity" placeholder="0.90" />
        </label>
        <label>Hate‚ÄëSchwelle
          <input type="number" step="0.01" min="0" max="1" data-key="ai_mod.hate" placeholder="0.85" />
        </label>
        <label>Sexual‚ÄëSchwelle
          <input type="number" step="0.01" min="0" max="1" data-key="ai_mod.sexual" placeholder="0.90" />
        </label>
        <label>Harassment‚ÄëSchwelle
          <input type="number" step="0.01" min="0" max="1" data-key="ai_mod.harassment" placeholder="0.90" />
        </label>
        <label>Self‚ÄëHarm‚ÄëSchwelle
          <input type="number" step="0.01" min="0" max="1" data-key="ai_mod.selfharm" placeholder="0.95" />
        </label>
        <label>Violence‚ÄëSchwelle
          <input type="number" step="0.01" min="0" max="1" data-key="ai_mod.violence" placeholder="0.90" />
        </label>
      </div>
    </section>

    <!-- FAQ -->
    <section class="card" id="sec-faq">
      <div class="grid">
        <label>Frage
          <input type="text" id="faq_q" placeholder="Deine Frage ‚Ä¶" />
        </label>
        <label>Antwort
          <input type="text" id="faq_a" placeholder="Kurze Antwort ‚Ä¶" />
        </label>
      </div>
      <div class="row">
        <button class="btn small" id="faq_add">Hinzuf√ºgen</button>
      </div>
      <div class="sep"></div>
      <div id="faqList" class="list"></div>
    </section>

    <!-- REPORT -->
    <section class="card" id="sec-report">
      <div class="row">
        <label class="switch"><input type="checkbox" data-key="daily_stats"> T√§glichen Report per PM senden</label>
      </div>
    </section>

    <!-- MOOD -->
    <section class="card" id="sec-mood">
      <div class="grid">
        <label>Frage (Stimmungsumfrage)
          <input type="text" data-key="mood.question" placeholder="Wie ist deine Stimmung heute?" />
        </label>
        <label>Topic (ID)
          <input type="text" data-key="mood.topic" placeholder="0 = Standard" />
        </label>
      </div>
    </section>

    <!-- NIGHT MODE -->
    <section class="card" id="sec-night">
      <div class="grid">
        <label class="switch"><input type="checkbox" data-key="night.on"> Nachtmodus aktiv</label>
        <label>Start (HH:MM)
          <input type="text" data-key="night.start" placeholder="22:00" />
        </label>
        <label>Ende (HH:MM)
          <input type="text" data-key="night.end" placeholder="07:00" />
        </label>
      </div>
      <div class="grid">
        <label class="switch"><input type="checkbox" data-key="night.delete_non_admin_msgs"> Nicht‚ÄëAdmin‚ÄëNachrichten l√∂schen</label>
        <label class="switch"><input type="checkbox" data-key="night.warn_once"> Einmalige Warnung anzeigen</label>
        <label>Zeitzone
          <input type="text" data-key="night.timezone" placeholder="Europe/Berlin" />
        </label>
        <label class="switch"><input type="checkbox" data-key="night.hard_mode"> Hard‚ÄëMode</label>
      </div>
      <div class="grid">
        <label>Tempor√§r bis (Override)
          <input type="datetime-local" data-key="night.override_until" />
        </label>
      </div>
    </section>

    <!-- TOPIC ROUTER -->
    <section class="card" id="sec-router">
      <div class="grid">
        <label>Ziel‚ÄëTopic (ID)
          <input type="text" id="router_target" placeholder="Topic ID" />
        </label>
        <label>Keywords (Komma getrennt)
          <input type="text" id="router_keywords" placeholder="hilfe, frage, support" />
        </label>
        <label>Domains (Komma getrennt)
          <input type="text" id="router_domains" placeholder="example.com, foo.bar" />
        </label>
      </div>
      <div class="row">
        <label class="switch"><input type="checkbox" id="router_delete" checked> Original l√∂schen</label>
        <label class="switch"><input type="checkbox" id="router_warn" checked> Nutzer warnen</label>
        <button class="btn small" id="router_add">Regel anlegen</button>
      </div>
      <div class="sep"></div>
      <div id="routerList" class="list"></div>
    </section>

    <!-- MORE -->
    <section class="card" id="sec-more">
      <div class="row">
        <label>Sprache
          <select data-key="language">
            <option value="">Automatisch</option>
            <option value="de">Deutsch</option>
            <option value="en">English</option>
            <option value="fr">Fran√ßais</option>
            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
          </select>
        </label>
      </div>
    </section>

    <!-- PRO -->
    <section class="card" id="sec-pro">
      <div class="row">
        <label>Pro‚ÄëMonate kaufen/verl√§ngern
          <input type="number" id="pro_months" min="1" placeholder="z.B. 1" />
        </label>
        <button class="btn small" id="pro_buy">Abo setzen</button>
      </div>
    </section>

    <footer>
      <div id="out" class="hint">Bereit.</div>
      <div class="hint">¬© Emerald Content</div>
    </footer>
  </div>

  <script>
    // --- Helpers ---
    const qs=(s,el=document)=>el.querySelector(s);
    const qa=(s,el=document)=>Array.from(el.querySelectorAll(s));
    const getUrlParam=(k, def=null)=> new URL(location.href).searchParams.get(k) ?? def;

    // Telegram Context
    const tg = window.Telegram?.WebApp || null;
    const uid = parseInt(getUrlParam("uid")||tg?.initDataUnsafe?.user?.id||0);
    const cid = parseInt(getUrlParam("cid")||0);
    const API_BASE = getUrlParam("api","") || ""; // z.B. /miniapp

    // Theme
    const themeKey = "emerald-theme";
    const currentTheme = localStorage.getItem(themeKey) || "dark";
    document.documentElement.setAttribute("data-theme", currentTheme);
    qs("#themeBtn").onclick=()=>{
      const cur = document.documentElement.getAttribute("data-theme")||"dark";
      const next = cur==="dark"?"light":"dark";
      document.documentElement.setAttribute("data-theme", next);
      localStorage.setItem(themeKey, next);
    };

    // Tabs
    qa('#tabs .pill').forEach(p=>p.addEventListener('click',()=>{
      qa('#tabs .pill').forEach(x=>x.classList.remove('active'));
      p.classList.add('active');
      qa('section').forEach(s=>s.classList.remove('active'));
      qs('#sec-'+p.dataset.tab).classList.add('active');
    }));

    // Events
    qs('#closeBtn').onclick=()=>{ try{ tg.close(); }catch{ window.close(); } };
    qs('#resetBtn').onclick=()=>loadState();
    qs('#saveBtn').onclick=()=>sendPayload();

    // RSS Ops
    qs('#rss_add').onclick=()=>{
      const url = qs('#rss_url').value.trim();
      if(!url) return;
      const topic = parseInt(qs('#rss_topic').value.trim()||'0');
      sendPayload({ rss: { url, topic, post_images: qs('#rss_postimg').checked, enabled: qs('#rss_enabled').checked } });
    };

    // FAQ Ops
    qs('#faq_add').onclick=()=>{
      const q = qs('#faq_q').value.trim();
      const a = qs('#faq_a').value.trim();
      if(!q) return;
      sendPayload({ faq_add: { q, a } });
    };

    // Router Ops
    qs('#router_add').onclick=()=>{
      const target = parseInt(qs('#router_target').value.trim()||'0');
      if(!target) return;
      const kw = qs('#router_keywords').value.split(',').map(s=>s.trim()).filter(Boolean);
      const dom = qs('#router_domains').value.split(',').map(s=>s.trim()).filter(Boolean);
      sendPayload({ router_add: { target_topic_id: target, keywords: kw, domains: dom, delete_original: qs('#router_delete').checked, warn_user: qs('#router_warn').checked } });
    };

    // Pro
    qs('#pro_buy').onclick=()=>{
      const months = parseInt(qs('#pro_months').value||'0');
      if(months>0) sendPayload({ pro_months: months });
    };

    // Collect ‚Üí nested object per data-key path
    function setVal(path, val){
      const el = qa(`[data-key="${path}"]`)[0];
      if(!el) return;
      if(el.type==='checkbox') el.checked = !!val; else el.value = (val ?? '')
    }
    function collect(){
      const out = {};
      qa('[data-key]').forEach(el=>{
        const path = el.getAttribute('data-key');
        const parts = path.split('.');
        let cur = out;
        for(let i=0;i<parts.length-1;i++){
          if(!(parts[i] in cur)) cur[parts[i]]={};
          cur=cur[parts[i]];
        }
        const leaf = parts[parts.length-1];
        let val = (el.type==='checkbox') ? !!el.checked : el.value;
        if(el.type==='number') val = el.value===''? '': (Number(el.value));
        cur[leaf]=val;
      });
      return out;
    }

    // Render helper
    function renderRss(feeds){
      const box = qs('#rssList'); box.innerHTML='';
      (feeds||[]).forEach(f=>{
        const item = document.createElement('div'); item.className='item';
        const left = document.createElement('div'); left.className='left';
        left.innerHTML = `<div class="title">${f.url}</div><div class="hint">Topic: ${f.topic ?? 0}</div>`;
        const right = document.createElement('div');
        right.innerHTML = `
          <label class="switch"><input type="checkbox" ${f.enabled? 'checked':''} data-url="${f.url}" class="rss-toggle"> Aktiv</label>
          <label class="switch"><input type="checkbox" ${f.post_images? 'checked':''} data-url="${f.url}" class="rss-img"> Bilder</label>
          <button class="btn small danger rss-del" data-url="${f.url}">L√∂schen</button>`;
        item.append(left,right); box.append(item);
      });
      qa('.rss-del', box).forEach(b=>b.onclick=()=>sendPayload({ rss_del: b.dataset.url }));
      qa('.rss-toggle', box).forEach(ch=>ch.onchange=()=>sendPayload({ rss_update: { url: ch.dataset.url, enabled: ch.checked } }));
      qa('.rss-img', box).forEach(ch=>ch.onchange=()=>sendPayload({ rss_update: { url: ch.dataset.url, post_images: ch.checked } }));
    }
    function renderFaq(list){
      const box = qs('#faqList'); box.innerHTML='';
      (list||[]).forEach(f=>{
        const item = document.createElement('div'); item.className='item';
        const left = document.createElement('div'); left.className='left';
        left.innerHTML = `<div class="title">${f.q}</div><div class="hint">${f.a||''}</div>`;
        const del = document.createElement('button'); del.className='btn small danger'; del.textContent='L√∂schen';
        del.onclick=()=>sendPayload({ faq_del: { q: f.q } });
        item.append(left, del); box.append(item);
      });
    }
    function renderRouter(list){
      const box = qs('#routerList'); box.innerHTML='';
      (list||[]).forEach(r=>{
        const item = document.createElement('div'); item.className='item';
        const left = document.createElement('div'); left.className='left';
        left.innerHTML = `<div class="title">Rule #${r.rule_id} ‚Üí Topic ${r.target_topic_id}</div><div class="hint">${(r.keywords||[]).join(', ')} ${(r.domains||[]).join(', ')}</div>`;
        const right = document.createElement('div'); right.className='right';
        right.innerHTML = `<span class="hint">${r.enabled? 'aktiv':'inaktiv'}</span>`;
        item.append(left,right); box.append(item);
      });
    }

    // Load state
    async function loadState(){
      qs('#out').textContent='Lade ‚Ä¶';
      try{
        const res = await fetch(`${API_BASE}/miniapp/state?cid=${cid}`);
        const j = await res.json();
        // Welcome/Rules/Farewell
        setVal('welcome.on', j.welcome?.on);
        setVal('welcome.text', j.welcome?.text);
        setVal('rules.on', j.rules?.on); setVal('rules.text', j.rules?.text);
        setVal('farewell.on', j.farewell?.on); setVal('farewell.text', j.farewell?.text);
        // Spam (inkl. Fallbacks)
        setVal('spam.on', j.spam?.on ?? j.links?.only_admin_links ?? false);
        setVal('spam.block_links', j.spam?.block_links ?? j.links?.only_admin_links ?? false);
        setVal('spam.block_media', j.spam?.block_media ?? false);
        setVal('spam.block_invite_links', j.spam?.block_invite_links ?? false);
        setVal('spam.policy_topic', j.spam?.policy_topic ?? 0);
        if(Array.isArray(j.spam?.whitelist)) qs('#spam_whitelist').value=(j.spam.whitelist||[]).join('\n');
        if(Array.isArray(j.spam?.blacklist)) qs('#spam_blacklist').value=(j.spam.blacklist||[]).join('\n');
        setVal('spam.action', j.spam?.action ?? '');
        setVal('spam.per_user_daily_limit', j.spam?.per_user_daily_limit ?? 0);
        setVal('spam.quota_notify', j.spam?.quota_notify ?? '');
        // RSS
        renderRss(j.rss?.feeds||[]);
        // AI
        setVal('ai.on', j.ai?.on ?? (j.ai?.faq || j.ai?.rss));
        setVal('ai.faq', j.ai?.faq ?? '');
        // AIMOD
        const am = j.aimod||{};
        setVal('ai_mod.enabled', am.enabled);
        setVal('ai_mod.shadow_mode', am.shadow_mode);
        setVal('ai_mod.action_primary', am.action_primary);
        setVal('ai_mod.mute_minutes', am.mute_minutes);
        setVal('ai_mod.warn_text', am.warn_text);
        setVal('ai_mod.appeal_url', am.appeal_url);
        setVal('ai_mod.max_per_min', am.max_calls_per_min);
        setVal('ai_mod.cooldown_s', am.cooldown_s);
        setVal('ai_mod.exempt_admins', am.exempt_admins);
        setVal('ai_mod.exempt_topic_owner', am.exempt_topic_owner);
        setVal('ai_mod.toxicity', am.toxicity ?? am.tox_thresh);
        setVal('ai_mod.hate', am.hate ?? am.hate_thresh);
        setVal('ai_mod.sexual', am.sexual ?? am.sex_thresh);
        setVal('ai_mod.harassment', am.harassment ?? am.harass_thresh);
        setVal('ai_mod.selfharm', am.selfharm ?? am.selfharm_thresh);
        setVal('ai_mod.violence', am.violence ?? am.violence_thresh);
        // FAQ & Router
        renderFaq(j.faqs||[]);
        renderRouter(j.router_rules||[]);
        // Mood
        setVal('mood.question', j.mood?.question);
        setVal('mood.topic', j.mood?.topic);
        // Night
        const n=j.night||{}; setVal('night.on', n.enabled); setVal('night.start', n.start||'22:00'); setVal('night.end', n.end||'07:00');
        setVal('night.delete_non_admin_msgs', n.delete_non_admin_msgs);
        setVal('night.warn_once', n.warn_once);
        setVal('night.timezone', n.timezone||'Europe/Berlin');
        setVal('night.hard_mode', n.hard_mode);
        // More
        setVal('language', j.language||'');
        qs('#out').textContent='Bereit.';
      }catch(e){
        console.error(e); qs('#out').textContent='Fehler beim Laden.';
      }
    }

    function sendPayload(extra={}){
      const out = collect();
      Object.assign(out, { cid, uid }, extra);
      if (tg && tg.sendData){
        try{ tg.HapticFeedback?.impactOccurred?.('medium'); }catch{}
        tg.sendData(JSON.stringify(out));
        qs('#out').textContent = 'Gesendet.';
      } else {
        qs('#out').textContent = 'Nicht in Telegram ge√∂ffnet ‚Äì Speichern nicht m√∂glich.';
        console.warn('Mini‚ÄëApp nicht in Telegram ge√∂ffnet.');
      }
    }

    loadState();
  </script>
</body>
</html>
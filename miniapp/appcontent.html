<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Emerald Content Bot ‚Äì Mini-App</title>
  <style>
    :root{
      --bg:#0b0f13;--panel:#141b22;--fg:#e8f0f7;--muted:#9fb0bf;
      --accent:#22c55e;--accent-2:#16a34a;--border:#1f2a38;
    }
    html,body{height:100%;margin:0;background:#000;color:var(--fg);
      font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{min-height:100%;background:linear-gradient(180deg,#030507 0%, #0a1219 60%, #0b0f13 100%)}
    header{padding:20px 16px 0}
    h1{margin:0 0 4px;font-size:22px;color:#8ff2ba;font-weight:800;letter-spacing:.5px}
    .sub{color:var(--muted);margin-bottom:16px}
    .toolbar{display:flex;gap:8px;align-items:center;margin:6px 16px 12px}
    .btn{border:none;border-radius:12px;padding:10px 14px;background:#1d2630;color:#eaf3ff;cursor:pointer}
    .btn.primary{background:var(--accent);color:#08130b;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid #233041}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .badge{display:inline-flex;gap:8px;align-items:center;background:#111824;border:1px solid var(--border);
      border-radius:999px;padding:6px 10px;color:#b2c6d9}
    .container{padding:0 16px 24px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px}
    .grid{display:grid;gap:10px}
    .group-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;background:#0f1620;border:1px solid #1b2633}
    .group-item .title{font-weight:700}
    .hidden{display:none}
    .tabs{display:flex;gap:8px;margin:8px 0 12px;flex-wrap:wrap}
    .tabbtn{background:#0f1620;border:1px solid #1b2633;color:#cfe3f7;border-radius:12px;padding:8px 12px;cursor:pointer}
    .tabbtn.active{background:#1a2430;border-color:#2b394b}
    .tab{display:none}
    .tab.active{display:block}
    .row{display:grid;gap:10px}
    label{display:block;color:#b7cadc;margin:6px 0 4px}
    input,select,textarea{width:100%;background:#0c131b;border:1px solid #203044;border-radius:10px;color:#eaf3ff;padding:10px}
    textarea{resize:vertical}
    .muted{color:#8aa3ba}
    .footer{height:18px}
    .inline{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .inline>*{flex:1 1 180px}
    img.preview{max-width:100%;border-radius:10px;border:1px solid #203044}
    .section-title{font-weight:800;margin:8px 0 4px;color:#cfe3f7}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Emerald Content Bot</h1>
    <div class="sub">Verwalte deine Gruppen-Einstellungen</div>
  </header>

  <div class="toolbar">
    <button id="backBtn" class="btn ghost hidden">‚Üê Zur√ºck</button>
    <span id="statusBadge" class="badge">Bereit.</span>
    <div style="flex:1"></div>
    <button id="resetBtn" class="btn ghost">Zur√ºcksetzen</button>
    <button id="closeBtn" class="btn ghost">Schlie√üen</button>
    <button id="saveBtn" class="btn primary" disabled>Speichern</button>
  </div>

  <div class="container">

    <!-- Startseite: Gruppenauswahl -->
    <section id="startPage" class="grid">
      <div class="panel">
        <label for="groupSelect">Gruppe w√§hlen ‚Ä¶</label>
        <select id="groupSelect"></select>
      </div>

      <div class="panel">
        <div id="groupList" class="grid"></div>
      </div>
    </section>

    <!-- Hauptmen√º / Content -->
    <section id="contentArea" class="hidden grid">
      <div class="panel">
        <div class="tabs" id="tabs">
          <button class="tabbtn active" data-tab="welcome">Begr√º√üung</button>
          <button class="tabbtn" data-tab="rules">Regeln</button>
          <button class="tabbtn" data-tab="farewell">Verabschiedung</button>
          <button class="tabbtn" data-tab="spam">Spam</button>
          <button class="tabbtn" data-tab="rss">RSS</button>
          <button class="tabbtn" data-tab="ai">KI</button>
          <button class="tabbtn" data-tab="ai_mod">KI-Moderation</button>
          <button class="tabbtn" data-tab="faq">FAQ</button>
          <button class="tabbtn" data-tab="report">Report</button>
          <button class="tabbtn" data-tab="stats">Statistik</button>
          <button class="tabbtn" data-tab="mood">Mood</button>
          <button class="tabbtn" data-tab="night">Nachtmodus</button>
          <button class="tabbtn" data-tab="router">Router</button>
          <button class="tabbtn" data-tab="more">Mehr</button>
          <button class="tabbtn" data-tab="pro">Pro</button>
          <button class="tabbtn" data-tab="rewards">Rewards</button>
        </div>

        <!-- Welcome -->
        <div id="tab-welcome" class="tab active">
          <div class="row">
            <label><input type="checkbox" id="welcome_enabled"> Begr√º√üung aktiv</label>
            <label>Bild (optional)
              <input type="file" id="welcome_img" accept="image/*">
            </label>
            <img id="welcome_preview" class="preview"/>
            <label>Text
              <textarea id="welcome_text" rows="4" placeholder="Willkommen {user} ‚ú®"></textarea>
            </label>
            <div class="section-title">Captcha</div>
            <label><input type="checkbox" id="welcome_captcha"> Captcha aktivieren</label>
            <label>Modus
              <select id="welcome_captcha_mode">
                <option value="math">Matheaufgabe</option>
                <option value="click">Klick-Best√§tigung</option>
              </select>
            </label>
            <button id="welcome_test" class="btn ghost">Test senden</button>
          </div>
        </div>

        <!-- Rules -->
        <div id="tab-rules" class="tab">
          <div class="row">
            <label><input type="checkbox" id="rules_enabled"> Regeln senden</label>
            <label>Bild (optional)
              <input type="file" id="rules_img" accept="image/*">
            </label>
            <img id="rules_preview" class="preview"/>
            <label>Text
              <textarea id="rules_text" rows="4" placeholder="Regeln ‚Ä¶"></textarea>
            </label>
            <button id="rules_test" class="btn ghost">Test senden</button>
          </div>
        </div>

        <!-- Farewell -->
        <div id="tab-farewell" class="tab">
          <div class="row">
            <label><input type="checkbox" id="farewell_enabled"> Verabschiedung aktiv</label>
            <label>Bild (optional)
              <input type="file" id="farewell_img" accept="image/*">
            </label>
            <img id="farewell_preview" class="preview"/>
            <label>Text
              <textarea id="farewell_text" rows="3" placeholder="Schade, dass du gehst ‚Ä¶"></textarea>
            </label>
            <button id="farewell_test" class="btn ghost">Test senden</button>
          </div>
        </div>

        <!-- Spam -->
        <div id="tab-spam" class="tab">
          <div class="row">
            <label><input type="checkbox" id="spam_enabled"> Spam-Schutz aktiv</label>
            <div class="inline">
              <label>Ban nach (Verst√∂√üen) <input id="spam_ban_after" type="number" min="0" value="3"></label>
              <label>Mute (Minuten) <input id="spam_mute_min" type="number" min="0" value="10"></label>
              <label>Links
                <select id="spam_link_mode">
                  <option value="allow">Erlauben</option>
                  <option value="only_admin">Nur Admin-Links</option>
                  <option value="block_all">Alle blocken</option>
                </select>
              </label>
            </div>
          </div>
        </div>

        <!-- RSS -->
        <div id="tab-rss" class="tab">
          <div class="row">
            <label>Feed-URL <input id="rss_url" placeholder="https://‚Ä¶/feed"></label>
            <div class="inline">
              <label>Topic-ID <input id="rss_topic" type="number" min="0" placeholder="0 = Hauptchat"></label>
              <label><input type="checkbox" id="rss_postimg"> Bilder mitsenden</label>
              <label><input type="checkbox" id="rss_enabled"> RSS aktiv</label>
            </div>
            <div class="inline">
              <button id="rss_add" class="btn">Hinzuf√ºgen</button>
              <button id="rss_check" class="btn ghost">Jetzt pr√ºfen</button>
            </div>
            <div id="rss_list" class="panel" style="margin-top:10px"></div>
          </div>
        </div>

        <!-- KI -->
        <div id="tab-ai" class="tab">
          <div class="row">
            <label><input type="checkbox" id="ai_enabled"> KI Antworten aktiv</label>
            <div class="inline">
              <label>Modell <input id="ai_model" placeholder="gpt-‚Ä¶ / llama-‚Ä¶"></label>
              <label>Temperature <input id="ai_temp" type="number" min="0" max="2" step="0.1" value="0.7"></label>
              <label>Sprache <input id="ai_lang" value="de"></label>
            </div>
            <label>Systemprompt <textarea id="ai_system" rows="3" placeholder="Rollen-/Systemanweisungen ‚Ä¶"></textarea></label>
          </div>
        </div>

        <!-- KI-Moderation -->
        <div id="tab-ai_mod" class="tab">
          <div class="row">
            <label><input type="checkbox" id="aimod_enabled"> KI-Moderation aktiv</label>
            <div class="inline">
              <label><input type="checkbox" id="aimod_shadow"> Shadow-Mode (nur loggen)</label>
              <label><input type="checkbox" id="aimod_ex_admins"> Admins ausnehmen</label>
              <label><input type="checkbox" id="aimod_ex_topic"> Topic-Owner ausnehmen</label>
            </div>
          </div>
        </div>

        <!-- FAQ -->
        <div id="tab-faq" class="tab">
          <div class="row">
            <label>Frage <input id="faq_q"></label>
            <label>Antwort <textarea id="faq_a" rows="3"></textarea></label>
            <button id="faq_add" class="btn">Speichern</button>
            <div id="faq_list" class="panel" style="margin-top:10px"></div>
          </div>
        </div>

        <!-- Report -->
        <div id="tab-report" class="tab">
          <div class="row">
            <label><input type="checkbox" id="report_enabled"> Report aktiv</label>
            <div class="inline">
              <label>Topic-ID <input id="report_topic" type="number" min="0"></label>
              <label><input type="checkbox" id="report_dm"> zus√§tzlich per DM</label>
            </div>
            <button id="report_now" class="btn ghost">Jetzt senden</button>
          </div>
        </div>

        <!-- Statistik -->
        <div id="tab-stats" class="tab">
          <div class="row">
            <label>Zeitraum
              <select id="stats_days">
                <option value="7">7 Tage (Free)</option>
                <option value="14" selected>14 Tage (Free)</option>
                <option value="30">30 Tage (Pro)</option>
                <option value="60">60 Tage (Pro)</option>
              </select>
            </label>
            <div id="stats_out" class="panel">‚Äî</div>
          </div>
        </div>

        <!-- Mood -->
        <div id="tab-mood" class="tab">
          <div class="row">
            <label><input type="checkbox" id="mood_enabled"> Mood aktiv</label>
            <label>Topic-ID <input id="mood_topic" type="number" min="0"></label>
            <button id="mood_now" class="btn ghost">Jetzt senden</button>
          </div>
        </div>

        <!-- Nachtmodus -->
        <div id="tab-night" class="tab">
          <div class="row">
            <label><input type="checkbox" id="night_enabled"> Nachtmodus aktiv</label>
            <div class="inline">
              <label>Start (HH:MM) <input id="night_start" placeholder="22:00"></label>
              <label>Ende (HH:MM) <input id="night_end" placeholder="06:00"></label>
              <label><input type="checkbox" id="night_slow"> nur Slowmode setzen</label>
            </div>
          </div>
        </div>

        <!-- Router -->
        <div id="tab-router" class="tab">
          <div class="row">
            <div class="inline">
              <label>Ziel-Topic-ID <input id="router_target" type="number" min="0"></label>
              <label><input type="checkbox" id="router_enabled"> Router aktiv</label>
            </div>
            <label>Keywords (Komma) <input id="router_keywords" placeholder="trade, ta, signal"></label>
            <label>Domains (Komma) <input id="router_domains" placeholder="example.com, reddit.com"></label>
            <div class="inline">
              <label><input type="checkbox" id="router_delete"> Original l√∂schen</label>
              <label><input type="checkbox" id="router_warn"> User warnen</label>
            </div>
            <button id="router_add" class="btn">Regel hinzuf√ºgen</button>
            <div id="router_rules" class="panel" style="margin-top:10px"></div>
          </div>
        </div>

        <!-- Mehr -->
        <div id="tab-more" class="tab">
          <div class="row">
            <label>Bild-Weiterleitung Topic <input id="images_forward_topic" type="number" min="0"></label>
          </div>
        </div>

        <!-- Pro -->
        <div id="tab-pro" class="tab">
          <div class="row">
            <p>Pro schaltet 30/60-Tage-Statistik und Multi-API frei.</p>
            <div class="inline">
              <label>Monate <input id="pro_months" type="number" min="1" value="1"></label>
              <button id="pro_buy" class="btn">Pro anfragen</button>
            </div>
          </div>
        </div>

        <!-- Rewards (global) -->
        <div id="tab-rewards" class="tab">
          <div class="row">
            <div class="inline">
              <label>Claim-Modus
                <select id="rw_claim">
                  <option value="owner_only">Nur Owner</option>
                  <option value="admins">Owner + Admins</option>
                  <option value="members">Alle Mitglieder</option>
                </select>
              </label>
              <label>Punkte pro Antwort
                <input type="number" id="rw_per_reply" min="0" step="1" value="1"/>
              </label>
            </div>
          </div>
        </div>

      </div>
    </section>

    <div class="footer"></div>
  </div>
</div>

<script>
/* ================== Konfig & Utilities ================== */
const API_BASE = (window.EC_API_BASE || 'https://emeraldcontent-aac379fc581e.herokuapp.com').replace(/\/+$/,'');
const INIT_DATA = (window.Telegram?.WebApp?.initData || '').trim();
const qs = s => document.querySelector(s);
const qa = s => Array.from(document.querySelectorAll(s));
const getUrlParam = k => new URL(location.href).searchParams.get(k);
let cid = parseInt(getUrlParam('cid') || '0', 10) || 0;
let STATE_READY = false;

function setStatus(msg){ qs('#statusBadge').textContent = msg; }
function pickTab(name){
  qa('.tabbtn').forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
  qa('.tab').forEach(t=>t.classList.toggle('active', t.id===`tab-${name}`));
}
function showContentArea(groupId){
  qs('#startPage').classList.add('hidden');
  const area = qs('#contentArea');
  area.classList.remove('hidden');
  qs('#backBtn').classList.remove('hidden');
  qs('#saveBtn').disabled = false;
  if (groupId){ cid = Number(groupId); const sel = qs('#groupSelect'); if (sel) sel.value = String(cid); }
}
function showStartPage(){
  qs('#contentArea').classList.add('hidden');
  qs('#startPage').classList.remove('hidden');
  qs('#backBtn').classList.add('hidden');
  qs('#saveBtn').disabled = true;
}
function setPreview(imgEl, fileIdOrUrl){
  if (!imgEl) return;
  if (!fileIdOrUrl){ imgEl.removeAttribute('src'); return; }
  const url = fileIdOrUrl.startsWith?.('http')
    ? fileIdOrUrl
    : `${API_BASE}/miniapp/file?file_id=${encodeURIComponent(fileIdOrUrl)}`;
  imgEl.src = url;
}
function fileToBase64(input){
  return new Promise(resolve=>{
    const f = input?.files?.[0]; if(!f) return resolve(null);
    const r = new FileReader();
    r.onload = () => resolve(String(r.result));
    r.onerror = () => resolve(null);
    r.readAsDataURL(f);
  });
}

/* ================== Tabs & Toolbar ================== */
qs('#tabs').addEventListener('click', (e)=>{
  const b = e.target.closest('.tabbtn'); if(!b) return;
  pickTab(b.dataset.tab);
});
qs('#backBtn').addEventListener('click', ()=>{ showStartPage(); setStatus('Bereit.'); });
qs('#closeBtn').addEventListener('click', ()=>{ try{ window.Telegram?.WebApp?.close(); }catch{} });
qs('#resetBtn').addEventListener('click', ()=>{ location.reload(); });
qs('#saveBtn').addEventListener('click', onSave);

/* ================== Gruppen laden ================== */
async function loadGroups(){
  setStatus('‚è≥ Lade Gruppenliste ‚Ä¶');
  const list = qs('#groupList');
  const sel  = qs('#groupSelect');
  list.innerHTML = '';
  sel.innerHTML = '<option value="">Gruppe w√§hlen‚Ä¶</option>';

  const headers = { 'Content-Type':'application/json' };
  if (INIT_DATA) headers['X-Telegram-Init-Data'] = INIT_DATA;

  const r = await fetch(`${API_BASE}/miniapp/groups`, { headers });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  const data = await r.json();
  const groups = data.groups || [];

  sel.innerHTML = '<option value="">Gruppe w√§hlen‚Ä¶</option>' +
    groups.map(g=>`<option value="${g.id}">${g.title || g.id}</option>`).join('');
  if (cid) sel.value = String(cid);
  sel.onchange = ()=>{ if (sel.value){ showContentArea(sel.value); loadState(); } };

  list.innerHTML = groups.map(g => `
    <div class="group-item" data-id="${g.id}">
      <div>
        <div class="title">${g.title || g.id}</div>
        <div class="muted">Telegram-Gruppe</div>
      </div>
      <button class="btn primary">Verwalten</button>
    </div>
  `).join('');

  qa('.group-item .btn').forEach(btn=>{
    btn.onclick = ()=>{
      const gid = btn.closest('.group-item').dataset.id;
      showContentArea(gid); loadState();
    };
  });

  setStatus('Bereit.');
}

/* ================== State laden ================== */
async function loadState(){
  if (!cid){ setStatus('Bitte Gruppe w√§hlen.'); return; }
  setStatus('‚è≥ Lade ‚Ä¶');
  const headers = { 'Content-Type':'application/json' };
  if (INIT_DATA) headers['X-Telegram-Init-Data'] = INIT_DATA;

  const r = await fetch(`${API_BASE}/miniapp/state?cid=${encodeURIComponent(cid)}`, { headers });
  if (!r.ok){ setStatus('Fehler beim Laden.'); return; }
  const s = await r.json();

  // Welcome
  qs('#welcome_enabled').checked = !!s.welcome?.enabled;
  qs('#welcome_text').value      = (s.welcome?.text ?? '');
  setPreview(qs('#welcome_preview'), s.welcome?.image_url || s.welcome?.photo_id);
  qs('#welcome_captcha').checked    = !!s.welcome?.captcha?.enabled;
  qs('#welcome_captcha_mode').value = s.welcome?.captcha?.mode ?? 'math';

  // Rules
  qs('#rules_enabled').checked = !!s.rules?.enabled;
  qs('#rules_text').value      = (s.rules?.text ?? '');
  setPreview(qs('#rules_preview'), s.rules?.image_url || s.rules?.photo_id);

  // Farewell
  qs('#farewell_enabled').checked = !!s.farewell?.enabled;
  qs('#farewell_text').value      = (s.farewell?.text ?? '');
  setPreview(qs('#farewell_preview'), s.farewell?.image_url || s.farewell?.photo_id);

  // Spam
  qs('#spam_enabled').checked = !!s.spam?.enabled;
  qs('#spam_ban_after').value = s.spam?.ban_after ?? 3;
  qs('#spam_mute_min').value  = s.spam?.mute_minutes ?? 10;
  qs('#spam_link_mode').value = s.spam?.link_block_mode ?? 'allow';

  // RSS
  qs('#rss_enabled').checked = !!s.rss?.enabled;
  const rl = qs('#rss_list');
  rl.innerHTML = (s.rss?.list || []).map(f => `
    <div class="group-item" data-url="${f.url}">
      <div><div class="title">${f.url}</div><div class="muted">Topic: ${f.topic ?? 0}</div></div>
      <button class="btn ghost rss-del">L√∂schen</button>
    </div>`).join('');
  qa('.rss-del').forEach(b => b.onclick = () => sendPayload({ rss_del: { url: b.closest('.group-item').dataset.url } }));

  // KI
  qs('#ai_enabled').checked = !!s.ai?.enabled;
  qs('#ai_model').value     = s.ai?.model ?? '';
  qs('#ai_temp').value      = s.ai?.temp ?? 0.7;
  qs('#ai_lang').value      = s.ai?.lang ?? 'de';
  qs('#ai_system').value    = s.ai?.system ?? '';

  // KI-Moderation
  qs('#aimod_enabled').checked   = !!s.ai_mod?.enabled;
  qs('#aimod_shadow').checked    = !!s.ai_mod?.shadow_mode;
  qs('#aimod_ex_admins').checked = !!s.ai_mod?.exempt_admins;
  qs('#aimod_ex_topic').checked  = !!s.ai_mod?.exempt_topic_owner;

  // FAQ
  qs('#faq_list').innerHTML = (s.faq?.items || []).map(x => `
    <div class="group-item" data-id="${x.id}">
      <div><div class="title">${x.q}</div><div class="muted">${x.a}</div></div>
      <button class="btn ghost faq-del">L√∂schen</button>
    </div>`).join('');
  qa('.faq-del').forEach(b => b.onclick = () => sendPayload({ faq_del: { id: b.closest('.group-item').dataset.id } }));

  // Report
  qs('#report_enabled').checked = !!s.report?.enabled;
  qs('#report_topic').value     = s.report?.topic_id ?? 0;
  qs('#report_dm').checked      = !!s.report?.send_dm;

  // Stats (lazy via loadStats)
  qs('#stats_out').innerHTML = s.stats?.html ?? '‚Äî';

  // Mood
  qs('#mood_enabled').checked = !!s.mood?.enabled;
  qs('#mood_topic').value     = s.mood?.topic_id ?? 0;

  // Night
  qs('#night_enabled').checked = !!s.night?.enabled;
  qs('#night_start').value     = s.night?.start ?? '22:00';
  qs('#night_end').value       = s.night?.end ?? '06:00';
  qs('#night_slow').checked    = !!s.night?.only_slowmode;

  // Router
  qs('#router_enabled').checked = !!s.router?.enabled;
  qs('#router_rules').innerHTML = (s.router?.rules || []).map(r => `
    <div class="group-item">
      <div>
        <div class="title">‚Üí ${r.target_topic_id}</div>
        <div class="muted">KW: ${(r.keywords||[]).join(', ')} | Domains: ${(r.domains||[]).join(', ')}</div>
      </div>
    </div>`).join('');

  // Mehr
  qs('#images_forward_topic').value = s.images?.forward_to_topic ?? 0;

  // Rewards
  qs('#rw_claim').value     = (s.rewards?.claim_mode ?? 'owner_only');
  qs('#rw_per_reply').value = (s.rewards?.points_per_reply ?? 1);

  STATE_READY = true;
  setStatus('Bereit.');
}

/* ================== Einmalige Action-Handler ================== */
qs('#welcome_test')?.addEventListener('click', ()=>sendPayload({ welcome_test:true }));
qs('#rules_test')?.addEventListener('click', ()=>sendPayload({ rules_test:true }));
qs('#farewell_test')?.addEventListener('click', ()=>sendPayload({ farewell_test:true }));

qs('#rss_add')?.addEventListener('click', ()=>{
  const url   = qs('#rss_url').value.trim(); if(!url) return;
  const topic = parseInt(qs('#rss_topic').value||'0',10);
  sendPayload({ rss_add:{ url, topic, post_images: qs('#rss_postimg').checked, enabled: qs('#rss_enabled').checked } });
});
qs('#rss_check')?.addEventListener('click', ()=>sendPayload({ rss_check:true }));

qs('#faq_add')?.addEventListener('click', ()=>{
  const q = qs('#faq_q').value.trim(), a = qs('#faq_a').value.trim();
  if (!q || !a) return;
  sendPayload({ faq_add:{ q, a } });
});

qs('#report_now')?.addEventListener('click', ()=>sendPayload({ report_send_now:true }));
qs('#mood_now')?.addEventListener('click', ()=>sendPayload({ mood_send_now:true }));

qs('#stats_days')?.addEventListener('change', ()=>loadStats(parseInt(qs('#stats_days').value,10)||14));

qs('#router_add')?.addEventListener('click', ()=>{
  const tgt = parseInt(qs('#router_target').value||'0',10);
  const kw  = qs('#router_keywords').value.split(',').map(s=>s.trim()).filter(Boolean);
  const dm  = qs('#router_domains').value.split(',').map(s=>s.trim()).filter(Boolean);
  sendPayload({ router_add:{ target_topic_id:tgt, keywords:kw, domains:dm, delete_original: qs('#router_delete').checked, warn_user: qs('#router_warn').checked } });
});
qs('#router_enabled')?.addEventListener('change', ()=>sendPayload({ router_toggle:{ enabled: qs('#router_enabled').checked }}));

qs('#pro_buy')?.addEventListener('click', ()=>{
  const m = parseInt(qs('#pro_months').value||'1',10);
  sendPayload({ pro_months: m });
});

/* ================== Stats laden ================== */
async function loadStats(days){
  if (!cid) return;
  const headers = {};
  if (INIT_DATA) headers['X-Telegram-Init-Data'] = INIT_DATA;
  try{
    const r = await fetch(`${API_BASE}/miniapp/stats?cid=${encodeURIComponent(cid)}&days=${days}`, { headers });
    if (!r.ok) throw new Error('HTTP '+r.status);
    const j = await r.json();
    qs('#stats_out').innerHTML = j.html || '‚Äî';
  }catch(e){
    console.error(e);
    qs('#stats_out').textContent = 'Fehler beim Laden der Statistik.';
  }
}

/* ================== Apply / Payload ================== */
async function onSave(){
  if (!cid || !STATE_READY) return;
  setStatus('üíæ Speichere ‚Ä¶'); qs('#saveBtn').disabled = true;

  const payload = {
    cid,
    welcome: {
      enabled: qs('#welcome_enabled').checked,
      text: qs('#welcome_text').value,
      photo_b64: await fileToBase64(qs('#welcome_img')) || undefined,
      captcha: {
        enabled: qs('#welcome_captcha').checked,
        mode: qs('#welcome_captcha_mode').value
      }
    },
    rules: {
      enabled: qs('#rules_enabled').checked,
      text: qs('#rules_text').value,
      photo_b64: await fileToBase64(qs('#rules_img')) || undefined
    },
    farewell: {
      enabled: qs('#farewell_enabled').checked,
      text: qs('#farewell_text').value,
      photo_b64: await fileToBase64(qs('#farewell_img')) || undefined
    },
    spam: {
      enabled: qs('#spam_enabled').checked,
      ban_after: parseInt(qs('#spam_ban_after').value||'3',10),
      mute_minutes: parseInt(qs('#spam_mute_min').value||'10',10),
      link_block_mode: qs('#spam_link_mode').value
    },
    ai: {
      enabled: qs('#ai_enabled').checked,
      model: qs('#ai_model').value,
      temp: parseFloat(qs('#ai_temp').value||'0.7'),
      lang: qs('#ai_lang').value,
      system: qs('#ai_system').value
    },
    ai_mod: {
      enabled: qs('#aimod_enabled').checked,
      shadow_mode: qs('#aimod_shadow').checked,
      exempt_admins: qs('#aimod_ex_admins').checked,
      exempt_topic_owner: qs('#aimod_ex_topic').checked
    },
    report: {
      enabled: qs('#report_enabled').checked,
      topic_id: parseInt(qs('#report_topic').value||'0',10),
      send_dm: qs('#report_dm').checked
    },
    mood: {
      enabled: qs('#mood_enabled').checked,
      topic_id: parseInt(qs('#mood_topic').value||'0',10)
    },
    night: {
      enabled: qs('#night_enabled').checked,
      start: qs('#night_start').value,
      end: qs('#night_end').value,
      only_slowmode: qs('#night_slow').checked
    },
    router_update: {
      enabled: qs('#router_enabled').checked
    },
    images: {
      forward_to_topic: parseInt(qs('#images_forward_topic').value||'0',10)
    },
    rewards: {
      claim_mode: qs('#rw_claim').value,
      points_per_reply: parseInt(qs('#rw_per_reply').value||'0',10)
    }
  };

  try{
    const headers = { 'Content-Type':'application/json' };
    if (INIT_DATA) headers['X-Telegram-Init-Data'] = INIT_DATA;
    const r = await fetch(`${API_BASE}/miniapp/apply?cid=${encodeURIComponent(cid)}`, {
      method:'POST', headers, body: JSON.stringify(payload)
    });
    if (!r.ok) throw new Error(await r.text());
    setStatus('‚úÖ Gespeichert.');
    await loadState();
  }catch(e){
    console.error(e);
    setStatus('‚ùå Speichern fehlgeschlagen.');
  }finally{
    qs('#saveBtn').disabled = false;
  }
}

/* ================== Kommandos an Backend ================== */
async function sendPayload(extra){
  if (!cid) return;
  const headers = { 'Content-Type':'application/json' };
  if (INIT_DATA) headers['X-Telegram-Init-Data'] = INIT_DATA;
  const body = JSON.stringify({ cid, ...extra });
  try{
    setStatus('‚è≥ √úbermittle ‚Ä¶');
    const r = await fetch(`${API_BASE}/miniapp/apply?cid=${encodeURIComponent(cid)}`, { method:'POST', headers, body });
    if (!r.ok) throw new Error(await r.text());
    setStatus('‚úÖ Gesendet.');
    await loadState();
  }catch(e){ console.error(e); setStatus('‚ùå Fehler.'); }
}

/* ================== Boot ================== */
document.addEventListener('DOMContentLoaded', async ()=>{
  try{ window.Telegram?.WebApp?.expand?.(); }catch{}
  await loadGroups();
  if (cid){ showContentArea(cid); await loadState(); await loadStats(parseInt(qs('#stats_days').value,10)||14); }
  else { showStartPage(); }
});
</script>
</body>
</html>

<!doctype html>
<html lang="de" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Emerald Content ‚Äì Mini-App</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --ring:#1f2937; --text:#e5e7eb; --muted:#94a3b8;
      --brand:#22c55e; --danger:#ef4444; --yellow:#f59e0b; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    [data-theme="light"]{
      --bg:#f7fafc; --panel:#ffffff; --ring:#e5e7eb; --text:#0b1220; --muted:#4b5563;
      --brand:#16a34a; --danger:#dc2626; --yellow:#d97706; --shadow:0 6px 22px rgba(0,0,0,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Ubuntu,sans-serif}
    .titlebar{display:flex;align-items:center;gap:10px;margin:2px 0 12px}
    .title{font-weight:800;font-size:22px;letter-spacing:.2px}
    .group-select{padding: 8px 12px;border-radius: 12px;border: 1px solid var(--ring);background: var(--panel);color: var(--text);font-size: 14px;margin-left: auto;}
    .pillbar{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 14px}
    .pill{border:1px solid var(--ring);background:#0000;color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer}
    .pill.active{background:var(--brand);border-color:var(--brand);color:#08140f;font-weight:700}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width:760px){.grid{grid-template-columns:1fr}}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .card{background:var(--panel);border:1px solid var(--ring);border-radius:16px;padding:14px;box-shadow:var(--shadow);display:none;margin:0 auto;max-width:980px;padding:16px 16px 80px}
    .card.active{display:block}
    label{display:block;font-weight:600;margin:6px 0 6px;color:var(--muted)}
    input[type="text"],input[type="number"],input[type="datetime-local"],textarea,select{width:100%;background:#0000;border:1px solid var(--ring);color:var(--text);border-radius:12px;padding:9px 10px}
    textarea{min-height:92px;resize:vertical}
    .switch{display:inline-flex;align-items:center;gap:6px}
    .switch input{accent-color:var(--brand)}
    .sep{height:1px;background:var(--ring);margin:10px 0}
    .list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .item{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px solid var(--ring);border-radius:12px;padding:8px 10px;background:#00000008}
    .item .left{display:flex;flex-direction:column;gap:4px;min-width:0;flex:1}
    .item .title{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .hint{font-size:12px;color:var(--muted)}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:rgba(127,127,127,.12);padding:2px 6px;border-radius:6px}
    .imgprev{display:block;max-width:180px;max-height:120px;border:1px solid var(--ring);border-radius:12px;object-fit:cover;background:#00000010;transition:all 0.2s ease;margin:8px 0}
    .imgprev:hover{transform:scale(1.05);border-color:var(--brand);box-shadow:var(--shadow)}
    .footerbar{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(180deg,rgba(0,0,0,0),rgba(0,0,0,.08)),var(--bg);border-top:1px solid var(--ring);padding:10px 16px;display:flex;align-items:center;gap:12px;backdrop-filter:saturate(120%) blur(6px);z-index:100}
    .footerbar .right{margin-left:auto;display:flex;gap:8px}
    .footerbar .left{display:flex;gap:8px}
    .btn{border:1px solid var(--ring);background:transparent;color:var(--text);padding:8px 12px;border-radius:12px;cursor:pointer;transition:all 0.2s}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#08140f;font-weight:700}
    .btn.ghost{opacity:.9}
    .btn.small{padding:6px 9px;border-radius:10px;font-size:12px}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:var(--shadow)}
    .input-error{border-color:var(--danger)!important;box-shadow:0 0 0 2px rgba(239,68,68,.2)}
    .err{color:var(--danger);font-size:12px;margin:4px 2px 0}
    #startPage{max-width:600px;margin:20px auto;opacity:1;transition:opacity 0.3s ease;padding:16px}
    .welcome-header{text-align:center;margin-bottom:30px}
    .welcome-header h1{font-size:24px;margin-bottom:10px;color:var(--brand)}
    .welcome-header p{color:var(--muted);margin:0}
    .group-list{margin-top:20px}
    .group-item{display:flex;align-items:center;justify-content:space-between;padding:16px;margin:12px 0;background:var(--panel);border:1px solid var(--ring);border-radius:12px;transition:all 0.2s ease}
    .group-item:hover{border-color:var(--brand);transform:translateY(-1px);box-shadow:var(--shadow)}
    .group-info{flex:1}
    .group-title{font-size:16px;font-weight:500;margin-bottom:4px}
    .group-meta{color:var(--muted);font-size:12px}
    #contentArea{opacity:0;transition:opacity 0.3s ease;display:none}
    #contentArea.visible{opacity:1;display:block}
    .wrap{max-width:980px;margin:0 auto;padding:16px 16px 80px}
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<div id="startPage">
  <div class="welcome-header">
    <h1>Emerald Content Bot</h1>
    <p>Verwalte deine Gruppen-Einstellungen</p>
  </div>
  <div class="card active">
    <div id="groupList" class="group-list">
      <p class="hint">Lade Gruppen...</p>
    </div>
  </div>
</div>

<div id="contentArea" class="wrap">
  <div class="titlebar">
    <div class="title">Gruppeneinstellungen</div>
    <select id="groupSelect" class="group-select">
      <option value="">Gruppe w√§hlen...</option>
    </select>
  </div>
  <div class="pillbar" id="tabs">
    <button class="pill active" data-tab="welcome">Begr√º√üung</button>
    <button class="pill" data-tab="rules">Regeln</button>
    <button class="pill" data-tab="farewell">Verabschiedung</button>
    <button class="pill" data-tab="spam">Spam</button>
    <button class="pill" data-tab="rss">RSS</button>
    <button class="pill" data-tab="ai">KI</button>
    <button class="pill" data-tab="mood">Mood</button>
    <button class="pill" data-tab="faq">FAQ</button>
    <button class="pill" data-tab="night">Nachtmodus</button>
    <button class="pill" data-tab="aimod">KI-Mod</button>
    <button class="pill" data-tab="report">Report</button>
    <button class="pill" data-tab="stats">Statistik</button>
    <button class="pill" data-tab="rewards">Rewards</button>
    <button class="pill" data-tab="more">Sonstiges</button>
    <button class="pill" data-tab="pro">PRO</button>
    
  </div>

  <section class="card active" id="sec-welcome">
    <div class="row">
      <label class="switch"><input type="checkbox" data-key="welcome.on"> Begr√º√üung aktiv</label>
      <label class="switch"><input type="checkbox" data-key="welcome.captcha"> Captcha aktiv</label>
    </div>
    <div class="row gap-6">
      <div style="flex:1">
        <label>Bild (optional)</label>
        <div class="row">
          <img id="welcome_img_prev" class="imgprev" alt="Welcome Bild" style="display:none"/>
          <input type="file" id="welcome_img" accept="image/*"/>
          <button class="btn small" id="welcome_img_clear" type="button">L√∂schen</button>
        </div>
        <div class="hint">Wird mit der Begr√º√üung gepostet.</div>
      </div>
    </div>
    <label>Text</label>
    <textarea data-key="welcome.text" placeholder="Willkommen {user} üëã"></textarea>
    <div class="hint">Variablen: <span class="kbd">{user}</span>, <span class="kbd">{title}</span></div>
  </section>

  <section class="card" id="sec-rules">
    <div class="row">
      <label class="switch"><input type="checkbox" data-key="rules.on"> Regeln aktiv</label>
    </div>
    <div class="row gap-6">
      <div style="flex:1">
        <label>Bild (optional)</label>
        <div class="row">
          <img id="rules_img_prev" class="imgprev" alt="Regeln Bild" style="display:none"/>
          <input type="file" id="rules_img" accept="image/*"/>
          <button class="btn small" id="rules_img_clear" type="button">L√∂schen</button>
        </div>
        <div class="hint">Wird zusammen mit dem Regeltext gepostet.</div>
      </div>
    </div>
    <label>Text</label>
    <textarea data-key="rules.text" placeholder="Bitte beachte unsere Regeln ‚Ä¶"></textarea>
  </section>

  <section class="card" id="sec-farewell">
    <div class="row">
      <label class="switch"><input type="checkbox" data-key="farewell.on"> Verabschiedung aktiv</label>
    </div>
    <div class="row gap-6">
      <div style="flex:1">
        <label>Bild (optional)</label>
        <div class="row">
          <img id="farewell_img_prev" class="imgprev" alt="Farewell Bild" style="display:none"/>
          <input type="file" id="farewell_img" accept="image/*"/>
          <button class="btn small" id="farewell_img_clear" type="button">L√∂schen</button>
        </div>
        <div class="hint">Wird bei der Verabschiedung gepostet.</div>
      </div>
    </div>
    <label>Text</label>
    <textarea data-key="farewell.text" placeholder="Tsch√ºss {user}!"></textarea>
  </section>

  <section class="card" id="sec-spam">
    <div class="grid">
      <label class="switch"><input type="checkbox" data-key="spam.on"> Spam-Filter aktiv</label>
      <label class="switch"><input type="checkbox" data-key="spam.block_links"> Links blockieren (Admins)</label>
      <label class="switch"><input type="checkbox" data-key="spam.block_media"> Medien blockieren</label>
      <label class="switch"><input type="checkbox" data-key="spam.block_invite_links"> Invite-Links l√∂schen</label>
    </div>
    <div class="grid">
      <label>Policy-Topic (ID)
        <input type="text" data-key="spam.policy_topic" data-validate="int" placeholder="z.B. 123" />
        <div class="err" hidden id="err_spamtopic"></div>
      </label>
      <label>Aktion
        <select data-key="spam.action" id="spam_action">
          <option value="">‚Äî</option>
          <option value="delete">L√∂schen</option>
          <option value="warn">Warnen</option>
          <option value="mute">Stummschalten</option>
        </select>
      </label>
    </div>
    <div class="grid">
      <label>Whitelist-Domains (eine pro Zeile)
        <textarea data-key="spam.whitelist" id="spam_whitelist" placeholder="beispiel.de&#10;links.meine-seite.org"></textarea>
      </label>
      <label>Blacklist-Domains (eine pro Zeile)
        <textarea data-key="spam.blacklist" id="spam_blacklist" placeholder="spam.xyz&#10;bad.example"></textarea>
      </label>
    </div>
    <div class="grid">
      <label>T√§gliches Limit pro Nutzer
        <input type="number" data-key="spam.per_user_daily_limit" id="spam_limit" min="0" placeholder="0 = aus">
      </label>
      <label>Quota-Notify
        <select data-key="spam.quota_notify" id="spam_quota">
          <option value="">‚Äî</option>
          <option value="off">Aus</option>
          <option value="smart">Smart</option>
          <option value="always">Immer</option>
        </select>
      </label>
    </div>
  </section>

  <section class="card" id="sec-rss">
    <div class="grid">
      <label>RSS-Feed URL
        <input type="text" id="rss_url" data-validate="url" placeholder="https://example.com/feed.xml"/>
        <div class="err" hidden id="err_rssurl"></div>
      </label>
      <label>Topic (ID)
        <input type="text" id="rss_topic" data-validate="int" placeholder="0 = Standard"/>
        <div class="err" hidden id="err_rsstopic"></div>
      </label>
    </div>
    <div class="row">
      <label class="switch"><input type="checkbox" id="rss_postimg"> Beitragsbilder posten</label>
      <label class="switch"><input type="checkbox" id="rss_enabled" checked> Feed aktivieren</label>
      <label class="switch"><input type="checkbox" id="rss_ai_analyze"> KI-Analyse aktivieren</label>
      <button class="btn small" id="rss_add">Hinzuf√ºgen</button>
    </div>
    <div class="sep"></div>
    <div id="rssList" class="list"></div>
  </section>

  <section class="card" id="sec-ai">
    <div class="row">
      <label class="switch"><input type="checkbox" data-key="ai.on"> KI/FAQ aktiv</label>
      <label class="switch"><input type="checkbox" data-key="ai.rss_analysis"> RSS-KI-Analyse nutzen</label>
    </div>
    <label>FAQ-Hinweis (optional)</label>
    <textarea data-key="ai.faq" placeholder="Kurzer Hinweistext f√ºr Nutzer ‚Ä¶"></textarea>
  </section>

  <section class="card" id="sec-mood">
    <h3>üòä Stimmungs-Umfrage</h3>
    <div class="row">
      <label class="switch"><input type="checkbox" data-key="mood.on"> Stimmungs-Umfrage aktiv</label>
    </div>
    <label>Frage
      <input type="text" data-key="mood.question" placeholder="Wie ist deine Stimmung?" />
    </label>
    <label>Topic (optional, 0 = Hauptchat)
      <input type="text" data-key="mood.topic" data-validate="int" placeholder="0"/>
      <div class="err" hidden id="err_moodtopic"></div>
    </label>
    <div class="row">
      <button class="btn small" id="mood_send_now">Umfrage jetzt senden</button>
    </div>
    <div class="hint" style="margin-top:8px">
      Nutzer k√∂nnen mit üëç üëé ü§î abstimmen. Diese Umfrage wird regelm√§√üig (t√§glich/w√∂chentlich) versendet.
    </div>
  </section>

  <section class="card" id="sec-faq">
    <div class="grid">
      <label>Frage
        <input type="text" id="faq_q" placeholder="Deine Frage ‚Ä¶" />
      </label>
      <label>Antwort
        <input type="text" id="faq_a" placeholder="Kurze Antwort ‚Ä¶" />
      </label>
    </div>
    <div class="row">
      <button class="btn small" id="faq_add">Hinzuf√ºgen</button>
    </div>
    <div class="sep"></div>
    <div id="faqList" class="list"></div>
  </section>

  <section class="card" id="sec-night">
    <div class="grid">
      <label class="switch"><input type="checkbox" data-key="night.on"> Nachtmodus aktiv</label>
      <label class="switch"><input type="checkbox" data-key="night.write_lock"> Schreiben sperren (nicht l√∂schen)</label>
      <label>Start (HH:MM)
        <input type="text" data-key="night.start" data-validate="time" placeholder="22:00" />
        <div class="err" hidden id="err_nstart"></div>
      </label>
      <label>Ende (HH:MM)
        <input type="text" data-key="night.end" data-validate="time" placeholder="07:00" />
        <div class="err" hidden id="err_nend"></div>
      </label>
    </div>
    <label>Hinweistext (wenn Schreiben gesperrt)
      <textarea data-key="night.lock_message" placeholder="Die Gruppe ist gerade im Nachtmodus. Schreiben ist nicht m√∂glich."></textarea>
    </label>
    <div class="grid">
      <label class="switch"><input type="checkbox" data-key="night.delete_non_admin_msgs"> Non-Admin Nachrichten l√∂schen (Nachtzeitr√§ume)</label>
      <label class="switch"><input type="checkbox" data-key="night.warn_once"> Warnung anzeigen</label>
      <label>Zeitzone
        <input type="text" data-key="night.timezone" placeholder="Europe/Berlin" />
      </label>
      <label class="switch"><input type="checkbox" data-key="night.hard_mode"> Hard-Mode</label>
    </div>
  </section>

  <section class="card" id="sec-aimod">
    <div class="grid">
      <label class="switch"><input type="checkbox" data-key="ai_mod.enabled"> Aktiviert</label>
      <label class="switch"><input type="checkbox" data-key="ai_mod.shadow_mode"> Shadow-Mode</label>
    </div>
    <div class="grid">
      <label>Prim√§r-Aktion
        <select data-key="ai_mod.action_primary">
          <option value="">‚Äî</option>
          <option value="delete">L√∂schen</option>
          <option value="warn">Warnen</option>
          <option value="mute">Stummschalten</option>
        </select>
      </label>
      <label>Mute-Minuten
        <input type="number" data-key="ai_mod.mute_minutes" min="0" placeholder="0 = aus" />
      </label>
    </div>
    <div class="grid">
      <label>Toxicity-Schwelle
        <input type="number" step="0.01" min="0" max="1" data-key="ai_mod.toxicity" placeholder="0.90" />
      </label>
      <label>Hate-Schwelle
        <input type="number" step="0.01" min="0" max="1" data-key="ai_mod.hate" placeholder="0.85" />
      </label>
      <label>Sexual-Schwelle
        <input type="number" step="0.01" min="0" max="1" data-key="ai_mod.sexual" placeholder="0.90" />
      </label>
      <label>Harassment-Schwelle
        <input type="number" step="0.01" min="0" max="1" data-key="ai_mod.harassment" placeholder="0.90" />
      </label>
    </div>
  </section>

  <section class="card" id="sec-report">
    <div class="grid">
      <label class="switch"><input type="checkbox" data-key="report.enabled"> T√§glichen Report aktiv</label>
      <label>Report-Topic (ID)
        <input type="text" data-key="report.topic" data-validate="int" placeholder="0 = Standard"/>
        <div class="err" hidden id="err_reporttopic"></div>
      </label>
    </div>
    <div class="row">
      <button class="btn small" id="report_send_now">Report jetzt posten</button>
    </div>
  </section>

  <section class="card" id="sec-stats">
    <h3>üìä Statistik</h3>
    <div class="grid">
      <label>Zeitraum
        <select id="stats_days">
          <option value="7">7 Tage</option>
          <option value="14" selected>14 Tage</option>
          <option value="30">30 Tage</option>
        </select>
      </label>
      <button class="btn small" id="stats_reload">Aktualisieren</button>
    </div>
    <div id="statsBox" class="list" style="margin-top:16px">
      <p class="hint">Lade Statistik...</p>
    </div>
  </section>

  <section class="card" id="sec-rewards">
    <h3>üíé Rewards (EMRD-Token)</h3>
    <div class="hint" style="margin:12px 0">
      Der <strong>EMRD-Token</strong> ist ein Utility-Token im TON-Netzwerk. 
      Nutzer erhalten EMRD als Belohnung f√ºr hilfreiche Beitr√§ge in deiner Gruppe.
      Sie k√∂nnen ihre EMRD-Rewards claimen und in ihrer TON-Wallet verwalten.
    </div>
    <div class="sep"></div>
    <div class="grid">
      <label class="switch"><input type="checkbox" data-key="rewards.enabled"> Rewards aktivieren</label>
      <label>Modus
        <select data-key="rewards.mode">
          <option value="claim">Claim (User)</option>
          <option value="auto">Auto (Owner)</option>
        </select>
      </label>
    </div>
    <div class="grid">
      <label>Rate pro Antwort (read-only)
        <input type="text" disabled placeholder="0.01"/>
      </label>
      <label>Rate pro Helpful-Vote (read-only)
        <input type="text" disabled placeholder="0.05"/>
      </label>
    </div>
    <div class="grid">
      <label>Mindestbetrag zum Claimen (EMRD)
        <input type="number" data-key="rewards.min_claim" step="0.001" min="0" placeholder="0.5"/>
      </label>
      <label>Cap pro Nutzer/Tag
        <input type="number" data-key="rewards.cap_user" step="1" min="0" placeholder="0 = unbegrenzt"/>
      </label>
      <label>Cap pro Chat/Tag
        <input type="number" data-key="rewards.cap_chat" step="1" min="0" placeholder="0 = unbegrenzt"/>
      </label>
    </div>
    <div class="row">
      <button class="btn small" id="reward_claim_test">Claim-Funktion testen</button>
    </div>
    <div class="hint" style="margin-top:12px">
      üí° Tipp: Die festen Rates k√∂nnen in der Konfiguration eingestellt werden. Nutzer k√∂nnen nur oberhalb des Mindestbetrags claimen.
    </div>
  </section>

  <section class="card" id="sec-pro">
    <h3>üí∞ PRO-Plan Zahlung</h3>
    <div class="hint" style="margin:12px 0">
      Aktiviere Zahlungsoptionen f√ºr PRO-Mitgliedschaften. Nutzer k√∂nnen via /buypro upgraden.
    </div>
    <div class="sep"></div>
    
    <h4 style="margin:16px 0 8px; color:var(--brand)">üîó Blockchain Zahlungen</h4>
    <div class="grid">
      <label class="switch">
        <input type="checkbox" data-key="pro.ton_enabled"> TON Wallet
      </label>
      <label class="switch">
        <input type="checkbox" data-key="pro.near_enabled"> NEAR Protocol
      </label>
    </div>
    
    <h4 style="margin:16px 0 8px; color:var(--brand)">üí≥ Fiat Zahlungen</h4>
    <div class="grid">
      <label class="switch">
        <input type="checkbox" data-key="pro.coinbase_enabled"> Coinbase Commerce
      </label>
      <label class="switch">
        <input type="checkbox" data-key="pro.paypal_enabled"> PayPal
      </label>
    </div>

    <div class="sep"></div>
    <h4 style="margin:16px 0 8px; color:var(--brand)">üí∞ PRO-Plan Preise (‚Ç¨)</h4>
    <div class="grid">
      <label>1 Monat
        <input type="text" value="9,99 ‚Ç¨" disabled style="background:var(--ring);opacity:0.7"/>
      </label>
      <label>3 Monate
        <input type="text" value="24,99 ‚Ç¨" disabled style="background:var(--ring);opacity:0.7"/>
      </label>
      <label>12 Monate
        <input type="text" value="99,99 ‚Ç¨" disabled style="background:var(--ring);opacity:0.7"/>
      </label>
    </div>

    <div class="sep"></div>
    <h4 style="margin:16px 0 8px; color:var(--brand)">üìù PRO-Features Beschreibung</h4>
    <label>Beschreibung (wird im /buypro Men√º angezeigt)
      <textarea data-key="pro.description" placeholder="Beispiel: ‚úì Unbegrenzte Custom-Regeln&#10;‚úì KI-Moderation ohne Limit&#10;‚úì Premium Support&#10;‚úì Advanced Analytics"></textarea>
    </label>

    <div class="sep"></div>
    <div class="row">
      <button class="btn" id="pro_test">Test: PRO Payment Men√º √∂ffnen</button>
    </div>
  </section>

  <section class="card" id="sec-more">
    <h3>‚öôÔ∏è Sonstiges</h3>
    <div class="sep"></div>
    <div>
      <h4 style="margin:12px 0 8px; color:var(--brand)">Gel√∂schte Accounts aufr√§umen</h4>
      <div class="grid">
        <label class="switch">
          <input type="checkbox" data-key="clean_deleted.enabled"> Scheduler aktiv
        </label>
        <label>Uhrzeit 
          <input type="time" data-key="clean_deleted.time" value="03:00"/>
        </label>
        <label>Wochentag (optional)
          <select data-key="clean_deleted.weekday">
            <option value="">T√§glich</option>
            <option value="0">Montag</option>
            <option value="1">Dienstag</option>
            <option value="2">Mittwoch</option>
            <option value="3">Donnerstag</option>
            <option value="4">Freitag</option>
            <option value="5">Samstag</option>
            <option value="6">Sonntag</option>
          </select>
        </label>
      </div>
      <div class="grid">
        <label class="switch"><input type="checkbox" data-key="clean_deleted.demote"> Admins demoten</label>
        <label class="switch"><input type="checkbox" data-key="clean_deleted.notify" checked> Ergebnis melden</label>
      </div>
      <div class="row">
        <button class="btn small" id="clean_now" type="button">Jetzt ausf√ºhren</button>
      </div>
      <div class="hint" style="margin-top:8px">
        Entfernt Admins/Moderatoren, deren Telegram-Accounts gel√∂scht wurden.
      </div>
    </div>
  </section>
</div>

<div class="footerbar">
  <div class="left">
    <button class="btn ghost" id="backBtn">‚Üê Zur√ºck</button>
    <div id="out" class="hint">Bereit.</div>
  </div>
  <div class="right">
    <span style="font-size:11px;color:var(--muted);margin-right:8px">Werbung</span>
    <button class="btn ghost" id="themeBtn" title="Hell/Dunkel">üåì</button>
    <button class="btn ghost" id="resetBtn">Zur√ºcksetzen</button>
    <button class="btn ghost" id="closeBtn">Schlie√üen</button>
    <button class="btn primary" id="saveBtn" disabled>Speichern</button>
  </div>
</div>

<script>
const qs = (s) => document.querySelector(s);
const qa = (s) => Array.from(document.querySelectorAll(s));
const getUrlParam = (k, def=null) => new URL(location.href).searchParams.get(k) ?? def;

const tg = window.Telegram?.WebApp;
const API_BASE = getUrlParam("api") || "https://emeraldcontent-aac379fc581e.herokuapp.com";
const INIT_DATA = tg?.initData || "";
const uid = parseInt(getUrlParam("uid") || tg?.initDataUnsafe?.user?.id || 0);
let cid = parseInt(getUrlParam("cid") || 0);
const authQS = INIT_DATA ? "" : `&uid=${encodeURIComponent(uid)}`;
let STATE_READY = false;

// Validation helpers
function validTime(val) { const s = (val || '').trim(); if (s === '') return true; return /^([01]?\d|2[0-3]):([0-5]\d)$/.test(s); }
function validInt(val) { const s = (val ?? '').toString().trim(); return s === '' || /^-?\d+$/.test(s); }
function validUrl(val) { try { const u = new URL(val); return !!u.protocol && !!u.host; } catch { return false; } }
function validFloat(val, def) { const s = (val ?? '').toString().trim(); return s === '' ? def : (isNaN(parseFloat(s)) ? def : parseFloat(s)); }

function setVal(path, val) {
  const el = qa(`[data-key="${path}"]`)[0];
  if(!el) return;
  if(el.type==='checkbox') el.checked = !!val;
  else el.value = (val ?? '');
}

function collect() {
  const out = {};
  qa('[data-key]').forEach(el=>{
    const path = el.getAttribute('data-key');
    const parts = path.split('.');
    let cur = out;
    for(let i=0; i<parts.length-1; i++) {
      if(!(parts[i] in cur)) cur[parts[i]] = {};
      cur = cur[parts[i]];
    }
    const leaf = parts[parts.length-1];
    const val = (el.type==='checkbox') ? !!el.checked : el.value;
    cur[leaf] = val;
  });
  return out;
}

function validateAll() {
  let ok = true;
  qa('input[data-validate]').forEach(el=>{
    let valid = true;
    const val = el.value;
    const rule = el.getAttribute('data-validate');
    if(rule==='time') valid = validTime(val);
    else if(rule==='int') valid = validInt(val);
    else if(rule==='url') valid = validUrl(val);
    const errId = el.getAttribute('id')?.replace(/^/, 'err_');
    const errEl = errId ? qs(`#${errId}`) : null;
    if(errEl) errEl.style.display = (valid || !val) ? 'none' : 'block';
    el.classList.toggle('input-error', !valid && !!val);
    if(!valid && val) ok = false;
  });
  qs('#saveBtn').disabled = !ok;
  return ok;
}

function showStartPage() {
  qs('#startPage').style.display = 'block';
  const area = qs('#contentArea');
  if(area) { area.classList.remove('visible'); setTimeout(()=>area.style.display = 'none', 300); }
  cid = 0;
}

function showContentArea(gid) {
  cid = parseInt(gid);
  qs('#startPage').style.display = 'none';
  const area = qs('#contentArea');
  if(area) { area.style.display = 'block'; setTimeout(()=>area.classList.add('visible'), 10); }
}

async function loadGroups() {
  const list = qs('#groupList');
  if(!list) return;
  try {
    list.innerHTML = '<p class="hint">‚è≥ Lade Gruppen‚Ä¶</p>';
    const headers = {};
    if(INIT_DATA) headers['X-Telegram-Init-Data'] = INIT_DATA;
    const res = await fetch(`${API_BASE}/miniapp/groups?${authQS}`, {headers});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const groups = data?.groups || [];
    
    const select = qs('#groupSelect');
    if(select) {
      select.innerHTML = '<option value="">Gruppe w√§hlen...</option>' + 
        groups.map(g => `<option value="${g.id}">${g.title || g.id}</option>`).join('');
      if(cid) select.value = cid;
      select.addEventListener('change', ()=>{
        const v = select.value;
        if(v) { showContentArea(v); loadState(); }
      });
    }
    
    if(!groups.length) {
      list.innerHTML = '<p class="hint">Keine Gruppen ‚Äì f√ºge den Bot zu einer Gruppe hinzu und mache ihn zum Admin.</p>';
    } else {
      list.innerHTML = groups.map(g => 
        `<div class="group-item" data-id="${g.id}">
          <div class="group-info">
            <div class="group-title">${g.title || g.id}</div>
            <div class="group-meta">Telegram-Gruppe</div>
          </div>
          <button class="btn primary small">Verwalten</button>
        </div>`
      ).join('');
      qa('.group-item button').forEach(btn=>{
        btn.onclick = ()=>{
          const gid = btn.closest('.group-item').dataset.id;
          if(gid) { showContentArea(gid); loadState(); }
        };
      });
    }
  } catch(err) {
    console.error('Gruppen laden fehlgeschlagen', err);
    list.innerHTML = `<p class="hint error">Fehler: ${err.message}</p>`;
  }
}

function renderRss(feeds) {
  const box = qs('#rssList');
  if(!box) return;
  box.innerHTML = '';
  (feeds || []).forEach(f=>{
    const item = document.createElement('div');
    item.className = 'item';
    const left = document.createElement('div');
    left.className = 'left';
    left.innerHTML = `<div class="title">${f.url}</div><div class="hint">Topic: ${f.topic ?? 0}</div>`;
    const right = document.createElement('div');
    right.innerHTML = `<button class="btn small danger">L√∂schen</button>`;
    right.querySelector('button').onclick = ()=>sendPayload({rss_del: f.url});
    item.append(left, right);
    box.append(item);
  });
}

function renderFaq(list) {
  const box = qs('#faqList');
  if(!box) return;
  box.innerHTML = '';
  (list || []).forEach(f=>{
    const item = document.createElement('div');
    item.className = 'item';
    const left = document.createElement('div');
    left.className = 'left';
    left.innerHTML = `<div class="title">${f.q}</div><div class="hint">${f.a||''}</div>`;
    const del = document.createElement('button');
    del.className = 'btn small danger';
    del.textContent = 'L√∂schen';
    del.onclick = ()=>sendPayload({faq_del: {q: f.q}});
    item.append(left, del);
    box.append(item);
  });
}

async function loadState() {
  qs('#out').textContent = 'Lade ‚Ä¶';
  try {
    const res = await fetch(`${API_BASE}/miniapp/state?cid=${cid}${authQS}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'X-Telegram-Init-Data': INIT_DATA
      }
    });
    if(!res.ok) throw new Error(await res.text());
    const j = await res.json();
    
    setVal('welcome.on', j.welcome?.on);
    setVal('welcome.text', j.welcome?.text);
    // Load welcome image if available
    if(j.welcome?.image_url) {
      const img = qs('#welcome_img_prev');
      if(img) { img.src = j.welcome.image_url; img.style.display = 'block'; }
    }
    setVal('rules.on', j.rules?.on);
    setVal('rules.text', j.rules?.text);
    // Load rules image if available
    if(j.rules?.image_url) {
      const img = qs('#rules_img_prev');
      if(img) { img.src = j.rules.image_url; img.style.display = 'block'; }
    }
    setVal('farewell.on', j.farewell?.on);
    setVal('farewell.text', j.farewell?.text);
    // Load farewell image if available
    if(j.farewell?.image_url) {
      const img = qs('#farewell_img_prev');
      if(img) { img.src = j.farewell.image_url; img.style.display = 'block'; }
    }
    setVal('spam.on', j.spam?.on ?? false);
    setVal('spam.block_links', j.spam?.block_links ?? false);
    setVal('spam.block_media', j.spam?.block_media ?? false);
    setVal('spam.block_invite_links', j.spam?.block_invite_links ?? false);
    setVal('spam.policy_topic', j.spam?.policy_topic ?? 0);
    if(Array.isArray(j.spam?.whitelist)) qs('#spam_whitelist').value = (j.spam.whitelist||[]).join('\n');
    if(Array.isArray(j.spam?.blacklist)) qs('#spam_blacklist').value = (j.spam.blacklist||[]).join('\n');
    setVal('spam.action', j.spam?.action ?? '');
    setVal('spam.per_user_daily_limit', j.spam?.per_user_daily_limit ?? 0);
    setVal('spam.quota_notify', j.spam?.quota_notify ?? '');
    
    setVal('ai.on', j.ai?.on ?? false);
    setVal('ai.faq', j.ai?.faq ?? '');
    setVal('ai.rss_analysis', j.ai?.rss_analysis ?? false);
    
    // Load mood data
    setVal('mood.on', j.mood?.on ?? false);
    setVal('mood.question', j.mood?.question ?? 'Wie ist deine Stimmung?');
    setVal('mood.topic', j.mood?.topic ?? 0);
    
    setVal('night.on', j.night?.on ?? false);
    setVal('night.write_lock', j.night?.write_lock ?? false);
    setVal('night.start', j.night?.start || '22:00');
    setVal('night.end', j.night?.end || '07:00');
    setVal('night.lock_message', j.night?.lock_message || '');
    setVal('night.delete_non_admin_msgs', j.night?.delete_non_admin_msgs ?? true);
    setVal('night.warn_once', j.night?.warn_once ?? true);
    setVal('night.timezone', j.night?.timezone || 'Europe/Berlin');
    setVal('night.hard_mode', j.night?.hard_mode ?? false);
    
    const am = j.aimod||{};
    setVal('ai_mod.enabled', am.enabled);
    setVal('ai_mod.shadow_mode', am.shadow_mode);
    setVal('ai_mod.action_primary', am.action_primary);
    setVal('ai_mod.mute_minutes', am.mute_minutes);
    setVal('ai_mod.toxicity', am.toxicity ?? am.tox_thresh);
    setVal('ai_mod.hate', am.hate ?? am.hate_thresh);
    setVal('ai_mod.sexual', am.sexual ?? am.sex_thresh);
    setVal('ai_mod.harassment', am.harassment ?? am.harass_thresh);
    
    setVal('report.enabled', j.report?.enabled ?? false);
    setVal('report.topic', j.report?.topic ?? 0);
    
    renderRss(j.rss?.feeds || []);
    renderFaq(j.faqs || []);
    
    // Load rewards data
    const rewardData = j.rewards || {};
    setVal('rewards.enabled', rewardData.enabled || false);
    setVal('rewards.mode', rewardData.mode || 'claim');
    setVal('rewards.min_claim', rewardData.min_claim || '0.5');
    setVal('rewards.cap_user', rewardData.cap_user || '');
    setVal('rewards.cap_chat', rewardData.cap_chat || '');
    
    // Load PRO payment data
    const proData = j.pro || {};
    setVal('pro.ton_enabled', proData.ton_enabled || false);
    setVal('pro.ton_wallet', proData.ton_wallet || '');
    setVal('pro.near_enabled', proData.near_enabled || false);
    setVal('pro.near_wallet', proData.near_wallet || 'emeraldcontent.near');
    setVal('pro.coinbase_enabled', proData.coinbase_enabled || false);
    setVal('pro.coinbase_key', proData.coinbase_key || '');
    setVal('pro.paypal_enabled', proData.paypal_enabled || false);
    setVal('pro.paypal_link', proData.paypal_link || '');
    setVal('pro.stars_enabled', proData.stars_enabled || false);
    setVal('pro.price_1m', proData.price_1m || '9.99');
    setVal('pro.price_3m', proData.price_3m || '24.99');
    setVal('pro.price_12m', proData.price_12m || '99.99');
    setVal('pro.description', proData.description || '');
    
    // Load clean_deleted settings
    const cleanData = j.clean_deleted || {};
    setVal('clean_deleted.enabled', cleanData.enabled || false);
    setVal('clean_deleted.time', cleanData.time || '03:00');
    setVal('clean_deleted.weekday', cleanData.weekday || '');
    setVal('clean_deleted.demote', cleanData.demote || false);
    setVal('clean_deleted.notify', cleanData.notify !== false);
    
    qs('#out').textContent = 'Bereit.';
    STATE_READY = true;
    validateAll();
  } catch(e) {
    console.error(e);
    qs('#out').textContent = 'Fehler beim Laden.';
    STATE_READY = false;
  }
}

async function sendPayload(extra = {}) {
  if(!STATE_READY) { qs('#out').textContent = '‚ö†Ô∏è Erst Daten laden'; return; }
  
  const out = Object.assign({}, collect(), extra);
  
  // Add image data if present - format: welcome: { img_base64: ... }
  ['welcome', 'rules', 'farewell'].forEach(type => {
    const fileInput = qs(`#${type}_img`);
    if(fileInput?.dataset.base64) {
      if(!out[type]) out[type] = {};
      out[type].img_base64 = fileInput.dataset.base64;
    }
  });
  
  qs('#out').textContent = 'Speichere ‚Ä¶';
  
  try {
    try { tg?.sendData?.(JSON.stringify(out)); } catch {}
    const res = await fetch(`${API_BASE}/miniapp/apply?cid=${encodeURIComponent(cid)}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Telegram-Init-Data': INIT_DATA
      },
      body: JSON.stringify(out)
    });
    if(!res.ok) throw new Error(await res.text());
    qs('#out').textContent = '‚úÖ Gespeichert';
    await loadState();
  } catch(e) {
    console.error(e);
    qs('#out').textContent = '‚ö†Ô∏è Fehler';
  }
}

qs('#backBtn')?.addEventListener('click', showStartPage);
qs('#closeBtn')?.addEventListener('click', ()=>{ try{ tg.close(); }catch{ window.close(); } });
qs('#resetBtn')?.addEventListener('click', loadState);
qs('#saveBtn')?.addEventListener('click', ()=>sendPayload());
qs('#themeBtn')?.addEventListener('click', ()=>{
  const cur = document.documentElement.getAttribute('data-theme') || 'dark';
  const next = cur === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('emerald-theme', next);
});

qa('#tabs .pill').forEach(p=>p.addEventListener('click', ()=>{
  qa('#tabs .pill').forEach(x=>x.classList.remove('active'));
  p.classList.add('active');
  qa('section.card').forEach(s=>s.classList.remove('active'));
  qs('#sec-' + p.dataset.tab).classList.add('active');
}));

qs('#rss_add')?.addEventListener('click', ()=>{
  if(!validateAll()) return;
  const url = qs('#rss_url').value.trim();
  if(!url) return;
  const topic = parseInt(qs('#rss_topic').value || '0');
  const ai_analyze = qs('#rss_ai_analyze').checked;
  sendPayload({rss: {url, topic, post_images: qs('#rss_postimg').checked, enabled: qs('#rss_enabled').checked, ai_analyze}});
});

qs('#faq_add')?.addEventListener('click', ()=>{
  const q = qs('#faq_q').value.trim();
  const a = qs('#faq_a').value.trim();
  if(!q) return;
  sendPayload({faq_add: {q, a}});
});

qs('#mood_send_now')?.addEventListener('click', ()=>{
  const topic = parseInt(qs('[data-key="mood.topic"]').value || '0');
  sendPayload({mood_send_now: {dest:'dm', topic}});
});

qs('#report_send_now')?.addEventListener('click', ()=>{
  const topic = parseInt(qs('[data-key="report.topic"]').value || '0');
  sendPayload({report_send_now: {dest:'dm', topic}});
});

qs('#reward_claim_test')?.addEventListener('click', ()=>{
  const minClaim = parseFloat(qs('[data-key="rewards.min_claim"]').value || '0.5');
  alert(`Claim-Funktion konfiguriert.\nMindestbetrag: ${minClaim} EMRD\n\nIn der Produktion werden Wallets hier verbunden.`);
});

// Image compression and preview function
async function compressImage(file, maxWidth=1280, quality=0.82) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let w = img.width, h = img.height;
        if (w > maxWidth) {
          h = Math.round(h * maxWidth / w);
          w = maxWidth;
        }
        canvas.width = w;
        canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        canvas.toBlob(resolve, 'image/jpeg', quality);
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// Setup image handlers for welcome, rules, farewell
['welcome', 'rules', 'farewell'].forEach(type => {
  const fileInput = qs(`#${type}_img`);
  const preview = qs(`#${type}_img_prev`);
  const clearBtn = qs(`#${type}_img_clear`);
  
  if(fileInput) {
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if(!file) return;
      try {
        const compressed = await compressImage(file);
        const reader = new FileReader();
        reader.onload = (evt) => {
          if(preview) {
            preview.src = evt.target.result;
            preview.style.display = 'block';
          }
          // Store as base64 in a data attribute for sending
          fileInput.dataset.base64 = evt.target.result;
        };
        reader.readAsDataURL(compressed);
      } catch(err) {
        console.error('Image compression failed', err);
        alert('Bilder-Upload fehlgeschlagen');
      }
    });
  }
  
  if(clearBtn) {
    clearBtn.addEventListener('click', () => {
      if(fileInput) {
        fileInput.value = '';
        fileInput.dataset.base64 = '';
      }
      if(preview) preview.style.display = 'none';
    });
  }
});

qs('#stats_reload')?.addEventListener('click', async ()=>{
  const days = parseInt(qs('#stats_days').value || '14');
  try {
    const res = await fetch(`${API_BASE}/miniapp/stats?cid=${cid}&days=${days}`, {headers: {'X-Telegram-Init-Data': INIT_DATA}});
    const data = await res.json();
    const box = qs('#statsBox');
    if(box) {
      let html = '';
      // Aggregate data by date for summary
      const agg = data.agg || [];
      let totalMsg = 0, totalActive = 0, totalJoins = 0, totalLeaves = 0, totalKicks = 0;
      (agg || []).forEach(d => {
        totalMsg += d.messages || 0;
        totalActive += d.active || 0;
        totalJoins += d.joins || 0;
        totalLeaves += d.leaves || 0;
        totalKicks += d.kicks || 0;
      });
      
      // Summary section
      html += `<div class="item" style="background:var(--panel)">
        <div class="left">
          <div class="title">üìä Zusammenfassung (${days} Tage)</div>
          <div class="hint">
            üí¨ ${totalMsg} Nachrichten |
            üë• ${totalActive} aktive Nutzer |
            ‚ûï ${totalJoins} Joins |
            ‚ûñ ${totalLeaves} Leaves |
            üö´ ${totalKicks} Kicks
          </div>
        </div>
      </div>`;
      
      // Top responders
      if(data.top_responders && data.top_responders.length > 0) {
        html += '<div style="margin-top:12px"><strong>üèÜ Top Responder:</strong></div>';
        html += (data.top_responders || []).map(t=>`<div class="item"><div class="left"><div class="title">User ${t.user_id}</div><div class="hint">${t.answers} Antworten, √ò ${t.avg_ms}ms</div></div></div>`).join('');
      } else {
        html += '<div style="margin-top:12px;color:var(--ring);font-size:0.9em">Keine Responder-Daten verf√ºgbar</div>';
      }
      box.innerHTML = html;
    }
  } catch(e) {
    console.error('Stats load error', e);
    const box = qs('#statsBox');
    if(box) box.innerHTML = '<p class="hint error">Fehler beim Laden der Statistik</p>';
  }
});

// Clean deleted now button
qs('#clean_now')?.addEventListener('click', async ()=>{
  if(!confirm('Gel√∂schte Accounts jetzt aufr√§umen?')) return;
  const demote = qs('[data-key="clean_deleted.demote"]')?.checked || false;
  const notify = qs('[data-key="clean_deleted.notify"]')?.checked !== false;
  sendPayload({clean_delete_now: {demote, notify}});
});

// PRO Payment Test Button
qs('#pro_test')?.addEventListener('click', async ()=>{
  alert('üì± Zahlung Men√º √∂ffnet sich im Bot. Nutze /buypro in der Gruppe um die Zahlungsoptionen zu testen.');
});

qa('input,textarea,select').forEach(el=>el.addEventListener('input', validateAll));

document.addEventListener('DOMContentLoaded', async ()=>{
  await loadGroups();
  if(cid) { showContentArea(cid); await loadState(); }
  else { showStartPage(); }
});
</script>
</body>
</html>
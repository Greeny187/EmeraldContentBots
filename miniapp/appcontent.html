<!doctype html>
<html lang="de" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Emerald Content ‚Äì Mini-App</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --ring:#1f2937; --text:#e5e7eb; --muted:#94a3b8;
      --brand:#22c55e; --danger:#ef4444; --yellow:#f59e0b; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    [data-theme="light"]{
      --bg:#f7fafc; --panel:#ffffff; --ring:#e5e7eb; --text:#0b1220; --muted:#4b5563;
      --brand:#16a34a; --danger:#dc2626; --yellow:#d97706; --shadow:0 6px 22px rgba(0,0,0,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Ubuntu,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:16px 16px 80px}
    .titlebar{display:flex;align-items:center;gap:10px;margin:2px 0 12px}
    .title{font-weight:800;font-size:22px;letter-spacing:.2px}
    .pillbar{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 14px}
    .pill{border:1px solid var(--ring);background:#0000;color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer}
    .pill.active{background:var(--brand);border-color:var(--brand);color:#08140f;font-weight:700}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width:760px){.grid{grid-template-columns:1fr}}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .card{background:var(--panel);border:1px solid var(--ring);border-radius:16px;padding:14px;box-shadow:var(--shadow)}
    .card { display: none; }
    .card.active { display: block; }
    label{display:block;font-weight:600;margin:6px 0 6px;color:var(--muted)}
    input[type="text"], input[type="number"], input[type="datetime-local"], textarea, select{
      width:100%;background:#0000;border:1px solid var(--ring);color:var(--text);border-radius:12px;padding:9px 10px
    }
    textarea{min-height:92px;resize:vertical}
    .switch{display:inline-flex;align-items:center;gap:6px}
    .switch input{accent-color:var(--brand)}
    .sep{height:1px;background:var(--ring);margin:10px 0}
    .list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .item{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px solid var(--ring);border-radius:12px;padding:8px 10px;background:#00000008}
    .item .left{display:flex;flex-direction:column;gap:4px;min-width:0}
    .item .title{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .hint{font-size:12px;color:var(--muted)}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:rgba(127,127,127,.12);padding:2px 6px;border-radius:6px}

    /* Bildvorschau */
    .imgprev{display:block;max-width:180px;max-height:120px;border:1px solid var(--ring);border-radius:12px;object-fit:cover;background:#00000010}
    .row.gap-6{gap:16px}

    /* Footerbar mit Buttons unten */
    .footerbar{
      position:sticky; bottom:0; left:0; right:0;
      background:linear-gradient(180deg,rgba(0,0,0,0),rgba(0,0,0,.08)) , var(--bg);
      border-top:1px solid var(--ring);
      padding:10px 16px; display:flex; align-items:center; gap:12px;
      backdrop-filter:saturate(120%) blur(6px);
    }
    .footerbar .right{margin-left:auto; display:flex; gap:8px}
    .btn{border:1px solid var(--ring);background:transparent;color:var(--text);padding:8px 12px;border-radius:12px;cursor:pointer}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#08140f;font-weight:700}
    .btn.ghost{opacity:.9}
    .btn.small{padding:6px 9px;border-radius:10px}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    /* Errors */
    .input-error{border-color:var(--danger)!important; box-shadow:0 0 0 2px rgba(239,68,68,.2)}
    .err{color:var(--danger); font-size:12px; margin:4px 2px 0}
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="titlebar"><div class="title">Mini-App</div></div>
    <div class="pillbar" id="tabs">
      <button class="pill active" data-tab="welcome">Begr√º√üung</button>
      <button class="pill" data-tab="rules">Regeln</button>
      <button class="pill" data-tab="farewell">Verabschiedung</button>
      <button class="pill" data-tab="spam">Spam</button>
      <button class="pill" data-tab="rss">RSS</button>
      <button class="pill" data-tab="ai">KI</button>
      <button class="pill" data-tab="aimod">KI-Moderation</button>
      <button class="pill" data-tab="faq">FAQ</button>
      <button class="pill" data-tab="report">Report</button>
      <button class="pill" data-tab="mood">Mood</button>
      <button class="pill" data-tab="night">Nachtmodus</button>
      <button class="pill" data-tab="router">Router</button>
      <button class="pill" data-tab="more">Mehr</button>
      <button class="pill" data-tab="pro">Pro</button>
    </div>

    <!-- WELCOME -->
    <section class="card active" id="sec-welcome">
      <div class="row">
        <label class="switch"><input type="checkbox" data-key="welcome.on"> Begr√º√üung aktiv</label>
      </div>
      <div class="row gap-6" style="margin-top:8px">
        <div>
          <label>Bild (optional)</label>
          <div class="row">
            <img id="welcome_img_prev" class="imgprev" alt="Welcome Bild"/>
            <input type="file" id="welcome_img" accept="image/*"/>
            <button class="btn small" id="welcome_img_clear" type="button">L√∂schen</button>
          </div>
          <div class="hint">Wird mit der Begr√º√üung gepostet.</div>
        </div>
      </div>
<label>Text</label>
      <textarea data-key="welcome.text" placeholder="Willkommen {user} üëã"></textarea>
      <div class="hint">Variablen: <span class="kbd">{user}</span>, <span class="kbd">{title}</span></div>
    </section>

    <!-- RULES -->
    <section class="card" id="sec-rules">
      <div class="row">
        <label class="switch"><input type="checkbox" data-key="rules.on"> Regeln aktiv</label>
      </div>
      <div class="row gap-6" style="margin-top:8px">
        <div>
          <label>Bild (optional)</label>
          <div class="row">
            <img id="rules_img_prev" class="imgprev" alt="Regeln Bild"/>
            <input type="file" id="rules_img" accept="image/*"/>
            <button class="btn small" id="rules_img_clear" type="button">L√∂schen</button>
          </div>
          <div class="hint">Wird zusammen mit dem Regeltext gepostet.</div>
        </div>
      </div>
      <label>Text</label>
      <textarea data-key="rules.text" placeholder="Bitte beachte unsere Regeln ‚Ä¶"></textarea>
    </section>

    <!-- FAREWELL -->
    <section class="card" id="sec-farewell">
      <div class="row">
        <label class="switch"><input type="checkbox" data-key="farewell.on"> Verabschiedung aktiv</label>
      </div>
      <div class="row gap-6" style="margin-top:8px">
        <div>
          <label>Bild (optional)</label>
          <div class="row">
            <img id="farewell_img_prev" class="imgprev" alt="Farewell Bild"/>
            <input type="file" id="farewell_img" accept="image/*"/>
            <button class="btn small" id="farewell_img_clear" type="button">L√∂schen</button>
          </div>
          <div class="hint">Wird bei der Verabschiedung gepostet.</div>
        </div>
      </div>
      <label>Text</label>
      <textarea data-key="farewell.text" placeholder="Tsch√ºss {user}!"></textarea>
    </section>

    <!-- SPAM -->
    <section class="card" id="sec-spam">
      <div class="grid">
        <label class="switch"><input type="checkbox" data-key="spam.on"> Spam-Filter aktiv</label>
        <label class="switch"><input type="checkbox" data-key="spam.block_links"> Links blockieren (nur Admins)</label>
        <label class="switch"><input type="checkbox" data-key="spam.block_media"> Medien blockieren</label>
        <label class="switch"><input type="checkbox" data-key="spam.block_invite_links"> Einladungslinks l√∂schen</label>
      </div>
      <div class="grid">
        <label>Policy-Topic (ID)
          <input type="text" data-key="spam.policy_topic" data-validate="int" placeholder="z.B. 123" />
          <div class="err" hidden id="err_spamtopic"></div>
        </label>
        <label>Spam-Aktion
          <select data-key="spam.action" id="spam_action">
            <option value="">‚Äî</option>
            <option value="delete">L√∂schen</option>
            <option value="warn">Warnen</option>
            <option value="mute">Stummschalten</option>
          </select>
        </label>
      </div>
      <div class="grid">
        <label>Whitelist-Domains (eine pro Zeile)
          <textarea data-key="spam.whitelist" id="spam_whitelist" placeholder="beispiel.de&#10;links.meine-seite.org"></textarea>
        </label>
        <label>Blacklist-Domains (eine pro Zeile)
          <textarea data-key="spam.blacklist" id="spam_blacklist" placeholder="spam.xyz&#10;bad.example"></textarea>
        </label>
      </div>
      <div class="grid">
        <label>T√§gliches Limit pro Nutzer
          <input type="number" data-key="spam.per_user_daily_limit" id="spam_limit" min="0" placeholder="0 = aus">
        </label>
        <label>Quota-Notify
          <select data-key="spam.quota_notify" id="spam_quota">
            <option value="">‚Äî</option>
            <option value="off">Aus</option>
            <option value="smart">Smart</option>
            <option value="always">Immer</option>
          </select>
        </label>
      </div>
    </section>

    <!-- RSS -->
    <section class="card" id="sec-rss">
      <div class="grid">
        <label>RSS-Feed URL
          <input type="text" id="rss_url" data-validate="url" placeholder="https://example.com/feed.xml"/>
          <div class="err" hidden id="err_rssurl"></div>
        </label>
        <label>Topic (ID)
          <input type="text" id="rss_topic" data-validate="int" placeholder="0 = Standard"/>
          <div class="err" hidden id="err_rsstopic"></div>
        </label>
      </div>
      <div class="row">
        <label class="switch"><input type="checkbox" id="rss_postimg"> Beitragsbilder posten</label>
        <label class="switch"><input type="checkbox" id="rss_enabled" checked> Feed aktivieren</label>
        <button class="btn small" id="rss_add">Hinzuf√ºgen</button>
      </div>
      <div class="sep"></div>
      <div id="rssList" class="list"></div>
      <div class="hint">Bestehende Feeds unten verwalten.</div>
    </section>

    <!-- KI -->
    <section class="card" id="sec-ai">
      <div class="row">
        <label class="switch"><input type="checkbox" data-key="ai.on"> KI/FAQ aktiv</label>
      </div>
      <label>FAQ-Hinweis / Prompt (optional)</label>
      <textarea data-key="ai.faq" placeholder="Kurzer Hinweistext f√ºr Nutzer ‚Ä¶"></textarea>
    </section>

    <!-- KI-Moderation -->
    <section class="card" id="sec-aimod">
      <div class="grid">
        <label class="switch"><input type="checkbox" data-key="ai_mod.enabled"> Aktiviert</label>
        <label class="switch"><input type="checkbox" data-key="ai_mod.shadow_mode"> Shadow-Mode (nur loggen)</label>
      </div>
      <div class="grid">
        <label>Prim√§r-Aktion
          <select data-key="ai_mod.action_primary">
            <option value="">‚Äî</option>
            <option value="delete">L√∂schen</option>
            <option value="warn">Warnen</option>
            <option value="mute">Stummschalten</option>
          </select>
        </label>
        <label>Mute-Minuten
          <input type="number" data-key="ai_mod.mute_minutes" min="0" placeholder="0 = aus" />
        </label>
      </div>
      <div class="grid">
        <label>Warntext
          <input type="text" data-key="ai_mod.warn_text" placeholder="‚ö†Ô∏è Inhalt entfernt (KI-Moderation)."/>
        </label>
        <label>Appeal-URL
          <input type="text" data-key="ai_mod.appeal_url" placeholder="https://‚Ä¶"/>
        </label>
      </div>
      <div class="grid">
        <label>Anfragen / Minute (Max)
          <input type="number" data-key="ai_mod.max_per_min" min="1" placeholder="20" />
        </label>
        <label>Cooldown (Sekunden)
          <input type="number" data-key="ai_mod.cooldown_s" min="0" placeholder="30" />
        </label>
      </div>
      <div class="grid">
        <label class="switch"><input type="checkbox" data-key="ai_mod.exempt_admins"> Admins ausnehmen</label>
        <label class="switch"><input type="checkbox" data-key="ai_mod.exempt_topic_owner"> Topic-Owner ausnehmen</label>
      </div>
      <div class="sep"></div>
      <div class="grid">
        <label>Toxicity-Schwelle
          <input type="number" step="0.01" min="0" max="1" data-key="ai_mod.toxicity" placeholder="0.90" />
        </label>
        <label>Hate-Schwelle
          <input type="number" step="0.01" min="0" max="1" data-key="ai_mod.hate" placeholder="0.85" />
        </label>
        <label>Sexual-Schwelle
          <input type="number" step="0.01" min="0" max="1" data-key="ai_mod.sexual" placeholder="0.90" />
        </label>
        <label>Harassment-Schwelle
          <input type="number" step="0.01" min="0" max="1" data-key="ai_mod.harassment" placeholder="0.90" />
        </label>
        <label>Self-Harm-Schwelle
          <input type="number" step="0.01" min="0" max="1" data-key="ai_mod.selfharm" placeholder="0.95" />
        </label>
        <label>Violence-Schwelle
          <input type="number" step="0.01" min="0" max="1" data-key="ai_mod.violence" placeholder="0.90" />
        </label>
      </div>
    </section>

    <!-- FAQ -->
    <section class="card" id="sec-faq">
      <div class="grid">
        <label>Frage
          <input type="text" id="faq_q" placeholder="Deine Frage ‚Ä¶" />
        </label>
        <label>Antwort
          <input type="text" id="faq_a" placeholder="Kurze Antwort ‚Ä¶" />
        </label>
      </div>
      <div class="row">
        <button class="btn small" id="faq_add">Hinzuf√ºgen</button>
      </div>
      <div class="sep"></div>
      <div id="faqList" class="list"></div>
    </section>

    <!-- REPORT -->
    <section class="card" id="sec-report">
      <div class="grid">
        <label class="switch"><input type="checkbox" data-key="report.enabled"> T√§glichen Report aktiv</label>
        <div>
          <label>Ziel</label>
          <div class="row">
            <label class="switch"><input type="radio" name="report_dest" id="report_dest_dm" value="dm"> Per DM</label>
            <label class="switch"><input type="radio" name="report_dest" id="report_dest_topic" value="topic"> In Topic</label>
          </div>
          <div class="hint">W√§hle ‚ÄûIn Topic‚Äú und gib unten die Topic-ID deiner Gruppe (z. B. ‚ÄûGeneral‚Äú) an.</div>
        </div>
        <label>Topic (ID)
          <input type="text" data-key="report.topic" data-validate="int" placeholder="0 = Standard; sonst ID von ‚ÄûGeneral‚Äú"/>
          <div class="err" hidden id="err_reporttopic"></div>
        </label>
      </div>
      <div class="row">
        <button class="btn small" id="report_send_now" type="button">Report jetzt posten</button>
      </div>
      <div class="sep"></div>
      <div class="hint">Vorschau/Statistik (aus Datenbank):</div>
      <div id="reportStats" class="list"></div>
    </section>

    <!-- MOOD -->
    <section class="card" id="sec-mood">
      <div class="grid">
        <label>Frage (Stimmungsumfrage)
          <input type="text" data-key="mood.question" placeholder="Wie ist deine Stimmung heute?" />
        </label>
        <label>Topic (ID)
          <input type="text" data-key="mood.topic" data-validate="int" placeholder="0 = Standard" />
          <div class="err" hidden id="err_moodtopic"></div>
        </label>
      </div>
      <div class="row">
        <button class="btn small" id="mood_send_now" type="button">Mood-Frage jetzt senden</button>
      </div>
    </section>

    <!-- NIGHT MODE -->
    <section class="card" id="sec-night">
      <div class="grid">
        <label class="switch"><input type="checkbox" data-key="night.on"> Nachtmodus aktiv</label>
        <label>Start (HH:MM)
          <input type="text" data-key="night.start" data-validate="time" placeholder="22:00" />
          <div class="err" hidden id="err_nstart"></div>
        </label>
        <label>Ende (HH:MM)
          <input type="text" data-key="night.end" data-validate="time" placeholder="07:00" />
          <div class="err" hidden id="err_nend"></div>
        </label>
      </div>
      <div class="grid">
        <label class="switch"><input type="checkbox" data-key="night.delete_non_admin_msgs"> Nicht-Admin-Nachrichten l√∂schen</label>
        <label class="switch"><input type="checkbox" data-key="night.warn_once"> Einmalige Warnung anzeigen</label>
        <label>Zeitzone
          <input type="text" data-key="night.timezone" placeholder="Europe/Berlin" />
        </label>
        <label class="switch"><input type="checkbox" data-key="night.hard_mode"> Hard-Mode</label>
      </div>
      <div class="grid">
        <label>Tempor√§r bis (Override)
          <input type="datetime-local" data-key="night.override_until" />
        </label>
      </div>
    </section>

    <!-- TOPIC ROUTER -->
    <section class="card" id="sec-router">
      <div class="grid">
        <label>Ziel-Topic (ID)
          <input type="text" id="router_target" data-validate="int" placeholder="Topic ID" />
          <div class="err" hidden id="err_rtarget"></div>
        </label>
        <label>Keywords (Komma getrennt)
          <input type="text" id="router_keywords" placeholder="hilfe, frage, support" />
        </label>
        <label>Domains (Komma getrennt)
          <input type="text" id="router_domains" placeholder="example.com, foo.bar" />
        </label>
      </div>
      <div class="row">
        <label class="switch"><input type="checkbox" id="router_delete" checked> Original l√∂schen</label>
        <label class="switch"><input type="checkbox" id="router_warn" checked> Nutzer warnen</label>
        <button class="btn small" id="router_add">Regel anlegen</button>
      </div>
      <div class="sep"></div>
      <div id="routerList" class="list"></div>
    </section>

    <!-- MORE -->
    <section class="card" id="sec-more">
      <div class="row">
        <label>Sprache
          <select data-key="language">
            <option value="">Automatisch</option>
            <option value="de">Deutsch</option>
            <option value="en">English</option>
            <option value="fr">Fran√ßais</option>
            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
          </select>
        </label>
      </div>
    </section>

    <!-- PRO -->
    <section class="card" id="sec-pro">
      <div class="row">
        <label>Pro-Monate kaufen/verl√§ngern
          <input type="number" id="pro_months" data-validate="int" min="1" placeholder="z.B. 1" />
        </label>
        <button class="btn small" id="pro_buy">Abo setzen</button>
      </div>
    </section>

  </div>

  <!-- Footerbar unten -->
  <div class="footerbar">
    <div id="out" class="hint">Bereit.</div>
    <div class="right">
      <button class="btn ghost" id="themeBtn" title="Hell/Dunkel">üåì</button>
      <button class="btn ghost" id="resetBtn">Zur√ºcksetzen</button>
      <button class="btn ghost" id="closeBtn">Schlie√üen</button>
      <button class="btn primary" id="saveBtn" disabled>Speichern</button>
    </div>
  </div>

  <script>
    // --- Helpers ---
    const qs=(s,el=document)=>el.querySelector(s);
    const qa=(s,el=document)=>Array.from(el.querySelectorAll(s));
    const getUrlParam=(k, def=null)=> new URL(location.href).searchParams.get(k) ?? def;
    const FORCE_HTTP = new URL(location.href).searchParams.get('forceHttp') === '1';

    // Telegram Context
    const tg = window.Telegram?.WebApp || null;
    tg?.ready?.();                                // <<< neu
    const INIT_DATA = tg?.initData || "";         // <<< neu

    const uid = parseInt(getUrlParam("uid")||tg?.initDataUnsafe?.user?.id||0);
    const cid = parseInt(getUrlParam("cid")||0);
    const API_BASE = getUrlParam("api","") || ""; // z.B. leer lassen (empfohlen)

    // Theme
    const themeKey = "emerald-theme";
    const currentTheme = localStorage.getItem(themeKey) || "dark";
    document.documentElement.setAttribute("data-theme", currentTheme);
    qs("#themeBtn").onclick=()=>{
      const cur = document.documentElement.getAttribute("data-theme")||"dark";
      const next = cur==="dark"?"light":"dark";
      document.documentElement.setAttribute("data-theme", next);
      localStorage.setItem(themeKey, next);
    };

    // Tabs
    qa('#tabs .pill').forEach(p=>p.addEventListener('click',()=>{
      qa('#tabs .pill').forEach(x=>x.classList.remove('active'));
      p.classList.add('active');
      qa('.card').forEach(s=>s.classList.remove('active'));
      qs('#sec-'+p.dataset.tab).classList.add('active');
    }));

    // Buttons
    qs('#closeBtn').onclick=()=>{ try{ tg.close(); }catch{ window.close(); } };
    qs('#resetBtn').onclick=()=>loadState();
    qs('#saveBtn').onclick=()=>sendPayload();

    // Live-Validierung
    function validTime(val){
      const m=/^([01]?\d|2[0-3]):([0-5]\d)$/.exec((val||"").trim());
      return !!m;
    }
    function validInt(val){
      const s=(val??"").toString().trim();
      return s==="" || /^-?\d+$/.test(s);
    }
    function validUrl(val){
      try{ const u=new URL(val); return !!u.protocol && !!u.host; }catch{ return false; }
    }
    function showErr(id,msg){ const el=qs('#'+id); if(!el) return; if(msg){ el.textContent=msg; el.hidden=false; } else { el.hidden=true; el.textContent=''; } }
    function mark(el, bad){ el.classList.toggle('input-error', !!bad); }
    function validateAll(){
      let ok=true;

      // Times
      const ns=qa('[data-key="night.start"]')[0]; const ne=qa('[data-key="night.end"]')[0];
      if(ns){ const v=ns.value; const bad=!validTime(v); mark(ns,bad); showErr('err_nstart', bad?'Ung√ºltige Zeit (HH:MM)':'' ); ok=ok && !bad; }
      if(ne){ const v=ne.value; const bad=!validTime(v); mark(ne,bad); showErr('err_nend', bad?'Ung√ºltige Zeit (HH:MM)':'' ); ok=ok && !bad; }

      // Int-Felder
      [['spam.policy_topic','err_spamtopic'],
       ['report.topic','err_reporttopic'],
       ['mood.topic','err_moodtopic']].forEach(([k,err])=>{
         const el=qa(`[data-key="${k}"]`)[0]; if(!el) return;
         const bad=!validInt(el.value); mark(el,bad); showErr(err, bad?'Nur ganze Zahl erlaubt':'' ); ok=ok && !bad;
       });
      const rtopic=qs('#rss_topic'); if(rtopic){ const bad=!validInt(rtopic.value); mark(rtopic,bad); showErr('err_rsstopic', bad?'Nur ganze Zahl erlaubt':'' ); ok=ok && !bad; }
      const rtarget=qs('#router_target'); if(rtarget){ const bad=!validInt(rtarget.value); mark(rtarget,bad); showErr('err_rtarget', bad?'Nur ganze Zahl erlaubt':'' ); ok=ok && !bad; }

      // URL
      const rurl=qs('#rss_url'); if(rurl && rurl.value.trim()){ const bad=!validUrl(rurl.value.trim()); mark(rurl,bad); showErr('err_rssurl', bad?'Ung√ºltige URL':'' ); ok=ok && !bad; } else { showErr('err_rssurl',''); mark(rurl,false); }

      qs('#saveBtn').disabled = !ok;
      return ok;
    }
    qa('input,textarea,select').forEach(el=>el.addEventListener('input', validateAll));

    // --- Image Upload Handling (Welcome/Rules/Farewell) ---
    const IMG_PREV = { welcome: qs('#welcome_img_prev'), rules: qs('#rules_img_prev'), farewell: qs('#farewell_img_prev') };
    const IMG_INPUT = { welcome: qs('#welcome_img'), rules: qs('#rules_img'), farewell: qs('#farewell_img') };
    const IMG_CLEAR_BTN = { welcome: qs('#welcome_img_clear'), rules: qs('#rules_img_clear'), farewell: qs('#farewell_img_clear') };
    const IMG_UPLOADS = { welcome:null, rules:null, farewell:null };  // base64
    const PREV_IMAGES = { welcome:null, rules:null, farewell:null };  // bestehende URLs aus DB
    const CLEAR_FLAGS = { welcome:false, rules:false, farewell:false };

    function readAsDataURL(file){
      return new Promise((resolve,reject)=>{
        const r=new FileReader(); r.onload=()=>resolve(r.result); r.onerror=reject; r.readAsDataURL(file);
      });
    }
    function setPreview(which, url){
      if(!IMG_PREV[which]) return;
      if(url){ IMG_PREV[which].src=url; IMG_PREV[which].style.visibility='visible'; }
      else { IMG_PREV[which].removeAttribute('src'); IMG_PREV[which].style.visibility='hidden'; }
    }
    Object.keys(IMG_INPUT).forEach(k=>{
      const inp=IMG_INPUT[k]; if(!inp) return;
      inp.addEventListener('change', async ()=>{
        const f=inp.files?.[0]; if(!f) return;
        const dataUrl=await readAsDataURL(f);
        IMG_UPLOADS[k]=dataUrl; CLEAR_FLAGS[k]=false; setPreview(k, dataUrl); validateAll();
      });
    });
    Object.keys(IMG_CLEAR_BTN).forEach(k=>{
      const btn=IMG_CLEAR_BTN[k]; if(!btn) return;
      btn.addEventListener('click', ()=>{
        IMG_UPLOADS[k]=null; CLEAR_FLAGS[k]=true; if(IMG_INPUT[k]) IMG_INPUT[k].value="";
        setPreview(k,null);
      });
    });

    // --- Report: helper + Vorschau ---
    function getReportDest(){ return qs('#report_dest_topic')?.checked ? 'topic' : 'dm'; }
    function renderReportStats(stats){
      const box=qs('#reportStats'); if(!box) return; box.innerHTML='';
      if(!stats || (Array.isArray(stats)&&stats.length===0)){ box.innerHTML='<div class="hint">Keine Daten vorhanden.</div>'; return; }
      if(Array.isArray(stats)){
        stats.forEach(s=>{
          const item=document.createElement('div'); item.className='item';
          const left=document.createElement('div'); left.className='left';
          left.innerHTML=`<div class="title">${s.name??s.metric??'Wert'}</div><div class="hint">${s.value??s.count??''}</div>`;
          item.append(left); box.append(item);
        });
      } else if(typeof stats==='object'){
        Object.entries(stats).forEach(([k,v])=>{
          const item=document.createElement('div'); item.className='item';
          const left=document.createElement('div'); left.className='left';
          left.innerHTML=`<div class="title">${k}</div><div class="hint">${v}</div>`;
          item.append(left); box.append(item);
        });
      }
    }
    qs('#report_send_now')?.addEventListener('click', ()=>{
      const topic = parseInt((qa('[data-key="report.topic"]')[0]?.value||'0'));
      sendPayload({ report_send_now: { dest:getReportDest(), topic:isNaN(topic)?0:topic } });
    });
    qs('#mood_send_now')?.addEventListener('click', ()=>{ sendPayload({ mood_send_now: true }); });

    // RSS Ops
    qs('#rss_add').onclick=()=>{
      if(!validateAll()) return;
      const url = qs('#rss_url').value.trim();
      if(!url) return;
      const topic = parseInt(qs('#rss_topic').value.trim()||'0');
      sendPayload({ rss: { url, topic, post_images: qs('#rss_postimg').checked, enabled: qs('#rss_enabled').checked } });
    };

    // FAQ Ops
    qs('#faq_add').onclick=()=>{
      const q = qs('#faq_q').value.trim();
      const a = qs('#faq_a').value.trim();
      if(!q) return;
      sendPayload({ faq_add: { q, a } });
    };

    // Router Ops
    qs('#router_add').onclick=()=>{
      if(!validateAll()) return;
      const target = parseInt(qs('#router_target').value.trim()||'0');
      if(!target) return;
      const kw = qs('#router_keywords').value.split(',').map(s=>s.trim()).filter(Boolean);
      const dom = qs('#router_domains').value.split(',').map(s=>s.trim()).filter(Boolean);
      sendPayload({ router_add: { target_topic_id: target, keywords: kw, domains: dom, delete_original: qs('#router_delete').checked, warn_user: qs('#router_warn').checked } });
    };

    // Pro
    qs('#pro_buy').onclick=()=>{
      if(!validateAll()) return;
      const months = parseInt(qs('#pro_months').value||'0');
      if(months>0) sendPayload({ pro_months: months });
    };

    // Collect nested
    function setVal(path, val){
      const el = qa(`[data-key="${path}"]`)[0];
      if(!el) return;
      if(el.type==='checkbox') el.checked = !!val; else el.value = (val ?? '')
    }
    function collect(){
      const out = {};
      qa('[data-key]').forEach(el=>{
        const path = el.getAttribute('data-key');
        const parts = path.split('.');
        let cur = out;
        for(let i=0;i<parts.length-1;i++){ if(!(parts[i] in cur)) cur[parts[i]]={}; cur=cur[parts[i]]; }
        const leaf = parts[parts.length-1];
        let val = (el.type==='checkbox') ? !!el.checked : el.value;
        if(el.type==='number') val = el.value===''? '' : (Number(el.value));
        cur[leaf]=val;
      });
      return out;
    }

    // Render helper
    function renderRss(feeds){
      const box = qs('#rssList'); box.innerHTML='';
      (feeds||[]).forEach(f=>{
        const item = document.createElement('div'); item.className='item';
        const left = document.createElement('div'); left.className='left';
        left.innerHTML = `<div class="title">${f.url}</div><div class="hint">Topic: ${f.topic ?? 0}</div>`;
        const right = document.createElement('div');
        right.innerHTML = `
          <label class="switch"><input type="checkbox" ${f.enabled? 'checked':''} data-url="${f.url}" class="rss-toggle"> Aktiv</label>
          <label class="switch"><input type="checkbox" ${f.post_images? 'checked':''} data-url="${f.url}" class="rss-img"> Bilder</label>
          <button class="btn small danger rss-del" data-url="${f.url}">L√∂schen</button>`;
        item.append(left,right); box.append(item);
      });
      qa('.rss-del', box).forEach(b=>b.onclick=()=>sendPayload({ rss_del: b.dataset.url }));
      qa('.rss-toggle', box).forEach(ch=>ch.onchange=()=>sendPayload({ rss_update: { url: ch.dataset.url, enabled: ch.checked } }));
      qa('.rss-img', box).forEach(ch=>ch.onchange=()=>sendPayload({ rss_update: { url: ch.dataset.url, post_images: ch.checked } }));
    }
    function renderFaq(list){
      const box = qs('#faqList'); box.innerHTML='';
      (list||[]).forEach(f=>{
        const item = document.createElement('div'); item.className='item';
        const left = document.createElement('div'); left.className='left';
        left.innerHTML = `<div class="title">${f.q}</div><div class="hint">${f.a||''}</div>`;
        const del = document.createElement('button'); del.className='btn small danger'; del.textContent='L√∂schen';
        del.onclick=()=>sendPayload({ faq_del: { q: f.q } });
        item.append(left, del); box.append(item);
      });
    }
    function renderRouter(list){
      const box = qs('#routerList'); box.innerHTML='';
      (list||[]).forEach(r=>{
        const item = document.createElement('div'); item.className='item';
        const left = document.createElement('div'); left.className='left';
        left.innerHTML = `<div class="title">Rule #${r.rule_id} ‚Üí Topic ${r.target_topic_id}</div><div class="hint">${(r.keywords||[]).join(', ')} ${(r.domains||[]).join(', ')}</div>`;
        const right = document.createElement('div'); right.className='right';
        right.innerHTML = `<span class="hint">${r.enabled? 'aktiv':'inaktiv'}</span>`;
        item.append(left,right); box.append(item);
      });
    }

    // Load state
    async function loadState(){
      qs('#out').textContent='Lade ‚Ä¶';
      try{
        const res = await fetch(`${API_BASE}/miniapp/state?cid=${cid}`, {
          method: "GET",
          mode: "cors",
          credentials: "omit",
          headers: {
            "Content-Type": "application/json",
            "X-Telegram-Init-Data": INIT_DATA      // <<< wichtig
          }
        });
        const j = await res.json();
        // Welcome/Rules/Farewell
        setVal('welcome.on', j.welcome?.on);
        setVal('welcome.text', j.welcome?.text);
        setPreview('welcome',  j.welcome?.image_url || j.welcome?.image);
        PREV_IMAGES.welcome = j.welcome?.image_url || j.welcome?.image || null;
        setVal('rules.on', j.rules?.on); setVal('rules.text', j.rules?.text);
        setPreview('rules',    j.rules?.image_url   || j.rules?.image);
        PREV_IMAGES.rules   = j.rules?.image_url   || j.rules?.image   || null;
        setVal('farewell.on', j.farewell?.on); setVal('farewell.text', j.farewell?.text);
        setPreview('farewell', j.farewell?.image_url|| j.farewell?.image);
        PREV_IMAGES.farewell= j.farewell?.image_url|| j.farewell?.image|| null;
        // Spam
        setVal('spam.on', j.spam?.on ?? j.links?.only_admin_links ?? false);
        setVal('spam.block_links', j.spam?.block_links ?? j.links?.only_admin_links ?? false);
        setVal('spam.block_media', j.spam?.block_media ?? false);
        setVal('spam.block_invite_links', j.spam?.block_invite_links ?? false);
        setVal('spam.policy_topic', j.spam?.policy_topic ?? 0);
        if(Array.isArray(j.spam?.whitelist)) qs('#spam_whitelist').value=(j.spam.whitelist||[]).join('\n');
        if(Array.isArray(j.spam?.blacklist)) qs('#spam_blacklist').value=(j.spam.blacklist||[]).join('\n');
        setVal('spam.action', j.spam?.action ?? '');
        setVal('spam.per_user_daily_limit', j.spam?.per_user_daily_limit ?? 0);
        setVal('spam.quota_notify', j.spam?.quota_notify ?? '');
        // RSS
        renderRss(j.rss?.feeds||[]);
        // AI
        setVal('ai.on', j.ai?.on ?? (j.ai?.faq || j.ai?.rss));
        setVal('ai.faq', j.ai?.faq ?? '');
        // AIMOD
        const am = j.aimod||{};
        setVal('ai_mod.enabled', am.enabled);
        setVal('ai_mod.shadow_mode', am.shadow_mode);
        setVal('ai_mod.action_primary', am.action_primary);
        setVal('ai_mod.mute_minutes', am.mute_minutes);
        setVal('ai_mod.warn_text', am.warn_text);
        setVal('ai_mod.appeal_url', am.appeal_url);
        setVal('ai_mod.max_per_min', am.max_calls_per_min);
        setVal('ai_mod.cooldown_s', am.cooldown_s);
        setVal('ai_mod.exempt_admins', am.exempt_admins);
        setVal('ai_mod.exempt_topic_owner', am.exempt_topic_owner);
        setVal('ai_mod.toxicity', am.toxicity ?? am.tox_thresh);
        setVal('ai_mod.hate', am.hate ?? am.hate_thresh);
        setVal('ai_mod.sexual', am.sexual ?? am.sex_thresh);
        setVal('ai_mod.harassment', am.harassment ?? am.harass_thresh);
        setVal('ai_mod.selfharm', am.selfharm ?? am.selfharm_thresh);
        setVal('ai_mod.violence', am.violence ?? am.violence_thresh);
        // FAQ & Router
        renderFaq(j.faqs||[]);
        renderRouter(j.router_rules||[]);
        // Report
        const rep = j.report || {};
        setVal('report.enabled', rep.enabled ?? (!!j.daily_stats));
        if(qs('#report_dest_dm'))    qs('#report_dest_dm').checked    = (rep.dest ?? (j.daily_stats? 'dm':'dm')) === 'dm';
        if(qs('#report_dest_topic')) qs('#report_dest_topic').checked = (rep.dest ?? (j.daily_stats? 'dm':'dm')) === 'topic';
        setVal('report.topic', rep.topic ?? 0);
        renderReportStats(rep.stats || j.stats || []);
        // Mood
        setVal('mood.question', j.mood?.question);
        setVal('mood.topic', j.mood?.topic);
        // Night
        const n=j.night||{}; setVal('night.on', n.enabled); setVal('night.start', n.start||'22:00'); setVal('night.end', n.end||'07:00');
        setVal('night.delete_non_admin_msgs', n.delete_non_admin_msgs);
        setVal('night.warn_once', n.warn_once);
        setVal('night.timezone', n.timezone||'Europe/Berlin');
        setVal('night.hard_mode', n.hard_mode);
        // More
        setVal('language', j.language||'');
        qs('#out').textContent='Bereit.';
      }catch(e){ console.error(e); qs('#out').textContent='Fehler beim Laden.'; }
      validateAll();
    }

    // Save: Telegram sendData ODER HTTP-Fallback
    async function sendPayload(extra={}){
      if(!validateAll()) return;
      const out = collect();
      const imgExtra = {};
      ['welcome','rules','farewell'].forEach(k=>{
        if(IMG_UPLOADS[k]) imgExtra[`${k}_image_upload`] = IMG_UPLOADS[k];
        else if(CLEAR_FLAGS[k] && PREV_IMAGES[k]) imgExtra[`${k}_image_del`] = true;
      });
      Object.assign(out, { cid, uid }, { report: { dest: (typeof getReportDest==='function'? getReportDest() : 'dm') } }, imgExtra, extra);
      if (tg && tg.sendData){
        try{ tg.HapticFeedback?.impactOccurred?.('medium'); }catch{}
        tg.sendData(JSON.stringify(out));
        qs('#out').textContent = 'Gesendet (Telegram).';
      } else if(API_BASE){
        try{
          const res = await fetch(`${API_BASE}/miniapp/apply?cid=${cid}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Telegram-Init-Data": INIT_DATA      // <<< wichtig
            },
            body: JSON.stringify(out)
          });
          const txt = await res.text();
          qs('#out').textContent = res.ok ? (txt || '‚úÖ Einstellungen gespeichert.') : (`‚ö†Ô∏è ${txt||'Fehler beim Speichern.'}`);
        }catch(e){
          console.error(e);
          qs('#out').textContent = 'Verbindungsfehler.';
        }
      } else {
        qs('#out').textContent = 'Nicht in Telegram ge√∂ffnet ‚Äì Speichern nicht m√∂glich.';
      }
    }

    // Init
    loadState();
  </script>
</body>
</html>

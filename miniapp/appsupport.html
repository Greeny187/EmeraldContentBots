<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="backend" content="" /> <!-- Optional: API-Basis hier eintragen, sonst ?api=... nutzen -->
  <title>Emerald Support • Mini‑App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg: var(--tg-theme-bg-color, #0b0d10);
      --text: var(--tg-theme-text-color, #e7ecef);
      --muted: #9aa3ab;
      --card: rgba(255,255,255,.04);
      --border: rgba(255,255,255,.08);
      --primary: var(--tg-theme-button-color, #1bb56b);
      --primary-text: var(--tg-theme-button-text-color, #0a0d0b);
      --danger: #e25555;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    header.ec-header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);backdrop-filter:blur(6px)}
    .brand{font-weight:800;letter-spacing:.3px}
    .brand span{color:var(--primary)}
    .tabs{display:flex;gap:8px}
    .tabs button{background:transparent;color:var(--text);border:1px solid var(--border);padding:8px 12px;border-radius:12px;cursor:pointer;opacity:.9}
    .tabs button.active{border-color:var(--primary);opacity:1}
    main{padding:16px;display:block}
    .tab{display:none}
    .tab.active{display:block}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.2)}
    .grid2{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:740px){.grid2{grid-template-columns:1fr 1fr}}
    .row{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
    label{font-size:12px;color:var(--muted)}
    input[type="text"],input[type="search"],select,textarea{background:transparent;color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px 12px;outline:none}
    textarea{resize:vertical}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:6px}
    .btn{border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--primary);color:var(--primary-text)}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btn.danger{background:var(--danger);color:#fff}
    .switch{position:relative;display:inline-block;width:44px;height:24px}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#2a2e33;border:1px solid var(--border);transition:.2s;border-radius:999px}
    .slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:2.5px;background:#b8bfc6;transition:.2s;border-radius:50%}
    .switch input:checked + .slider{background:var(--primary)}
    .switch input:checked + .slider:before{transform:translateX(20px);background:var(--primary-text)}
    .list{display:grid;gap:12px}
    .ticket{border:1px solid var(--border);border-radius:14px;padding:12px}
    .ticket .meta{display:flex;gap:8px;font-size:12px;color:var(--muted);margin-bottom:6px;flex-wrap:wrap}
    .ticket .subject{font-weight:700;margin-bottom:6px}
    .status{padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:11px}
    .muted{color:var(--muted)}
    footer.ec-footer{padding:24px 16px;text-align:center;color:var(--muted)}
    .subtabs{display:flex;gap:6px;margin:8px 0 12px}
    .subtabs .chip{padding:8px 10px;border:1px solid var(--border);border-radius:999px;cursor:pointer}
    .chip.active{border-color:var(--primary)}
    .hint{font-size:12px;color:var(--muted)}
    .ok{color:#7cd992}
    .err{color:#ff8a8a}
    .inline{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <header class="ec-header">
    <div class="brand">Emerald <span>Support</span></div>
    <nav class="tabs">
      <button data-tab="support" class="active">Support</button>
      <button data-tab="setup">Gruppen‑Setup</button>
      <button data-tab="stats">Statistiken</button>
    </nav>
  </header>

  <main>
    <!-- TAB: SUPPORT -->
    <section id="tab-support" class="tab active">
      <div class="subtabs" role="tablist">
        <div class="chip active" data-subtab="create">Neue Anfrage</div>
        <div class="chip" data-subtab="mine">Meine Tickets</div>
        <div class="chip" data-subtab="kb">KB‑Suche</div>
      </div>

      <!-- CREATE -->
      <div id="sub-create" class="card">
        <div class="grid2">
          <div class="row">
            <label>Kategorie</label>
            <select id="new-category">
              <option value="allgemein">Allgemein</option>
              <option value="technik">Technik</option>
              <option value="zahlungen">Zahlungen</option>
              <option value="konto">Konto</option>
              <option value="feedback">Feedback</option>
            </select>
          </div>
          <div class="row">
            <label>Betreff</label>
            <input id="new-subject" type="text" maxlength="140" placeholder="Kurz und prägnant…" />
          </div>
        </div>
        <div class="row">
          <label>Beschreibung</label>
          <textarea id="new-body" rows="6" maxlength="4000" placeholder="Was ist passiert? Schritte, erwartetes Verhalten, ggf. Links…"></textarea>
        </div>
        <div class="actions">
          <button id="btn-create" class="btn primary">Ticket erstellen</button>
          <button id="btn-clear" class="btn ghost">Zurücksetzen</button>
        </div>
        <div id="suggest" class="row"></div>
      </div>

      <!-- MINE -->
      <div id="sub-mine" class="card" style="display:none">
        <div id="mine-list" class="list"></div>
      </div>

      <!-- KB -->
      <div id="sub-kb" class="card" style="display:none">
        <div class="row"><input id="kb-q" type="search" placeholder="Suchwort…" /></div>
        <div id="kb-results" class="list"></div>
      </div>
    </section>

    <!-- TAB: SETUP (Content‑Bot‑Style Settings) -->
    <section id="tab-setup" class="tab">
      <div class="grid2">
        <div class="card">
          <div class="row inline"><label>Welcome aktivieren</label><label class="switch"><input id="welcome_on" type="checkbox"><span class="slider"></span></label></div>
          <div class="row"><label>Welcome‑Text</label><textarea id="welcome_text" rows="3" placeholder="Willkommen bei …"></textarea></div>
        </div>
        <div class="card">
          <div class="row inline"><label>Farewell aktivieren</label><label class="switch"><input id="farewell_on" type="checkbox"><span class="slider"></span></label></div>
          <div class="row"><label>Farewell‑Text</label><textarea id="farewell_text" rows="3" placeholder="Schade, dass du gehst …"></textarea></div>
        </div>
      </div>

      <div class="grid2">
        <div class="card">
          <div class="row inline"><label>Regeln posten</label><label class="switch"><input id="rules_on" type="checkbox"><span class="slider"></span></label></div>
          <div class="row"><label>Regel‑Text</label><textarea id="rules_text" rows="4" placeholder="1) …\n2) …"></textarea></div>
        </div>
        <div class="card">
          <div class="row inline"><label>Nur Admin‑Links</label><label class="switch"><input id="admins_only" type="checkbox"><span class="slider"></span></label></div>
          <div class="row inline"><label>Warnung senden</label><label class="switch"><input id="warning_on" type="checkbox"><span class="slider"></span></label></div>
          <div class="row"><label>Warntext</label><input id="warning_text" type="text" placeholder="Links nur mit Freigabe …" /></div>
          <div class="row inline"><label>Ausnahmen aktivieren</label><label class="switch"><input id="exceptions_on" type="checkbox"><span class="slider"></span></label></div>
        </div>
      </div>

      <div class="grid2">
        <div class="card">
          <div class="row inline"><label>AI‑FAQ</label><label class="switch"><input id="ai_faq" type="checkbox" checked><span class="slider"></span></label></div>
          <div class="row inline"><label>AI‑RSS</label><label class="switch"><input id="ai_rss" type="checkbox"><span class="slider"></span></label></div>
        </div>
        <div class="card">
          <div class="row"><label>Stimmungs‑Thema</label><input id="mood_topic" type="text" placeholder="Tägliche Frage …" /></div>
          <div class="row"><label>Frage</label><input id="mood_question" type="text" value="Wie war dein Tag von 1–5?" /></div>
          <div class="row inline"><label>Tägliche Kurz‑Stats posten</label><label class="switch"><input id="daily_stats" type="checkbox"><span class="slider"></span></label></div>
        </div>
      </div>

      <div class="actions">
        <button id="btn-save" class="btn primary">Speichern</button>
        <span id="save-status" class="hint"></span>
      </div>
    </section>

  <footer class="ec-footer">Emerald Support • v0.1</footer>

  <script>
    const tg = window.Telegram.WebApp;
    try { tg.expand(); } catch (e) {}

    // API Basis ermitteln
    const metaBackend = document.querySelector('meta[name="backend"]').content;
    const apiBase = (new URLSearchParams(location.search).get('api') || metaBackend || (location.hostname.includes('localhost') ? 'http://localhost:8000' : 'https://YOUR-API-DOMAIN')).replace(/\/$/, '') + '/api/support';

    // Hilfen
    const qs = sel => document.querySelector(sel);
    const qsa = sel => Array.from(document.querySelectorAll(sel));
    const h = () => ({ 'X-Telegram-Init-Data': tg.initData || '' , 'Content-Type': 'application/json' });
    const param = k => new URLSearchParams(location.search).get(k);
    const cid = param('cid');
    const title = param('title') ? decodeURIComponent(param('title')) : '';
    const uid = (tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) ? tg.initDataUnsafe.user.id : 0;

    // Tabs
    qsa('.tabs button').forEach(b => b.addEventListener('click', () => {
      qsa('.tabs button').forEach(x => x.classList.remove('active'));
      b.classList.add('active');
      qsa('.tab').forEach(t => t.classList.remove('active'));
      qs('#tab-' + b.dataset.tab).classList.add('active');
      if (b.dataset.tab === 'stats') loadStats();
    }));

    // Subtabs (Support)
    qsa('.subtabs .chip').forEach(c => c.addEventListener('click', () => {
      qsa('.subtabs .chip').forEach(x => x.classList.remove('active'));
      c.classList.add('active');
      ['create','mine','kb'].forEach(k => qs('#sub-' + k).style.display = 'none');
      qs('#sub-' + c.dataset.subtab).style.display = 'block';
      if (c.dataset.subtab === 'mine') loadMyTickets();
    }));

    // Tickets – erstellen
    async function createTicket(){
      const category = qs('#new-category').value;
      const subject = qs('#new-subject').value.trim();
      const body = qs('#new-body').value.trim();
      if (subject.length < 4 || body.length < 10){
        alert('Bitte Betreff (≥4) und Beschreibung (≥10) ausfüllen.');
        return;
      }
      try {
        tg.MainButton.showProgress?.();
        const r = await fetch(`${apiBase}/tickets`, { method: 'POST', headers: h(), body: JSON.stringify({category, subject, body}) });
        if (!r.ok) throw new Error(await r.text());
        const data = await r.json();
        tg.HapticFeedback.notificationOccurred('success');
        alert('✅ Ticket #' + data.ticket_id + ' erstellt.');
        qs('#new-subject').value='';
        qs('#new-body').value='';
        qs('#suggest').innerHTML='';
      } catch(e){
        tg.HapticFeedback.notificationOccurred('error');
        alert('Fehler: ' + e.message);
      } finally {
        tg.MainButton.hideProgress?.();
      }
    }
    qs('#btn-create').addEventListener('click', createTicket);
    qs('#btn-clear').addEventListener('click', () => { qs('#new-subject').value=''; qs('#new-body').value=''; qs('#suggest').innerHTML=''; });

    // KB‑Live‑Vorschläge beim Tippen
    let kbTimer;
    function scheduleKbSuggest(){
      clearTimeout(kbTimer);
      const q = (qs('#new-subject').value + ' ' + qs('#new-body').value).trim();
      if (q.length < 3){ qs('#suggest').innerHTML=''; return; }
      kbTimer = setTimeout(async () => {
        try {
          const r = await fetch(`${apiBase}/kb/search?q=${encodeURIComponent(q)}`, { headers: h() });
          if (!r.ok) return;
          const data = await r.json();
          const items = (data.results||[]).map(x => `
            <div class="card" style="border-style:dashed">
              <div class="inline"><strong>${x.title}</strong></div>
              <div class="muted">Tags: ${(x.tags||[]).join(', ')}</div>
              <div class="muted">${(x.snippet||'').replace(/</g,'&lt;')}</div>
            </div>`).join('');
          qs('#suggest').innerHTML = items;
        } catch(e) {}
      }, 400);
    }
    qs('#new-subject').addEventListener('input', scheduleKbSuggest);
    qs('#new-body').addEventListener('input', scheduleKbSuggest);

    // Eigene Tickets laden
    async function loadMyTickets(){
      const cont = qs('#mine-list');
      cont.innerHTML = '<div class="card">Lade …</div>';
      try {
        const r = await fetch(`${apiBase}/tickets`, { headers: h() });
        if (!r.ok) throw new Error(await r.text());
        const data = await r.json();
        if (!data.tickets?.length){ cont.innerHTML = '<div class="card">Keine Tickets.</div>'; return; }
        cont.innerHTML = data.tickets.map(t => `
          <div class="ticket">
            <div class="meta">#${t.id} • ${new Date(t.created_at).toLocaleString()} • <span class="status">${t.status}</span></div>
            <div class="subject">${t.subject}</div>
            <div class="meta">Kategorie: ${t.category}</div>
          </div>`).join('');
      } catch(e){
        cont.innerHTML = '<div class="card">Fehler beim Laden.</div>';
      }
    }

    // KB Suche
    qs('#kb-q').addEventListener('input', async () => {
      const q = qs('#kb-q').value.trim();
      const list = qs('#kb-results');
      if (q.length < 2){ list.innerHTML = ''; return; }
      try {
        const r = await fetch(`${apiBase}/kb/search?q=${encodeURIComponent(q)}`, { headers: h() });
        if (!r.ok) throw new Error(await r.text());
        const data = await r.json();
        list.innerHTML = (data.results||[]).map(x => `
          <div class="card">
            <div><strong>${x.title}</strong></div>
            <div class="muted">${(x.snippet||'').replace(/</g,'&lt;')}</div>
          </div>`).join('');
      } catch(e){ list.innerHTML = '<div class="card">Fehler.</div>'; }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="backend" content="" />
  <title>Emerald Support ‚Ä¢ Mini-App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg: var(--tg-theme-bg-color, #0b0d10);
      --text: var(--tg-theme-text-color, #e7ecef);
      --muted: #9aa3ab;
      --card: rgba(255,255,255,.04);
      --border: rgba(255,255,255,.08);
      --primary: var(--tg-theme-button-color, #1bb56b);
      --primary-text: var(--tg-theme-button-text-color, #0a0d0b);
      --danger: #e25555;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    header.ec-header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);backdrop-filter:blur(6px)}
    .brand{font-weight:800;letter-spacing:.3px}
    .brand span{color:var(--primary)}
    main{padding:16px;display:block}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.2)}
    .grid2{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:740px){.grid2{grid-template-columns:1fr 1fr}}
    .row{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
    label{font-size:12px;color:var(--muted)}
    input[type="text"],input[type="search"],select,textarea{background:transparent;color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px 12px;outline:none}
    textarea{resize:vertical}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:6px}
    .btn{border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--primary);color:var(--primary-text)}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .list{display:grid;gap:12px}
    .ticket{border:1px solid var(--border);border-radius:14px;padding:12px}
    .ticket .meta{display:flex;gap:8px;font-size:12px;color:var(--muted);margin-bottom:6px;flex-wrap:wrap}
    .ticket .subject{font-weight:700;margin-bottom:6px}
    .status{padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:11px}
    .muted{color:var(--muted)}
    footer.ec-footer{padding:24px 16px;text-align:center;color:var(--muted)}
    .subtabs{display:flex;gap:6px;margin:8px 0 12px}
    .subtabs .chip{padding:8px 10px;border:1px solid var(--border);border-radius:999px;cursor:pointer}
    .chip.active{border-color:var(--primary)}
  </style>
</head>
<body>
  <header class="ec-header">
    <div class="brand">Emerald <span>Support</span></div>
  </header>

  <main>
    <div class="subtabs" role="tablist">
      <div class="chip active" data-subtab="create">Neue Anfrage</div>
      <div class="chip" data-subtab="mine">Meine Tickets</div>
      <div class="chip" data-subtab="kb">KB-Suche</div>
    </div>

    <!-- CREATE -->
    <div id="sub-create" class="card">
      <div class="grid2">
        <div class="row">
          <label>Kategorie</label>
          <select id="new-category">
            <option value="allgemein">Allgemein</option>
            <option value="technik">Technik</option>
            <option value="zahlungen">Zahlungen</option>
            <option value="konto">Konto</option>
            <option value="feedback">Feedback</option>
          </select>
        </div>
        <div class="row">
          <label>Betreff</label>
          <input id="new-subject" type="text" maxlength="140" placeholder="Kurz und pr√§gnant‚Ä¶" />
        </div>
      </div>
      <div class="row">
        <label>Beschreibung</label>
        <textarea id="new-body" rows="6" maxlength="4000" placeholder="Was ist passiert? Schritte, erwartetes Verhalten, ggf. Links‚Ä¶"></textarea>
      </div>
      <div class="actions">
        <button id="btn-create" class="btn primary">Ticket erstellen</button>
        <button id="btn-clear" class="btn ghost">Zur√ºcksetzen</button>
      </div>
      <div id="suggest" class="row"></div>
    </div>

    <!-- MINE -->
    <div id="sub-mine" class="card" style="display:none">
      <div id="mine-list" class="list"></div>
    </div>

    <!-- KB -->
    <div id="sub-kb" class="card" style="display:none">
      <div class="row"><input id="kb-q" type="search" placeholder="Suchwort‚Ä¶" /></div>
      <div id="kb-results" class="list"></div>
    </div>
  </main>

  <footer class="ec-footer">Emerald Support ‚Ä¢ v1.1</footer>

  <script>
    const tg = window.Telegram.WebApp;
    try { tg.expand(); } catch (e) {}

    // API Base: Meta-Tag > Query-Param > Default
    const metaBackend = document.querySelector('meta[name="backend"]')?.content || '';
    const queryApi = new URLSearchParams(location.search).get('api');
    const defaultApi = location.hostname.includes('localhost')
      ? 'http://localhost:8000'
      : 'https://emerald-bots.herokuapp.com'; // TODO: Anpassen
    const apiBase = (queryApi || metaBackend || defaultApi).replace(/\/$/, '') + '/api/support';

    const qs = sel => document.querySelector(sel);
    const qsa = sel => Array.from(document.querySelectorAll(sel));
    const h = () => ({
      'X-Telegram-Init-Data': tg.initData || '',
      'Content-Type': 'application/json'
    });

    const param = k => new URLSearchParams(location.search).get(k);
    const cid = param('cid'); // optional
    const title = param('title') ? decodeURIComponent(param('title')) : '';
    const startTab = param('tab'); // create|mine|kb
    const uid = tg.initDataUnsafe?.user?.id || 0;

    function showSubtab(key){
      qsa('.subtabs .chip').forEach(x => x.classList.toggle('active', x.dataset.subtab === key));
      ['create','mine','kb'].forEach(k => {
        const el = qs('#sub-' + k);
        if (el) el.style.display = (k === key) ? 'block' : 'none';
      });
      if (key === 'mine') loadMyTickets();
    }

    // Subtabs
    qsa('.subtabs .chip').forEach(c => c.addEventListener('click', () => showSubtab(c.dataset.subtab)));

    // Init tab from URL
    if (startTab && ['create','mine','kb'].includes(startTab)) showSubtab(startTab);

    // CREATE TICKET
    async function createTicket(){
      const category = qs('#new-category').value;
      const subject = qs('#new-subject').value.trim();
      const body = qs('#new-body').value.trim();

      if (subject.length < 4) return alert('Betreff muss mindestens 4 Zeichen lang sein.');
      if (body.length < 10) return alert('Beschreibung muss mindestens 10 Zeichen lang sein.');

      try {
        tg.MainButton.showProgress?.();

        const qp = [];
        if (cid) qp.push('cid=' + encodeURIComponent(cid));
        if (title) qp.push('title=' + encodeURIComponent(title));
        const url = `${apiBase}/tickets` + (qp.length ? ('?' + qp.join('&')) : '');

        const r = await fetch(url, {
          method: 'POST',
          headers: h(),
          body: JSON.stringify({category, subject, body})
        });

        if (!r.ok) throw new Error(await r.text() || `HTTP ${r.status}`);

        const data = await r.json();
        tg.HapticFeedback.notificationOccurred?.('success');
        alert('‚úÖ Ticket #' + data.ticket_id + ' erstellt.');

        qs('#new-subject').value='';
        qs('#new-body').value='';
        qs('#suggest').innerHTML='';
      } catch(e){
        tg.HapticFeedback.notificationOccurred?.('error');
        alert('Fehler: ' + e.message);
      } finally {
        tg.MainButton.hideProgress?.();
      }
    }

    qs('#btn-create')?.addEventListener('click', createTicket);
    qs('#btn-clear')?.addEventListener('click', () => {
      qs('#new-subject').value='';
      qs('#new-body').value='';
      qs('#suggest').innerHTML='';
    });

    // KB LIVE Vorschl√§ge
    let kbTimer;
    function scheduleKbSuggest(){
      clearTimeout(kbTimer);
      const q = (qs('#new-subject').value + ' ' + qs('#new-body').value).trim();
      if (q.length < 3){ qs('#suggest').innerHTML=''; return; }

      kbTimer = setTimeout(async () => {
        try{
          const r = await fetch(`${apiBase}/kb/search?q=${encodeURIComponent(q)}`, { headers: h() });
          if (!r.ok) return;
          const data = await r.json();
          const items = (data.results||[]).slice(0,3).map(x => `
            <div class="card" style="border-style:dashed;border-color:var(--muted)">
              <div style="font-weight:600;margin-bottom:4px">${x.title}</div>
              <div class="muted" style="font-size:11px">${(x.snippet||'').replace(/</g,'&lt;').substring(0,100)}...</div>
            </div>`).join('');
          qs('#suggest').innerHTML = items ? '<div class="muted" style="margin-bottom:6px">üí° √Ñhnliche KB-Artikel:</div>' + items : '';
        } catch(e){
          console.log('KB suggest error', e);
        }
      }, 400);
    }
    qs('#new-subject')?.addEventListener('input', scheduleKbSuggest);
    qs('#new-body')?.addEventListener('input', scheduleKbSuggest);

    // LOAD MY TICKETS
    async function loadMyTickets(){
      const cont = qs('#mine-list');
      if (!cont) return;
      cont.innerHTML = '<div class="card">Lade ‚Ä¶</div>';

      try{
        const url = cid ? `${apiBase}/tickets?cid=${encodeURIComponent(cid)}` : `${apiBase}/tickets`;
        const r = await fetch(url, { headers: h() });
        if (!r.ok) throw new Error(await r.text());
        const data = await r.json();

        if (!data.tickets?.length){
          cont.innerHTML = '<div class="card">Keine Tickets.</div>';
          return;
        }

        cont.innerHTML = data.tickets.map(t => {
          const created = new Date(t.created_at).toLocaleDateString('de-DE', {month:'short', day:'numeric'});
          const statusEmoji = t.status === 'geloest' ? '‚úÖ' : t.status === 'in_bearbeitung' ? '‚è≥' : 'üìã';
          return `
            <div class="ticket">
              <div class="meta">#${t.id} ‚Ä¢ ${created} ‚Ä¢ <span class="status">${statusEmoji} ${t.status}</span></div>
              <div class="subject">${t.subject}</div>
              <div class="meta">Kategorie: ${t.category}</div>
            </div>`;
        }).join('');
      } catch(e){
        console.error('Error loading tickets:', e);
        cont.innerHTML = '<div class="card">Fehler beim Laden.</div>';
      }
    }

    // KB SEARCH
    qs('#kb-q')?.addEventListener('input', async () => {
      const q = qs('#kb-q').value.trim();
      const list = qs('#kb-results');
      if (!list) return;
      if (q.length < 2){ list.innerHTML=''; return; }

      try{
        const r = await fetch(`${apiBase}/kb/search?q=${encodeURIComponent(q)}`, { headers: h() });
        if (!r.ok) throw new Error(await r.text());
        const data = await r.json();
        list.innerHTML = (data.results||[]).map(x => `
          <div class="card">
            <div style="font-weight:600;margin-bottom:4px">${x.title}</div>
            <div class="muted" style="font-size:12px">${(x.snippet||'').replace(/</g,'&lt;')}</div>
          </div>`).join('');
      } catch(e){
        console.error('KB search error:', e);
        list.innerHTML = '<div class="card">Fehler.</div>';
      }
    });

    console.log('Support MiniApp initialized', {apiBase, cid, uid});
  </script>
</body>
</html>

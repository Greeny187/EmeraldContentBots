<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Emerald DevDashboard</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#0b1020; color:#cbd5e1; margin:20px; }
    .card { background:#111827; border:1px solid #1f2937; border-radius:12px; padding:16px; margin:12px 0; }
    .row  { display:flex; gap:12px; flex-wrap:wrap; }
    button { background:#10b98122; border:1px solid #10b98160; color:#e5e7eb; border-radius:8px; padding:8px 12px; cursor:pointer; }
    pre { white-space: pre-wrap; word-break: break-word; }
    .pill { padding:2px 8px; border:1px solid #374151; border-radius:999px; font-size:12px; }
    input { background:#0b1020; color:#cbd5e1; border:1px solid #1f2937; border-radius:8px; padding:6px 8px; }
    h4 { margin: 8px 0; }
  </style>

  <!-- Favicon-404 auf GitHub Pages vermeiden -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'/%3E">

  <!-- TonConnect UI (UMD) als globales Objekt laden -->
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

  <script type="module">
    // -------- NEAR WalletSelector (robust, mit Fallback auf neuere CDN) --------
    let core, modalUi, mynear;
    async function loadNearSelector(){
      try {
        [core, modalUi, mynear] = await Promise.all([
          import("https://esm.sh/@near-wallet-selector/core@8.9.1?target=es2020"),
          import("https://esm.sh/@near-wallet-selector/modal-ui@8.9.1?target=es2020"),
          import("https://esm.sh/@near-wallet-selector/my-near-wallet@8.9.1?target=es2020"),
        ]);
        return true;
      } catch(e) {
        console.warn("NEAR selector CDN problem, disabling connect.", e);
        return false;
      }
    }

    // NEAR API
    window.nearInit = async function(){
      const ok = await loadNearSelector();
      if (!ok){
        const el = document.getElementById("nearConnected");
        if (el) el.textContent = "nicht verbunden";
        return;
      }
      const { setupWalletSelector } = core;
      const { setupModal } = modalUi;
      const { setupMyNearWallet } = mynear;
      const selector = await setupWalletSelector({
        network: window.NEAR_NETWORK || "mainnet",
        modules: [ setupMyNearWallet() ],
      });
      const modal = setupModal(selector, { contractId: "example.near" });
      window.__near = { selector, modal };
      await window.nearRefreshUi();
    };
    window.nearConnect = ()=>window.__near?.modal?.show();
    window.nearDisconnect = async ()=>{
      try { const w = await window.__near.selector.wallet(); await w.signOut(); } catch {}
      await window.nearRefreshUi();
    };
    window.nearRefreshUi = async ()=>{
      try{
        const w = await window.__near.selector.wallet();
        const accs = await w.getAccounts();
        const acc = accs?.[0]?.accountId || null;
        const sEl = document.getElementById("nearConnected");
        const aEl = document.getElementById("nearAccount");
        if (sEl) sEl.textContent = acc ? "verbunden" : "nicht verbunden";
        if (aEl) aEl.textContent = acc || "—";
        if (acc){
          // serverseitig verknüpfen
          await fetch(window.API_BASE + "/wallets/near", {
            method:"POST", headers: window.authHeaders(), body: JSON.stringify({ account_id: acc })
          });
          await refreshWallets();
          await refreshPayments();
        }
      }catch{}
    };

    // -------- TON Connect (UI) --------
    // Aus globalem Namespace lesen (UMD)
    try{
      const Ctor =
        (window.TON_CONNECT_UI && window.TON_CONNECT_UI.TonConnectUI) ||
        window.TonConnectUI;
      if (Ctor) {
        const ton = new Ctor({
          manifestUrl: location.origin + location.pathname.replace(/\/[^/]*$/, "/") + "tonconnect-manifest.json"
        });
        window.tonConnect = ton;
        ton.onStatusChange(async (w)=>{
          if (w?.account?.address){
            const el = document.getElementById("tonAddress");
            if (el) el.value = w.account.address;
            await saveTon();
            await refreshPayments();
          }
        });
      } else {
        console.warn("TON Connect not available: constructor missing");
      }
    }catch(e){ console.warn("TON Connect init failed:", e); }
  </script>

  <script>
    // ------- KONFIG -------
    const API_ORIGIN = "https://emeraldcontent-aac379fc581e.herokuapp.com";
    const API_PREFIX = "/devdash";
    const api = (path) => API_ORIGIN + API_PREFIX + path;
    window.API_BASE = API_ORIGIN + API_PREFIX; // für bestehenden Code
    window.BOT_USERNAME = "EmeraldContentBot"; // Bot-Username ohne @
    window.NEAR_NETWORK = "mainnet";

    // ------- TOKEN / HEADERS -------
    const tokenKey = "emerald_token";
    function authHeaders(){
      const t = localStorage.getItem(tokenKey);
      const h = { "Content-Type":"application/json" };
      if (t) h["Authorization"] = "Bearer " + t;
      return h;
    }
    window.authHeaders = authHeaders;

    // ------- TELEGRAM LOGIN CALLBACK -------
    window.onTelegramAuth = async function(user){
      try {
        const r = await fetch(api("/auth/telegram"), {
          method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(user)
        });
        const txt = await r.text();
        if (!r.ok) { alert("Login-Fehler: " + txt); return; }
        const data = JSON.parse(txt);
        localStorage.setItem(tokenKey, data.access_token);
        const login = document.getElementById("login");
        if (login) login.style.display = "none";
        await bootAfterLogin();
      } catch (e) {
        alert("Netzwerkfehler beim Login: " + (e && e.message ? e.message : e));
      }
    };

    // ------- TELEGRAM WIDGET DYNAMISCH MOUNTEN -------
    function mountLogin(){
      const slot = document.getElementById("tgSlot");
      if (!slot) return;
      slot.innerHTML = "";
      const s = document.createElement("script");
      s.src = "https://telegram.org/js/telegram-widget.js?22";
      s.async = true;
      s.setAttribute("data-telegram-login", window.BOT_USERNAME);
      s.setAttribute("data-size", "large");
      s.setAttribute("data-userpic", "true");
      s.setAttribute("data-request-access", "write");
      s.setAttribute("data-onauth", "onTelegramAuth");
      slot.appendChild(s);
    }

    // ------- OPTIONAL: Token Dynamics / Mesh (Platzhalter) -------
    async function refreshNearToken(){ const el = document.getElementById("tokenSummary"); if (el) el.textContent = "–"; }
    async function meshRefresh(){
      const hEl = document.getElementById("meshHealth");
      const mEl = document.getElementById("meshMetrics");
      if (hEl) hEl.textContent = "–";
      if (mEl) mEl.textContent = "–";
    }

    // ------- WALLET / PAYMENTS -------
    async function refreshWallets(){
      try{
        const one = await (await fetch(api("/near/account/overview?account_id=emeraldcontent.near"), { headers: authHeaders() })).json();
        const two = await (await fetch(api("/near/account/overview?account_id=pay.emeraldcontent.near"), { headers: authHeaders() })).json();
        const a1 = document.getElementById("nearAcc1");
        const a2 = document.getElementById("nearAcc2");
        if (a1) a1.textContent = JSON.stringify(one, null, 2);
        if (a2) a2.textContent = JSON.stringify(two, null, 2);
        const wallets = await (await fetch(api("/wallets"), { headers: authHeaders() })).json();
        const tonAddr = wallets?.me?.ton_address || "";
        const tonAddressEl = document.getElementById("tonAddress");
        const tonInfoEl = document.getElementById("tonInfo");
        if (tonAddressEl) tonAddressEl.value = tonAddr;
        if (tonInfoEl) tonInfoEl.textContent = JSON.stringify({ ton_address: tonAddr || null }, null, 2);
      }catch(e){ /* ignore */ }
    }
    async function refreshPayments(){
      const tokenHdr = authHeaders();
      try{
        const n1 = await (await fetch(api("/near/payments?account_id=emeraldcontent.near&limit=20"), { headers: tokenHdr })).json();
        const n2 = await (await fetch(api("/near/payments?account_id=pay.emeraldcontent.near&limit=20"), { headers: tokenHdr })).json();
        const i1 = document.getElementById("nearIn1");
        const i2 = document.getElementById("nearIn2");
        if (i1) i1.textContent = JSON.stringify(n1.incoming || n1, null, 2);
        if (i2) i2.textContent = JSON.stringify(n2.incoming || n2, null, 2);
      }catch(e){ /* ignore */ }
      try{
        const addrEl = document.getElementById("tonAddress");
        const addr = addrEl ? addrEl.value.trim() : "";
        if (addr){
          const t = await (await fetch(api("/ton/payments?address="+encodeURIComponent(addr)+"&limit=20"), { headers: tokenHdr })).json();
          const ti = document.getElementById("tonIn");
          if (ti) ti.textContent = JSON.stringify(t.incoming || t, null, 2);
        }
      }catch(e){ /* ignore */ }
    }
    async function saveTon(){
      const addressEl = document.getElementById("tonAddress");
      const address = addressEl ? addressEl.value.trim() : "";
      const r = await fetch(api("/wallets/ton"), {
        method:"POST", headers: authHeaders(), body: JSON.stringify({ address })
      });
      const data = await r.json().catch(()=>({}));
      const ti = document.getElementById("tonInfo");
      if (ti) ti.textContent = JSON.stringify(data, null, 2);
    }

    // ------- BOTS -------
    async function loadBots(){
      try{
        const res  = await fetch(api("/bots"), { headers: authHeaders() });
        const bots = await res.json();
        const el = document.getElementById("bots");
        if (el) el.textContent = JSON.stringify(bots, null, 2);
      }catch(e){
        const el = document.getElementById("bots");
        if (el) el.textContent = "—";
      }
    }
    async function addBot(){
      const name = prompt("Bot Name?"); if (!name) return;
      const slug = prompt("Slug (unique)?"); if (!slug) return;
      const description = prompt("Beschreibung (optional)") || null;
      const res = await fetch(api("/bots"), {
        method:"POST", headers: authHeaders(), body: JSON.stringify({ name, slug, description, is_active:true })
      });
      if (!res.ok) { alert(await res.text()); return; }
      await loadBots();
    }

    // ------- DEV-LOGIN (Bypass) -------
    async function devLogin(){
      const codeEl = document.getElementById('devCode');
      const tgEl   = document.getElementById('devTgId');
      const code = codeEl ? codeEl.value.trim() : "";
      const telegram_id = tgEl ? tgEl.value.trim() : "";
      const r = await fetch(api("/dev-login"), {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ code, telegram_id, username: "andreas" })
      });
      const d = await r.json().catch(()=> ({}));
      if(!r.ok){ alert("Dev-Login fehlgeschlagen: " + (d.error||"")); return; }
      localStorage.setItem(tokenKey, d.access_token);
      const login = document.getElementById("login");
      if (login) login.style.display="none";
      await bootAfterLogin();
    }

    // ------- BOOT AFTER LOGIN -------
    async function bootAfterLogin(){
      const ids = ["meCard","overviewCard","botsCard","walletCard","tokenCard","meshCard","walletsCard"];
      ids.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = ""; });

      try {
        const me = await (await fetch(api("/me"), { headers: authHeaders() })).json();
        const el = document.getElementById("me");
        if (el) el.textContent = JSON.stringify(me, null, 2);
      } catch {}

      try {
        const ov = await (await fetch(api("/metrics/overview"), { headers: authHeaders() })).json();
        const el = document.getElementById("overview");
        if (el) el.textContent = JSON.stringify(ov, null, 2);
      } catch {}

      try { await fetch(api("/bots/refresh"), { method:"POST", headers: authHeaders() }); } catch {}
      await loadBots();
      await nearInit();
      await refreshNearToken();
      await meshRefresh();
      await refreshWallets();
      await refreshPayments();

      const byId = (id)=>document.getElementById(id);
      byId("btnReloadBots")      && (byId("btnReloadBots").onclick      = loadBots);
      byId("btnAddBot")          && (byId("btnAddBot").onclick          = addBot);
      byId("btnNearConnect")     && (byId("btnNearConnect").onclick     = nearConnect);
      byId("btnNearDisconnect")  && (byId("btnNearDisconnect").onclick  = nearDisconnect);
      byId("btnTokenReload")     && (byId("btnTokenReload").onclick     = refreshNearToken);
      byId("btnMeshReload")      && (byId("btnMeshReload").onclick      = meshRefresh);
      byId("btnSaveTon")         && (byId("btnSaveTon").onclick         = saveTon);
      byId("btnRefreshPayments") && (byId("btnRefreshPayments").onclick = refreshPayments);
      byId("btnDevLogin")        && (byId("btnDevLogin").onclick        = devLogin);
    }

    // ------- BOOT -------
    function boot(){
      mountLogin();
      if (localStorage.getItem(tokenKey)) {
        const login = document.getElementById("login");
        if (login) login.style.display = "none";
        bootAfterLogin();
      }
      const btn = document.getElementById('btnDevLogin');
      if (btn) btn.onclick = devLogin;
    }
    document.addEventListener("DOMContentLoaded", boot);
  </script>
</head>

<body>
  <h1>Emerald DevDashboard <span class="pill">v1.2</span></h1>

  <!-- Login -->
  <div class="card" id="login">
    <h3>Anmeldung</h3>
    <div id="tgSlot"></div>
    <div style="margin-top:8px; display:flex; gap:8px;">
      <input id="devCode"  placeholder="DEV CODE">
      <input id="devTgId"  placeholder="Telegram ID z.B. 123456789">
      <button id="btnDevLogin">Dev-Login</button>
    </div>
    <small>Login wird serverseitig verifiziert.</small>
  </div>

  <!-- Me -->
  <div class="card" id="meCard" style="display:none">
    <h3>Angemeldet</h3>
    <pre id="me"></pre>
  </div>

  <!-- Overview -->
  <div class="card" id="overviewCard" style="display:none">
    <h3>Overview</h3>
    <pre id="overview"></pre>
  </div>

  <!-- Bots -->
  <div class="card" id="botsCard" style="display:none">
    <h3>Bots</h3>
    <div class="row">
      <button id="btnReloadBots">Neu laden</button>
      <button id="btnAddBot">Bot hinzufügen</button>
    </div>
    <pre id="bots"></pre>
  </div>

  <!-- NEAR Wallet / Connect -->
  <div class="card" id="walletCard" style="display:none">
    <h3>NEAR Connect</h3>
    <div class="row">
      <button id="btnNearConnect">Wallet verbinden</button>
      <button id="btnNearDisconnect" disabled>Trennen</button>
      <span class="pill">Status: <span id="nearConnected">—</span></span>
      <span class="pill">Account: <span id="nearAccount">—</span></span>
    </div>
    <p><small>Nach Verbindung wird die Wallet mit deiner Telegram-ID verknüpft (Server-Verify).</small></p>
    <pre id="nearBindResult"></pre>
  </div>

  <!-- Token Dynamics -->
  <div class="card" id="tokenCard" style="display:none">
    <h3>Token Dynamics</h3>
    <div class="row"><button id="btnTokenReload">Neu laden</button></div>
    <pre id="tokenSummary"></pre>
  </div>

  <!-- Wallets (NEAR + TON) -->
  <div class="card" id="walletsCard" style="display:none">
    <h3>Wallets</h3>
    <div class="row" style="gap:8px; align-items:center">
      <span class="pill">NEAR Watch: emeraldcontent.near</span>
      <span class="pill">NEAR Watch: pay.emeraldcontent.near</span>
    </div>
    <div class="row" style="margin-top:8px">
      <div style="flex:1">
        <h4>emeraldcontent.near</h4>
        <pre id="nearAcc1"></pre>
      </div>
      <div style="flex:1">
        <h4>pay.emeraldcontent.near</h4>
        <pre id="nearAcc2"></pre>
      </div>
    </div>
    <hr>
    <div class="row" style="margin:8px 0">
      <button id="btnRefreshPayments">Zahlungseingänge aktualisieren</button>
    </div>
    <div class="row">
      <div style="flex:1">
        <h4>NEAR Eingänge – emeraldcontent.near</h4>
        <pre id="nearIn1"></pre>
      </div>
      <div style="flex:1">
        <h4>NEAR Eingänge – pay.emeraldcontent.near</h4>
        <pre id="nearIn2"></pre>
      </div>
    </div>
    <div>
      <h4>TON Eingänge</h4>
      <pre id="tonIn"></pre>
    </div>
    <div>
      <h4>TON Wallet</h4>
      <div class="row">
        <input id="tonAddress" placeholder="EQC... (TON Adresse)" />
        <button id="btnSaveTon">Speichern</button>
      </div>
      <pre id="tonInfo"></pre>
    </div>
  </div>

  <!-- Mesh -->
  <div class="card" id="meshCard" style="display:none">
    <h3>Bot-Mesh</h3>
    <div class="row"><button id="btnMeshReload">Pingen & Laden</button></div>
    <h4>Health</h4>
    <pre id="meshHealth"></pre>
    <h4>Metrics</h4>
    <pre id="meshMetrics"></pre>
  </div>
</body>
</html>



<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emerald Dashboard Pro</title>
  <script async src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #00D084;
      --primary-dark: #0A2E1F;
      --primary-light: #E8F5F0;
      --accent: #00B06A;
      --danger: #ef4444;
      --warning: #f59e0b;
      --success: #10b981;
      --bg-dark: #0f172a;
      --bg-medium: #1e293b;
      --text-primary: #e2e8f0;
      --text-secondary: #cbd5e1;
      --border: #334155;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-medium) 100%);
      color: var(--text-primary);
      min-height: 100vh;
    }

    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-box {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 16px;
      padding: 40px;
      max-width: 400px;
      backdrop-filter: blur(10px);
      text-align: center;
    }

    .login-box h1 {
      font-size: 32px;
      margin-bottom: 10px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .login-box p {
      color: var(--text-secondary);
      margin-bottom: 30px;
      font-size: 14px;
    }

    .telegram-login-btn {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: var(--primary-dark);
      border: none;
      padding: 14px 32px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s;
      margin-bottom: 15px;
    }

    .telegram-login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 208, 132, 0.3);
    }

    .dashboard {
      display: none;
    }

    .dashboard.active {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
      flex: 1;
    }

    header {
      background: rgba(30, 41, 59, 0.6);
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      backdrop-filter: blur(10px);
    }

    header h1 {
      font-size: 24px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-section {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .user-box {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(51, 65, 85, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 8px 16px;
      border-radius: 8px;
    }

    .user-info {
      display: flex;
      flex-direction: column;
      font-size: 12px;
    }

    .user-name {
      font-weight: 600;
      color: var(--primary);
    }

    .user-role {
      color: var(--text-secondary);
      font-size: 11px;
    }

    .logout-btn {
      background: var(--danger);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    nav {
      display: flex;
      gap: 8px;
      margin-bottom: 30px;
      flex-wrap: wrap;
      background: rgba(30, 41, 59, 0.4);
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    nav button {
      background: rgba(51, 65, 85, 0.5);
      color: var(--text-secondary);
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }

    nav button:hover,
    nav button.active {
      background: var(--primary);
      color: var(--primary-dark);
      border-color: var(--primary);
    }

    .content {
      display: none;
    }

    .content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      padding: 20px;
      backdrop-filter: blur(10px);
    }

    .card h3 {
      font-size: 14px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }

    .card .value {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 8px;
    }

    .stat-card {
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary);
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .list-item {
      background: rgba(51, 65, 85, 0.3);
      border: 1px solid rgba(148, 163, 184, 0.1);
      border-radius: 8px;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }

    .list-item:hover {
      border-color: var(--primary);
      background: rgba(0, 208, 132, 0.05);
      transform: translateX(4px);
    }

    .list-item-content {
      flex: 1;
    }

    .item-title {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .item-desc {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .item-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    button {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border: none;
      color: var(--primary-dark);
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 208, 132, 0.3);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    table th {
      background: rgba(51, 65, 85, 0.5);
      padding: 12px;
      text-align: left;
      color: var(--text-secondary);
      font-weight: 600;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }

    table td {
      padding: 12px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }

    table tr:hover {
      background: rgba(0, 208, 132, 0.05);
    }

    .stats-header {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 30px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: var(--bg-medium);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h2 {
      margin: 0;
      color: var(--primary);
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      background: rgba(51, 65, 85, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 8px;
      padding: 10px 12px;
      color: var(--text-primary);
      font-family: inherit;
      transition: all 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 208, 132, 0.1);
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(148, 163, 184, 0.3);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    @media (max-width: 768px) {
      .container { padding: 12px; }
      .grid { grid-template-columns: 1fr; }
      header { flex-direction: column; gap: 12px; }
      nav { gap: 4px; }
      nav button { padding: 8px 12px; font-size: 12px; }
    }
  </style>
</head>
<body>
  <!-- LOGIN PAGE -->
  <div id="loginPage" class="login-container">
    <div class="login-box">
      <h1>üåø Emerald</h1>
      <p>Dashboard Pro</p>
      <button class="telegram-login-btn" onclick="performTelegramAuth(window.Telegram?.WebApp?.initData)">üîê Telegram Login</button>
      <button class="telegram-login-btn" onclick="devLogin()">üîë Dev Login</button>
      <small>Secure authentication required</small>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="dashboard">
    <header>
      <h1>üåø Emerald Dashboard Pro</h1>
      <div class="user-section">
        <div id="userBox" class="user-box">
          <div class="user-info">
            <div class="user-name">Loading...</div>
            <div class="user-role">dev ‚Ä¢ pro</div>
          </div>
        </div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </header>

    <div class="container">
      <!-- Navigation -->
      <nav>
        <button class="nav-btn active" data-tab="overview">üìä Overview</button>
        <button class="nav-btn" data-tab="content-stats">üì¢ Content Bot</button>
        <button class="nav-btn" data-tab="affiliate-stats">üîó Affiliate</button>
        <button class="nav-btn" data-tab="crossposter-stats">üì§ Crossposter</button>
        <button class="nav-btn" data-tab="dao-stats">üèõÔ∏è DAO</button>
        <button class="nav-btn" data-tab="learning-stats">üìö Learning</button>
        <button class="nav-btn" data-tab="support-stats">üÜò Support</button>
        <button class="nav-btn" data-tab="trade-api-stats">üíº Trade API</button>
        <button class="nav-btn" data-tab="trade-dex-stats">üîÑ Trade DEX</button>
        <button class="nav-btn" data-tab="token">üíé Token</button>
        <button class="nav-btn" data-tab="ads">üì¢ Ads</button>
        <button class="nav-btn" data-tab="users">üë• Users</button>
        <button class="nav-btn" data-tab="monitoring">üîç Monitoring</button>
      </nav>

      <!-- OVERVIEW TAB -->
      <div id="overview" class="content active">
        <div class="stats-header">
          <div class="stat-card">
            <div class="stat-label">Total Users</div>
            <div class="stat-value" id="stat_users">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Active Bots</div>
            <div class="stat-value" id="stat_bots">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Active Ads</div>
            <div class="stat-value" id="stat_ads">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Token Holders</div>
            <div class="stat-value" id="holderCount">-</div>
          </div>
        </div>

        <div class="grid">
          <div class="card">
            <h3>üìä System Metrics</h3>
            <div id="botActivityChart" class="list"></div>
          </div>
          <div class="card">
            <h3>üìà Resource Usage</h3>
            <div id="userGrowthChart" class="list"></div>
          </div>
          <div class="card">
            <h3>üíæ Database Stats</h3>
            <div id="revenueStats"></div>
          </div>
        </div>

        <div class="grid">
          <div class="card" style="grid-column: 1 / -1;">
            <h3>üö® System Health</h3>
            <table>
              <tr><td>Status</td><td id="health_status"><span class="spinner"></span></td></tr>
              <tr><td>Uptime</td><td id="health_uptime">-</td></tr>
              <tr><td>Response Time</td><td id="health_response">-</td></tr>
              <tr><td>Database</td><td id="health_db">-</td></tr>
              <tr><td>Last Backup</td><td id="health_backup">-</td></tr>
            </table>
          </div>
        </div>
      </div>

      <!-- CONTENT BOT STATS TAB -->
      <div id="content-stats" class="content">
        <div class="grid">
          <div class="stat-card"><div class="stat-label">üë• Groups</div><div class="stat-value" id="cs_groups">-</div></div>
          <div class="stat-card"><div class="stat-label">üí¨ Messages</div><div class="stat-value" id="cs_messages">-</div></div>
          <div class="stat-card"><div class="stat-label">üíé Rewards</div><div class="stat-value" id="cs_tokens">-</div></div>
          <div class="stat-card"><div class="stat-label">üõ°Ô∏è Moderation</div><div class="stat-value" id="cs_moderation">-</div></div>
        </div>

        <div class="card">
          <h3>üë• Top Groups</h3>
          <div id="contentGroups" class="list"></div>
        </div>

        <div class="grid">
          <div class="card"><h3>üíé Token Economy</h3><div id="contentTokens"></div></div>
        </div>

        <div class="grid">
          <div class="card"><h3>üìñ Story Sharing</h3><div id="contentStories"></div></div>
          <div class="card"><h3>üë• Affiliate</h3><div id="contentAffiliate"></div></div>
          <div class="card"><h3>üì∞ RSS</h3><div id="contentRss"></div></div>
          <div class="card"><h3>üõ°Ô∏è AI Moderation</h3><div id="contentModeration"></div></div>
          <div class="card"><h3>üìä Retention</h3><div id="contentRetention"></div></div>
          <div class="card"><h3>üåê Network</h3><div id="contentNetwork"></div></div>
        </div>
      </div>

      <!-- AFFILIATE BOT STATS TAB -->
      <div id="affiliate-stats" class="content">
        <div class="grid">
          <div class="stat-card"><div class="stat-label">Referrers</div><div class="stat-value" id="aff_referrers">-</div></div>
          <div class="stat-card"><div class="stat-label">Referrals</div><div class="stat-value" id="aff_referrals">-</div></div>
          <div class="stat-card"><div class="stat-label">Converted</div><div class="stat-value" id="aff_converted">-</div></div>
          <div class="stat-card"><div class="stat-label">Paid</div><div class="stat-value" id="aff_paid">-</div></div>
        </div>
        <div class="card"><h3>üîó Affiliate Bot</h3><div id="affiliateStatsContent" style="line-height: 1.8;"></div></div>
      </div>

      <!-- CROSSPOSTER STATS TAB -->
      <div id="crossposter-stats" class="content">
        <div class="grid">
          <div class="stat-card"><div class="stat-label">Users</div><div class="stat-value" id="cross_users">-</div></div>
          <div class="stat-card"><div class="stat-label">Posts</div><div class="stat-value" id="cross_posts">-</div></div>
          <div class="stat-card"><div class="stat-label">Posted</div><div class="stat-value" id="cross_posted">-</div></div>
          <div class="stat-card"><div class="stat-label">Drafts</div><div class="stat-value" id="cross_drafts">-</div></div>
        </div>
        <div class="card"><h3>üì§ Crossposter</h3><div id="crossposterStatsContent" style="line-height: 1.8;"></div></div>
      </div>

      <!-- DAO STATS TAB -->
      <div id="dao-stats" class="content">
        <div class="grid">
          <div class="stat-card"><div class="stat-label">Proposals</div><div class="stat-value" id="dao_proposals">-</div></div>
          <div class="stat-card"><div class="stat-label">Active</div><div class="stat-value" id="dao_active">-</div></div>
          <div class="stat-card"><div class="stat-label">Voters</div><div class="stat-value" id="dao_voters">-</div></div>
          <div class="stat-card"><div class="stat-label">Treasury</div><div class="stat-value" id="dao_treasury">-</div></div>
        </div>
        <div class="card"><h3>üèõÔ∏è DAO</h3><div id="daoStatsContent" style="line-height: 1.8;"></div></div>
      </div>

      <!-- LEARNING STATS TAB -->
      <div id="learning-stats" class="content">
        <div class="grid">
          <div class="stat-card"><div class="stat-label">Courses</div><div class="stat-value" id="learn_courses">-</div></div>
          <div class="stat-card"><div class="stat-label">Enrolled</div><div class="stat-value" id="learn_enrolled">-</div></div>
          <div class="stat-card"><div class="stat-label">Completed</div><div class="stat-value" id="learn_completed">-</div></div>
          <div class="stat-card"><div class="stat-label">Quizzes</div><div class="stat-value" id="learn_quizzes">-</div></div>
        </div>
        <div class="card"><h3>üìö Learning</h3><div id="learningStatsContent" style="line-height: 1.8;"></div></div>
      </div>

      <!-- SUPPORT STATS TAB -->
      <div id="support-stats" class="content">
        <div class="grid">
          <div class="stat-card"><div class="stat-label">Tickets</div><div class="stat-value" id="sup_tickets">-</div></div>
          <div class="stat-card"><div class="stat-label">Open</div><div class="stat-value" id="sup_open">-</div></div>
          <div class="stat-card"><div class="stat-label">Closed</div><div class="stat-value" id="sup_closed">-</div></div>
          <div class="stat-card"><div class="stat-label">Resolution</div><div class="stat-value" id="sup_resolution">-</div></div>
        </div>
        <div class="card"><h3>üÜò Support</h3><div id="supportStatsContent" style="line-height: 1.8;"></div></div>
      </div>

      <!-- TRADE API STATS TAB -->
      <div id="trade-api-stats" class="content">
        <div class="grid">
          <div class="stat-card"><div class="stat-label">Users</div><div class="stat-value" id="ta_users">-</div></div>
          <div class="stat-card"><div class="stat-label">Portfolios</div><div class="stat-value" id="ta_portfolios">-</div></div>
          <div class="stat-card"><div class="stat-label">Positions</div><div class="stat-value" id="ta_positions">-</div></div>
          <div class="stat-card"><div class="stat-label">AUM</div><div class="stat-value" id="ta_aum">-</div></div>
        </div>
        <div class="card"><h3>üíº Trade API</h3><div id="tradeApiStatsContent" style="line-height: 1.8;"></div></div>
      </div>

      <!-- TRADE DEX STATS TAB -->
      <div id="trade-dex-stats" class="content">
        <div class="grid">
          <div class="stat-card"><div class="stat-label">DEX</div><div class="stat-value" id="td_dexes">-</div></div>
          <div class="stat-card"><div class="stat-label">Pools</div><div class="stat-value" id="td_pools">-</div></div>
          <div class="stat-card"><div class="stat-label">TVL</div><div class="stat-value" id="td_tvl">-</div></div>
          <div class="stat-card"><div class="stat-label">Swaps</div><div class="stat-value" id="td_swaps">-</div></div>
        </div>
        <div class="card"><h3>üîÑ Trade DEX</h3><div id="tradeDexStatsContent" style="line-height: 1.8;"></div></div>
      </div>

      <!-- TOKEN TAB -->
      <div id="token" class="content">
        <div class="grid">
          <div class="card" style="grid-column: 1 / -1;">
            <h3>üíé Token Info</h3>
            <div id="tokenInfo"></div>
          </div>
        </div>
      </div>

      <!-- ADS TAB -->
      <div id="ads" class="content">
        <div class="grid" style="margin-bottom: 20px;">
          <button onclick="showModal('addAdModal')" style="width: 100%;">‚ûï Create Ad</button>
        </div>
        <div class="card"><h3>üì∫ Ads</h3><div id="adsList"></div></div>
      </div>

      <!-- USERS TAB -->
      <div id="users" class="content">
        <div class="card">
          <h3>üë• Users</h3>
          <table><thead><tr><th>Username</th><th>Role</th><th>Tier</th><th>Joined</th></tr></thead><tbody id="usersList"></tbody></table>
        </div>
      </div>

      <!-- MONITORING TAB -->
      <div id="monitoring" class="content">
        <div class="grid">
          <div class="card"><h3>üåê Bot Groups</h3><div id="botGroups" class="list"></div></div>
          <div class="card"><h3>üîç Logs</h3><div id="systemLogs"></div></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://emeraldcontent-aac379fc581e.herokuapp.com/api';
    let authToken = localStorage.getItem('auth_token');
    let currentUser = null;

    document.addEventListener('DOMContentLoaded', async () => {
      if (!authToken) {
        document.getElementById('loginPage').style.display = 'flex';
      } else {
        await initDashboard();
      }
    });

    async function performTelegramAuth(initData) {
      try {
        if (!initData) {
          alert('Telegram Web App not available');
          return;
        }
        const response = await fetch(`${API_BASE}/devdash/auth/telegram`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ init_data: initData })
        });
        if (!response.ok) throw new Error('Auth failed');
        const data = await response.json();
        authToken = data.access_token;
        localStorage.setItem('auth_token', authToken);
        await initDashboard();
      } catch (error) {
        alert('Telegram login failed: ' + error.message);
      }
    }

    async function devLogin() {
      try {
        const code = prompt('Enter DEV_LOGIN_CODE:');
        if (!code) return;
        const response = await fetch(`${API_BASE}/devdash/auth/dev-login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code, telegram_id: 123456 })
        });
        if (!response.ok) throw new Error('Dev login failed');
        const data = await response.json();
        authToken = data.access_token;
        localStorage.setItem('auth_token', authToken);
        await initDashboard();
      } catch (error) {
        alert('Dev login failed: ' + error.message);
      }
    }

    async function apiCall(endpoint, options = {}) {
      const defaultOptions = {
        headers: {
          'Authorization': `Bearer ${authToken}`,
          'Content-Type': 'application/json'
        }
      };
      const response = await fetch(`${API_BASE}${endpoint}`, {
        ...defaultOptions,
        ...options,
        headers: { ...defaultOptions.headers, ...(options.headers || {}) }
      });
      if (!response.ok) {
        if (response.status === 401) { logout(); throw new Error('Not authenticated'); }
        const error = await response.json().catch(() => ({}));
        throw new Error(error.detail || `HTTP ${response.status}`);
      }
      return response.json();
    }

    async function initDashboard() {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('dashboard').classList.add('active');
      try {
        await Promise.all([loadUserProfile(), refreshOverview()]);
        setupNavigation();
        setInterval(refreshOverview, 30000);
      } catch (error) {
        console.error('Failed to initialize:', error);
        logout();
      }
    }

    async function loadUserProfile() {
      try {
        const data = await apiCall('/devdash/me');
        currentUser = data;
        const profile = data.profile || {};
        document.getElementById('userBox').innerHTML = `
          <div class="user-info">
            <div class="user-name">@${profile.username || profile.id}</div>
            <div class="user-role">${data.role} ‚Ä¢ ${data.tier}</div>
          </div>
        `;
      } catch (error) {
        console.error('Failed to load user:', error);
      }
    }

    function setupNavigation() {
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
      });
    }

    function switchTab(tabName) {
      document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
      const tab = document.getElementById(tabName);
      const btn = document.querySelector(`[data-tab="${tabName}"]`);
      if (tab && btn) {
        tab.classList.add('active');
        btn.classList.add('active');
        switch (tabName) {
          case 'content-stats': loadContentBotStats(); loadRssFeeds(); break;
          case 'affiliate-stats': loadAffiliateBotStats(); break;
          case 'crossposter-stats': loadCrossposterBotStats(); break;
          case 'dao-stats': loadDaoBotStats(); break;
          case 'learning-stats': loadLearningBotStats(); break;
          case 'support-stats': loadSupportBotStats(); break;
          case 'trade-api-stats': loadTradeApiBotStats(); break;
          case 'trade-dex-stats': loadTradeDexBotStats(); break;
          case 'token': loadTokenData(); break;
          case 'ads': loadAds(); break;
          case 'users': loadUsers(); break;
          case 'monitoring': loadMonitoring(); break;
        }
      }
    }

    async function loadContentBotStats() {
      try {
        const [overview, groups, claimed, storyShare, moderation, retention, network] = await Promise.all([
          apiCall('/devdash/content/stats/overview'),
          apiCall('/devdash/content/stats/groups'),
          apiCall('/devdash/content/stats/claimed'),
          apiCall('/devdash/content/stats/story-share'),
          apiCall('/devdash/content/stats/ai-moderation'),
          apiCall('/devdash/content/stats/retention'),
          apiCall('/devdash/content/stats/network')
        ]);

        document.getElementById('cs_groups').textContent = overview.groups.total || 0;
        document.getElementById('cs_messages').textContent = overview.messages.total_today || 0;
        document.getElementById('cs_tokens').textContent = claimed.claimed_total || 0;
        document.getElementById('cs_moderation').textContent = moderation.actions.actions_today || 0;

        const groupsHtml = (groups.groups || []).map(g => `
          <div class="list-item">
            <div class="list-item-content">
              <div class="item-title">üë• ${g.title || `Group #${g.chat_id}`}</div>
              <div class="item-desc">${g.members} members ‚Ä¢ ${g.messages_total} messages</div>
            </div>
            <span class="item-status">${g.messages_today} today</span>
          </div>
        `).join('');
        document.getElementById('contentGroups').innerHTML = groupsHtml || '<p>No data</p>';

        document.getElementById('contentTokens').innerHTML = `
          <div style="line-height: 1.8;">
            <div><strong>‚úÖ Claimed:</strong> ${claimed.claimed_total.toLocaleString()} Points</div>
            <div><strong>‚è≥ Pending:</strong> ${claimed.pending_count}</div>
            <div><strong>üë• Claimants:</strong> ${claimed.unique_claimants}</div>
          </div>
        `;

        document.getElementById('contentStories').innerHTML = `
          <div style="line-height: 1.8;">
            <div><strong>üìä Active Groups:</strong> ${storyShare.active_groups || 0}</div>
            <div><strong>üì§ Shares:</strong> ${storyShare.total_shares || 0}</div>
            <div><strong>üëÜ Clicks:</strong> ${storyShare.total_clicks || 0}</div>
          </div>
        `;

        document.getElementById('contentAffiliate').innerHTML = `
          <div style="line-height: 1.8;">
            <div><strong>üë§ Referrers:</strong> 0</div>
            <div><strong>üîó Referrals:</strong> 0</div>
            <div><strong>üí∞ Earned:</strong> $0</div>
          </div>
        `;

        // RSS Feeds werden nun durch loadRssFeeds() async geladen

        document.getElementById('contentModeration').innerHTML = `
          <div style="line-height: 1.8;">
            <div><strong>‚úÖ Enabled:</strong> ${moderation.actions.enabled_groups}</div>
            <div><strong>üìä Today:</strong> ${moderation.actions.actions_today}</div>
          </div>
        `;

        document.getElementById('contentRetention').innerHTML = `
          <div style="line-height: 1.8;">
            <div><strong>üë• Active:</strong> ${retention.retention.active_users_total}</div>
            <div><strong>üìä Today:</strong> ${retention.retention.active_today}</div>
          </div>
        `;

        document.getElementById('contentNetwork').innerHTML = `
          <div style="line-height: 1.8;">
            <div><strong>üìä Groups:</strong> ${network.network.total_groups}</div>
            <div><strong>üë• Users:</strong> ${network.network.total_users}</div>
            <div><strong>üí¨ Messages:</strong> ${network.network.total_messages}</div>
          </div>
        `;
      } catch (error) {
        console.error('Failed to load content bot stats:', error);
        document.getElementById('contentGroups').innerHTML = '<p style="color: var(--danger);">Error: ' + error.message + '</p>';
      }
    }

    async function loadAffiliateBotStats() {
      try {
        const data = await apiCall('/devdash/bots/affiliate/stats');
        document.getElementById('aff_referrers').textContent = data.total_referrers || 0;
        document.getElementById('aff_referrals').textContent = data.total_referrals || 0;
        document.getElementById('aff_converted').textContent = data.converted_referrals || 0;
        document.getElementById('aff_paid').textContent = '$' + (data.commissions_paid || 0).toLocaleString();
        document.getElementById('affiliateStatsContent').innerHTML = `
          <div style="line-height: 1.8;">
            <div><strong>Referrers:</strong> ${data.total_referrers}</div>
            <div><strong>Referrals:</strong> ${data.total_referrals}</div>
            <div><strong>Conversions:</strong> ${data.conversions_total}</div>
            <div><strong>Paid Commissions:</strong> $${data.commissions_paid.toLocaleString()}</div>
          </div>
        `;
      } catch (error) {
        console.error('Failed to load affiliate stats:', error);
        document.getElementById('affiliateStatsContent').innerHTML = '<p style="color: var(--danger);">Error: ' + error.message + '</p>';
      }
    }

    async function loadCrossposterBotStats() {
      try {
        const data = await apiCall('/devdash/bots/crossposter/stats');
        document.getElementById('cross_users').textContent = data.total_users || 0;
        document.getElementById('cross_posts').textContent = data.total_posts || 0;
        document.getElementById('cross_posted').textContent = data.posted || 0;
        document.getElementById('cross_drafts').textContent = data.drafts || 0;
        document.getElementById('crossposterStatsContent').innerHTML = `
          <div style="line-height: 1.8;">
            <div><strong>Users:</strong> ${data.total_users}</div>
            <div><strong>Posts:</strong> ${data.total_posts}</div>
            <div><strong>Posted:</strong> ${data.posted}</div>
            <div><strong>Drafts:</strong> ${data.drafts}</div>
          </div>
        `;
      } catch (error) {
        console.error('Failed to load crossposter stats:', error);
        document.getElementById('crossposterStatsContent').innerHTML = '<p style="color: var(--danger);">Error: ' + error.message + '</p>';
      }
    }

    async function loadDaoBotStats() {
      try {
        const data = await apiCall('/devdash/bots/dao/stats');
        document.getElementById('dao_proposals').textContent = data.total_proposals || 0;
        document.getElementById('dao_active').textContent = data.active_proposals || 0;
        document.getElementById('dao_voters').textContent = data.total_voters || 0;
        document.getElementById('dao_treasury').textContent = '$' + (data.treasury_total || 0).toLocaleString();
        document.getElementById('daoStatsContent').innerHTML = `
          <div style="line-height: 1.8;">
            <div><strong>Proposals:</strong> ${data.total_proposals}</div>
            <div><strong>Active:</strong> ${data.active_proposals}</div>
            <div><strong>Passed:</strong> ${data.passed_proposals}</div>
            <div><strong>Treasury:</strong> $${data.treasury_total.toLocaleString()}</div>
          </div>
        `;
      } catch (error) {
        console.error('Failed to load dao stats:', error);
        document.getElementById('daoStatsContent').innerHTML = '<p style="color: var(--danger);">Error: ' + error.message + '</p>';
      }
    }

    async function loadLearningBotStats() {
      try {
        const data = await apiCall('/devdash/bots/learning/stats');
        document.getElementById('learn_courses').textContent = data.total_courses || 0;
        document.getElementById('learn_enrolled').textContent = data.enrolled_users || 0;
        document.getElementById('learn_completed').textContent = data.completed_courses || 0;
        document.getElementById('learn_quizzes').textContent = data.quiz_passers || 0;
        document.getElementById('learningStatsContent').innerHTML = `
          <div style="line-height: 1.8;">
            <div><strong>Courses:</strong> ${data.total_courses}</div>
            <div><strong>Enrolled:</strong> ${data.enrolled_users}</div>
            <div><strong>Completed:</strong> ${data.completed_courses}</div>
            <div><strong>Quizzes:</strong> ${data.total_quizzes}</div>
          </div>
        `;
      } catch (error) {
        console.error('Failed to load learning stats:', error);
        document.getElementById('learningStatsContent').innerHTML = '<p style="color: var(--danger);">Error: ' + error.message + '</p>';
      }
    }

    async function loadSupportBotStats() {
      try {
        const data = await apiCall('/devdash/bots/support/stats');
        document.getElementById('sup_tickets').textContent = data.total_tickets || 0;
        document.getElementById('sup_open').textContent = data.open || 0;
        document.getElementById('sup_closed').textContent = data.closed || 0;
        document.getElementById('sup_resolution').textContent = (data.avg_resolution_hours || 0).toFixed(1) + 'h';
        document.getElementById('supportStatsContent').innerHTML = `
          <div style="line-height: 1.8;">
            <div><strong>Tickets:</strong> ${data.total_tickets}</div>
            <div><strong>Open:</strong> ${data.open}</div>
            <div><strong>Closed:</strong> ${data.closed}</div>
            <div><strong>Avg Resolution:</strong> ${data.avg_resolution_hours.toFixed(1)}h</div>
          </div>
        `;
      } catch (error) {
        console.error('Failed to load support stats:', error);
        document.getElementById('supportStatsContent').innerHTML = '<p style="color: var(--danger);">Error: ' + error.message + '</p>';
      }
    }

    async function loadTradeApiBotStats() {
      try {
        const data = await apiCall('/devdash/bots/trade_api/stats');
        document.getElementById('ta_users').textContent = data.total_users || 0;
        document.getElementById('ta_portfolios').textContent = data.total_portfolios || 0;
        document.getElementById('ta_positions').textContent = data.active_positions || 0;
        document.getElementById('ta_aum').textContent = '$' + (data.total_aum || 0).toLocaleString(undefined, {maximumFractionDigits: 0});
        document.getElementById('tradeApiStatsContent').innerHTML = `
          <div style="line-height: 1.8;">
            <div><strong>Users:</strong> ${data.total_users}</div>
            <div><strong>Portfolios:</strong> ${data.total_portfolios}</div>
            <div><strong>Positions:</strong> ${data.active_positions}</div>
            <div><strong>AUM:</strong> $${data.total_aum.toLocaleString(undefined, {maximumFractionDigits: 2})}</div>
          </div>
        `;
      } catch (error) {
        console.error('Failed to load trade api stats:', error);
        document.getElementById('tradeApiStatsContent').innerHTML = '<p style="color: var(--danger);">Error: ' + error.message + '</p>';
      }
    }

    async function loadTradeDexBotStats() {
      try {
        const data = await apiCall('/devdash/bots/trade_dex/stats');
        document.getElementById('td_dexes').textContent = data.total_dexes || 0;
        document.getElementById('td_pools').textContent = data.total_pools || 0;
        document.getElementById('td_tvl').textContent = '$' + (data.total_tvl_usd || 0).toLocaleString(undefined, {maximumFractionDigits: 0});
        document.getElementById('td_swaps').textContent = data.total_swaps || 0;
        document.getElementById('tradeDexStatsContent').innerHTML = `
          <div style="line-height: 1.8;">
            <div><strong>DEX:</strong> ${data.total_dexes}</div>
            <div><strong>Pools:</strong> ${data.total_pools}</div>
            <div><strong>TVL:</strong> $${data.total_tvl_usd.toLocaleString(undefined, {maximumFractionDigits: 2})}</div>
            <div><strong>Swaps:</strong> ${data.total_swaps}</div>
          </div>
        `;
      } catch (error) {
        console.error('Failed to load trade dex stats:', error);
        document.getElementById('tradeDexStatsContent').innerHTML = '<p style="color: var(--danger);">Error: ' + error.message + '</p>';
      }
    }

    async function refreshOverview() {
      try {
        const health = await apiCall('/system/health');
        document.getElementById('stat_users').textContent = health.database.users_total || 0;
        document.getElementById('stat_bots').textContent = health.database.bots_active || 0;
        document.getElementById('stat_ads').textContent = health.database.ads_active || 0;
        const healthStatus = health.status === 'healthy' ? '‚úì Healthy' : '‚ö† Degraded';
        const healthColor = health.status === 'healthy' ? 'var(--success)' : 'var(--warning)';
        document.getElementById('health_status').innerHTML = `<span style="color: ${healthColor};">${healthStatus}</span>`;
      } catch (error) {
        console.error('Failed to load health:', error);
      }
    }

    async function loadBots() {
      try {
        const data = await apiCall('/analytics/bot-detailed');
        const html = (data.bots || []).map(bot => `
          <div class="list-item">
            <div class="list-item-content">
              <div class="item-title">ü§ñ ${bot.title || bot.username}</div>
              <div class="item-desc">${bot.username} ‚Ä¢ ${bot.user_count} users</div>
            </div>
            <span class="item-status">${bot.is_active ? '‚úÖ' : '‚≠ï'}</span>
          </div>
        `).join('');
        document.getElementById('botsList').innerHTML = html || '<p>No bots</p>';
      } catch (error) {
        console.error('Failed to load bots:', error);
        document.getElementById('botsList').innerHTML = '<p style="color: var(--danger);">Error loading bots</p>';
      }
    }

    async function loadTokenData() {
      try {
        const data = await apiCall('/devdash/token/emrd-info');
        const html = `
          <div class="grid">
            <div class="stat-card">
              <div class="stat-label">Total Supply</div>
              <div class="stat-value">${(data.total_supply || 0).toLocaleString('de-DE')}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Circulating</div>
              <div class="stat-value">${(data.circulating || 0).toLocaleString('de-DE')}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Market Cap</div>
              <div class="stat-value">$${(data.market_cap || 0).toLocaleString('de-DE')}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Price</div>
              <div class="stat-value">$${(data.price || 0).toFixed(4)}</div>
            </div>
          </div>
        `;
        document.getElementById('tokenInfo').innerHTML = html;
      } catch (error) {
        console.error('Token data error:', error);
        document.getElementById('tokenInfo').innerHTML = '<p style="color: var(--danger);">Fehler beim Laden der Token-Daten</p>';
      }
    }

    async function loadAds() {
      try {
        const data = await apiCall('/devdash/ads');
        if (!data || !data.campaigns || data.campaigns.length === 0) {
          document.getElementById('adsList').innerHTML = '<p>Keine Kampagnen</p>';
          return;
        }
        const html = data.campaigns.map((ad, i) => `
          <div class="list-item">
            <div class="list-item-content">
              <div class="item-title">${ad.title || 'Kampagne'}</div>
              <div class="item-desc">${ad.description || 'Keine Beschreibung'}</div>
            </div>
            <div class="item-status">${ad.is_active ? '‚úÖ Aktiv' : '‚è∏Ô∏è Pause'}</div>
          </div>
        `).join('');
        document.getElementById('adsList').innerHTML = html;
      } catch (error) {
        console.error('Ads error:', error);
        document.getElementById('adsList').innerHTML = '<p style="color: var(--danger);">Fehler beim Laden der Kampagnen</p>';
      }
    }

    async function loadUsers() {
      try {
        const data = await apiCall('/devdash/users');
        if (!data || !data.users || data.users.length === 0) {
          document.getElementById('usersList').innerHTML = '<tr><td colspan="4">Keine Benutzer</td></tr>';
          return;
        }
        const html = data.users.map(u => `
          <tr>
            <td>${u.telegram_id || '-'}</td>
            <td>${u.username || '-'}</td>
            <td>${u.tier || 'free'}</td>
            <td>${u.role || 'user'}</td>
          </tr>
        `).join('');
        document.getElementById('usersList').innerHTML = html;
      } catch (error) {
        console.error('Users error:', error);
        document.getElementById('usersList').innerHTML = '<tr><td colspan="4" style="color: var(--danger);">Fehler beim Laden der Benutzer</td></tr>';
      }
    }

    async function loadMonitoring() {
      try {
        const data = await apiCall('/devdash/mesh/health');
        if (!data || !data.bots || data.bots.length === 0) {
          document.getElementById('botGroups').innerHTML = '<p>Keine Bots online</p>';
          return;
        }
        const html = data.bots.map((bot, i) => `
          <div class="list-item">
            <div class="list-item-content">
              <div class="item-title">${bot.username || `Bot ${i+1}`}</div>
              <div class="item-desc">Status: ${bot.status || 'unknown'}</div>
            </div>
            <div class="item-status">${bot.healthy ? '‚úÖ Healthy' : '‚ö†Ô∏è Issues'}</div>
          </div>
        `).join('');
        document.getElementById('botGroups').innerHTML = html;
      } catch (error) {
        console.error('Monitoring error:', error);
        document.getElementById('botGroups').innerHTML = '<p style="color: var(--danger);">Fehler beim Laden der Bot-Daten</p>';
      }
    }

    async function loadRssFeeds() {
      try {
        const data = await apiCall('/devdash/content/rss');
        if (!data || !data.feeds || data.feeds.length === 0) {
          document.getElementById('contentRss').innerHTML = '<p>Keine RSS Feeds konfiguriert</p>';
          return;
        }
        const html = data.feeds.map(feed => `
          <div class="list-item">
            <div class="list-item-content">
              <div class="item-title">${feed.group_name}</div>
              <div class="item-desc" style="word-break: break-all; font-size: 0.85em;">
                üîó ${feed.url}<br/>
                üìç Topic: ${feed.topic_id || 'N/A'} | üñºÔ∏è ${feed.post_images ? 'Mit Bildern' : 'Nur Text'}
              </div>
            </div>
            <div class="item-status">${feed.enabled ? '‚úÖ Aktiv' : '‚è∏Ô∏è Aus'}</div>
          </div>
        `).join('');
        document.getElementById('contentRss').innerHTML = html;
      } catch (error) {
        console.error('RSS Feeds error:', error);
        document.getElementById('contentRss').innerHTML = '<p style="color: var(--danger);">Fehler beim Laden der RSS Feeds</p>';
      }
    }

    function showModal(modalId) {
      document.getElementById(modalId).classList.add('show');
    }

    function logout() {
      localStorage.removeItem('auth_token');
      authToken = null;
      location.reload();
    }
  </script>
</body>
</html>

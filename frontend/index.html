<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emerald Dashboard Pro</title>
  <script async src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #00D084;
      --primary-dark: #0A2E1F;
      --primary-light: #E8F5F0;
      --accent: #00B06A;
      --danger: #ef4444;
      --warning: #f59e0b;
      --success: #10b981;
      --bg-dark: #0f172a;
      --bg-medium: #1e293b;
      --text-primary: #e2e8f0;
      --text-secondary: #cbd5e1;
      --border: #334155;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-medium) 100%);
      color: var(--text-primary);
      min-height: 100vh;
    }

    /* ============= LOGIN PAGE ============= */
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-box {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 16px;
      padding: 40px;
      max-width: 400px;
      backdrop-filter: blur(10px);
      text-align: center;
    }

    .login-box h1 {
      font-size: 32px;
      margin-bottom: 10px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .login-box p {
      color: var(--text-secondary);
      margin-bottom: 30px;
      font-size: 14px;
    }

    .telegram-login-btn {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: var(--primary-dark);
      border: none;
      padding: 14px 32px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s;
      margin-bottom: 15px;
    }

    .telegram-login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 208, 132, 0.3);
    }

    .login-box small {
      color: var(--text-secondary);
      font-size: 12px;
    }

    /* ============= DASHBOARD LAYOUT ============= */
    .dashboard {
      display: none;
    }

    .dashboard.active {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
      flex: 1;
    }

    /* Header */
    header {
      background: rgba(30, 41, 59, 0.6);
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      backdrop-filter: blur(10px);
    }

    header h1 {
      font-size: 24px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-section {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .user-box {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(51, 65, 85, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 8px 16px;
      border-radius: 8px;
    }

    .user-box img {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
    }

    .user-info {
      display: flex;
      flex-direction: column;
      font-size: 12px;
    }

    .user-name {
      font-weight: 600;
      color: var(--primary);
    }

    .user-role {
      color: var(--text-secondary);
      font-size: 11px;
    }

    .logout-btn {
      background: var(--danger);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    /* Navigation */
    nav {
      display: flex;
      gap: 8px;
      margin-bottom: 30px;
      flex-wrap: wrap;
      background: rgba(30, 41, 59, 0.4);
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    nav button {
      background: rgba(51, 65, 85, 0.5);
      color: var(--text-secondary);
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }

    nav button:hover,
    nav button.active {
      background: var(--primary);
      color: var(--primary-dark);
      border-color: var(--primary);
    }

    /* Content Tabs */
    .content {
      display: none;
    }

    .content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    /* Grid Layout */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    /* Card Styles */
    .card {
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      padding: 20px;
      backdrop-filter: blur(10px);
    }

    .card h3 {
      font-size: 14px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }

    .card .value {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 8px;
    }

    .card .subtext {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .card .progress {
      width: 100%;
      height: 6px;
      background: rgba(51, 65, 85, 0.5);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 10px;
    }

    .card .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius: 3px;
    }

    /* List Items */
    .list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .list-item {
      background: rgba(51, 65, 85, 0.3);
      border: 1px solid rgba(148, 163, 184, 0.1);
      border-radius: 8px;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }

    .list-item:hover {
      border-color: var(--primary);
      background: rgba(0, 208, 132, 0.05);
      transform: translateX(4px);
    }

    .list-item-content {
      flex: 1;
    }

    .item-title {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .item-desc {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .item-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .item-status.inactive {
      background: rgba(107, 114, 128, 0.2);
      color: var(--text-secondary);
    }

    .item-status.warning {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
    }

    /* Buttons */
    button {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border: none;
      color: var(--primary-dark);
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 208, 132, 0.3);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Forms */
    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      background: rgba(51, 65, 85, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 8px;
      padding: 10px 12px;
      color: var(--text-primary);
      font-family: inherit;
      transition: all 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 208, 132, 0.1);
    }

    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(148, 163, 184, 0.3);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      color: var(--text-secondary);
      padding: 40px;
      text-align: center;
    }

    /* Alerts */
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: none;
    }

    .alert.show {
      display: block;
    }

    .alert.success {
      background: rgba(16, 185, 129, 0.2);
      border: 1px solid rgba(16, 185, 129, 0.5);
      color: var(--success);
    }

    .alert.error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.5);
      color: var(--danger);
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    table th {
      background: rgba(51, 65, 85, 0.5);
      padding: 12px;
      text-align: left;
      color: var(--text-secondary);
      font-weight: 600;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }

    table td {
      padding: 12px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }

    table tr:hover {
      background: rgba(0, 208, 132, 0.05);
    }

    /* Stats Section */
    .stats-header {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: var(--bg-medium);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 12px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h2 {
      margin: 0;
      color: var(--primary);
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 12px;
      }

      .grid {
        grid-template-columns: 1fr;
      }

      header {
        flex-direction: column;
        gap: 12px;
      }

      nav {
        overflow-x: auto;
      }

      .user-section {
        flex-direction: column;
        width: 100%;
      }

      .logout-btn {
        width: 100%;
      }

      .stats-header {
        grid-template-columns: 1fr;
      }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 14px;
      margin-bottom: 20px;
    }

    /* Bot Accordion */
    .bot-item {
      background: rgba(51, 65, 85, 0.3);
      border: 1px solid rgba(148, 163, 184, 0.1);
      border-radius: 8px;
      margin-bottom: 12px;
      overflow: hidden;
    }

    .bot-header {
      padding: 16px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }

    .bot-header:hover {
      background: rgba(0, 208, 132, 0.05);
      border-color: var(--primary);
    }

    .bot-header.expanded {
      background: rgba(0, 208, 132, 0.1);
      border-color: var(--primary);
    }

    .bot-header-content {
      flex: 1;
    }

    .bot-title {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .bot-meta {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .bot-toggle {
      font-size: 16px;
      transition: transform 0.2s;
      margin-left: 16px;
    }

    .bot-toggle.open {
      transform: rotate(180deg);
    }

    .bot-details {
      display: none;
      background: rgba(30, 41, 59, 0.8);
      border-top: 1px solid rgba(148, 163, 184, 0.1);
      padding: 20px;
    }

    .bot-details.show {
      display: block;
    }

    .bot-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }

    .bot-stat-card {
      background: rgba(51, 65, 85, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.1);
      border-radius: 8px;
      padding: 16px;
    }

    .bot-stat-card h4 {
      font-size: 13px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
      margin-top: 0;
    }

    .bot-stat-item {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 13px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.05);
    }

    .bot-stat-item:last-child {
      border-bottom: none;
    }

    .bot-stat-label {
      color: var(--text-secondary);
    }

    .bot-stat-value {
      color: var(--primary);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <!-- LOGIN PAGE -->
  <div id="loginPage" class="login-container">
    <div class="login-box">
      <h1>üåø Emerald</h1>
      <p>Professional Dashboard</p>
      <button class="telegram-login-btn" id="telegramLoginBtn">
        Login with Telegram
      </button>
      <p><small>Secure login via Telegram Web App</small></p>
      
      <hr style="margin: 20px 0; border: none; border-top: 1px solid rgba(148, 163, 184, 0.2);">
      <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 15px;">Alternative Methods:</p>
      
      <button onclick="devLogin()" style="background: #667eea; width: 100%; padding: 10px; margin: 8px 0; border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 14px;">
        Dev Login (Code)
      </button>
      
      <button onclick="tonWalletLogin()" style="background: #0088cc; width: 100%; padding: 10px; margin: 8px 0; border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 14px;">
        Login with TON Wallet
      </button>
      
      <button onclick="nearWalletLogin()" style="background: #ff4d4d; width: 100%; padding: 10px; margin: 8px 0; border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 14px;">
        Login with NEAR Wallet
      </button>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="dashboard">
    <!-- Header -->
    <header>
      <h1>üåø Emerald Dashboard Pro</h1>
      <div class="user-section">
        <div id="userBox" class="user-box">
          <div class="user-info">
            <div class="user-name">Loading...</div>
            <div class="user-role">dev ‚Ä¢ pro</div>
          </div>
        </div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </header>

    <!-- Main Container -->
    <div class="container">
      <!-- Navigation -->
      <nav>
        <button class="nav-btn active" data-tab="overview">üìä Overview</button>
        <button class="nav-btn" data-tab="content-stats">üìà Content Bot Stats</button>
        <button class="nav-btn" data-tab="bots">ü§ñ Bots</button>
        <button class="nav-btn" data-tab="token">üíé Token</button>
        <button class="nav-btn" data-tab="ads">üì¢ Ads</button>
        <button class="nav-btn" data-tab="users">üë• Users</button>
        <button class="nav-btn" data-tab="monitoring">üîç Monitoring</button>
      </nav>

      <!-- OVERVIEW TAB -->
      <div id="overview" class="content active">
        <div class="stats-header">
          <div class="stat-card">
            <div class="stat-label">Total Users</div>
            <div class="stat-value" id="stat_users">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Active Bots</div>
            <div class="stat-value" id="stat_bots">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Active Ads</div>
            <div class="stat-value" id="stat_ads">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Token Holders</div>
            <div class="stat-value" id="holderCount">-</div>
          </div>
        </div>

        <div class="grid">
          <div class="card">
            <h3>üìä System Metrics</h3>
            <div id="botActivityChart" class="list"></div>
          </div>
          <div class="card">
            <h3>üìà Resource Usage</h3>
            <div id="userGrowthChart" class="list"></div>
          </div>
          <div class="card">
            <h3>üíæ Database Stats</h3>
            <div id="revenueStats"></div>
          </div>
        </div>

        <div class="grid">
          <div class="card" style="grid-column: 1 / -1;">
            <h3>üö® System Health</h3>
            <table>
              <tr>
                <td>Status</td>
                <td id="health_status"><span class="spinner"></span></td>
              </tr>
              <tr>
                <td>Uptime</td>
                <td id="health_uptime">-</td>
              </tr>
              <tr>
                <td>Response Time</td>
                <td id="health_response">-</td>
              </tr>
              <tr>
                <td>Database</td>
                <td id="health_db">-</td>
              </tr>
              <tr>
                <td>Last Backup</td>
                <td id="health_backup">-</td>
              </tr>
            </table>
          </div>
        </div>
      </div>

      <!-- CONTENT BOT STATS TAB -->
      <div id="content-stats" class="content">
        <div class="grid">
          <div class="stat-card">
            <div class="stat-label">üë• Groups</div>
            <div class="stat-value" id="cs_groups">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">üí¨ Messages Today</div>
            <div class="stat-value" id="cs_messages">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">üíé EMRD Distributed</div>
            <div class="stat-value" id="cs_tokens">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">üõ°Ô∏è AI Moderation</div>
            <div class="stat-value" id="cs_moderation">-</div>
          </div>
        </div>

        <!-- Groups Stats -->
        <div class="card">
          <h3>üë• Top Groups by Activity</h3>
          <div id="contentGroups" class="list"></div>
        </div>

        <!-- Tokens Stats -->
        <div class="grid">
          <div class="card">
            <h3>üíé Token Economy</h3>
            <div id="contentTokens"></div>
          </div>
          <div class="card">
            <h3>üèÜ Top Token Holders</h3>
            <div id="contentHolders" class="list"></div>
          </div>
        </div>

        <!-- Features Stats -->
        <div class="grid">
          <div class="card">
            <h3>üìñ Story Sharing</h3>
            <div id="contentStories"></div>
          </div>
          <div class="card">
            <h3>üë• Affiliate Program</h3>
            <div id="contentAffiliate"></div>
          </div>
          <div class="card">
            <h3>üì∞ RSS Feeds</h3>
            <div id="contentRss"></div>
          </div>
          <div class="card">
            <h3>üìö Learning Platform</h3>
            <div id="contentLearning"></div>
          </div>
        </div>

        <!-- AI Moderation -->
        <div class="card">
          <h3>üõ°Ô∏è AI Moderation Stats</h3>
          <div id="contentModeration"></div>
        </div>

        <!-- Retention -->
        <div class="card">
          <h3>üìä User Retention</h3>
          <div id="contentRetention"></div>
        </div>

        <!-- Network -->
        <div class="card">
          <h3>üåê Bot Mesh Network</h3>
          <div id="contentNetwork"></div>
        </div>
      </div>

      <!-- BOTS TAB -->
      <div id="bots" class="content">
        <div class="grid" style="margin-bottom: 20px;">
          <button onclick="showModal('addBotModal')" style="width: 100%;">‚ûï Add New Bot</button>
        </div>

        <div class="card">
          <h3>ü§ñ Registered Bots</h3>
          <div id="botsList" class="list"></div>
        </div>
      </div>

      <!-- TOKEN TAB -->
      <div id="token" class="content">
        <div class="grid">
          <div class="card">
            <h3>üíé EMRD Token</h3>
            <div id="tokenInfo"></div>
          </div>
          <div class="card">
            <h3>üìä Token Stats</h3>
            <div id="tokenStats"></div>
          </div>
        </div>

        <div class="card">
          <h3>üí∞ Top Holders</h3>
          <div id="tokenHolders" class="list"></div>
        </div>

        <div class="card">
          <h3>üìù Recent Transactions</h3>
          <table>
            <thead>
              <tr>
                <th>Type</th>
                <th>Amount</th>
                <th>From</th>
                <th>To</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="tokenTransactions"></tbody>
          </table>
        </div>
      </div>

      <!-- ADS TAB -->
      <div id="ads" class="content">
        <div class="grid" style="margin-bottom: 20px;">
          <button onclick="showModal('addAdModal')" style="width: 100%;">‚ûï Create Ad Campaign</button>
        </div>

        <div class="card">
          <h3>üì¢ Ad Campaigns</h3>
          <div id="adsList" class="list"></div>
        </div>

        <div class="grid">
          <div class="card">
            <h3>üìà Ad Performance</h3>
            <div id="adsPerformance"></div>
          </div>
          <div class="card">
            <h3>üí≥ Ad Revenue</h3>
            <div id="adsRevenue"></div>
          </div>
        </div>
      </div>

      <!-- USERS TAB -->
      <div id="users" class="content">
        <div class="card">
          <h3>üë• User Management</h3>
          <table>
            <thead>
              <tr>
                <th>Username</th>
                <th>Role</th>
                <th>Tier</th>
                <th>Joined</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersList"></tbody>
          </table>
        </div>
      </div>

      <!-- MONITORING TAB -->
      <div id="monitoring" class="content">
        <div class="grid">
          <div class="card" style="grid-column: 1 / -1;">
            <h3>üîç System Logs</h3>
            <table>
              <thead>
                <tr>
                  <th>Level</th>
                  <th>Message</th>
                  <th>Time</th>
                </tr>
              </thead>
              <tbody id="systemLogs"></tbody>
            </table>
          </div>
        </div>

        <div class="grid">
          <div class="card">
            <h3>üåê Bot Groups</h3>
            <div id="botGroups" class="list"></div>
          </div>
          <div class="card">
            <h3>üì∞ RSS Feeds</h3>
            <div id="rssFeeds" class="list"></div>
          </div>
        </div>

        <div class="grid">
          <div class="card">
            <h3>üõ°Ô∏è Moderation</h3>
            <div id="moderationStats"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODALS -->
  <!-- Add Bot Modal -->
  <div id="addBotModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add New Bot</h2>
        <button class="modal-close" onclick="closeModal('addBotModal')">√ó</button>
      </div>
      <form onsubmit="submitAddBot(event)">
        <div class="form-group">
          <label>Bot Name</label>
          <input type="text" id="botName" required>
        </div>
        <div class="form-group">
          <label>Slug (identifier)</label>
          <input type="text" id="botSlug" required>
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="botDescription" rows="3"></textarea>
        </div>
        <button type="submit" style="width: 100%;">Create Bot</button>
      </form>
    </div>
  </div>

  <!-- Add Ad Modal -->
  <div id="addAdModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Create Ad Campaign</h2>
        <button class="modal-close" onclick="closeModal('addAdModal')">√ó</button>
      </div>
      <form onsubmit="submitAddAd(event)">
        <div class="form-group">
          <label>Campaign Name</label>
          <input type="text" id="adName" required>
        </div>
        <div class="form-group">
          <label>Bot (optional)</label>
          <select id="adBot">
            <option value="">All Bots</option>
          </select>
        </div>
        <div class="form-group">
          <label>Placement Type</label>
          <select id="adPlacement" required>
            <option value="banner">Banner</option>
            <option value="inline">Inline</option>
            <option value="popup">Popup</option>
          </select>
        </div>
        <div class="form-group">
          <label>Content</label>
          <textarea id="adContent" rows="3" required></textarea>
        </div>
        <button type="submit" style="width: 100%;">Create Campaign</button>
      </form>
    </div>
  </div>

  <script>
    // ============================================
    // GLOBAL VARIABLES
    // ============================================
    // API_BASE - Automatische Erkennung oder manuelle Konfiguration
    const API_BASE = (function() {
      // 1. Pr√ºfe auf manuelle Konfiguration in localStorage
      const stored = localStorage.getItem('api_base');
      if (stored) return stored;
      
      // 2. Pr√ºfe auf Query Parameter (?api=https://...)
      const params = new URLSearchParams(window.location.search);
      if (params.has('api')) {
        const api = params.get('api');
        localStorage.setItem('api_base', api);
        return api;
      }
      
      // 3. Pr√ºfe ob wir lokal entwickeln
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        return 'http://localhost:8000/api';
      }
      
      // 4. Fallback: Production Heroku
      return 'https://emeraldcontent-aac379fc581e.herokuapp.com/api';
    })();
    
    let authToken = localStorage.getItem('auth_token');
    let currentUser = null;
    let TelegramWebApp = window.Telegram?.WebApp;

    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', async () => {
      if (authToken) {
        await initDashboard();
      } else {
        setupLoginButton();
      }
    });

    // ============================================
    // TELEGRAM LOGIN
    // ============================================
    function setupLoginButton() {
      const btn = document.getElementById('telegramLoginBtn');
      if (TelegramWebApp) {
        btn.onclick = () => {
          TelegramWebApp.ready();
          const initData = TelegramWebApp.initData;
          if (!initData) {
            alert('Please open this link from Telegram');
            return;
          }
          performTelegramAuth(initData);
        };
      } else {
        btn.onclick = () => {
          // Fallback: Open in Telegram
          window.location.href = `https://t.me/EmeraldContentBot?startapp=dashboard`;
        };
      }
    }

    async function performTelegramAuth(initData) {
      try {
        const params = new URLSearchParams(initData);
        const payload = {
          id: parseInt(params.get('user')
            ? JSON.parse(decodeURIComponent(params.get('user'))).id
            : 0),
          auth_date: parseInt(params.get('auth_date')),
          hash: params.get('hash'),
          username: params.get('user')
            ? JSON.parse(decodeURIComponent(params.get('user'))).username
            : undefined,
          first_name: params.get('user')
            ? JSON.parse(decodeURIComponent(params.get('user'))).first_name
            : undefined,
          last_name: params.get('user')
            ? JSON.parse(decodeURIComponent(params.get('user'))).last_name
            : undefined,
          photo_url: params.get('user')
            ? JSON.parse(decodeURIComponent(params.get('user'))).photo_url
            : undefined
        };

        const response = await fetch(`${API_BASE}/devdash/auth/telegram`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error('Auth failed');
        
        const data = await response.json();
        authToken = data.access_token;
        localStorage.setItem('auth_token', authToken);
        
        await initDashboard();
      } catch (error) {
        console.error('Telegram auth failed:', error);
        alert('Authentication failed: ' + error.message);
      }
    }

    // Alternative Auth Methods
    async function devLogin() {
      const code = prompt('Enter DEV_LOGIN_CODE:');
      if (!code) return;
      const tg_id = prompt('Enter Telegram ID:');
      if (!tg_id) return;
      
      try {
        const response = await fetch(`${API_BASE}/devdash/dev-login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ telegram_id: parseInt(tg_id), code })
        });
        
        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Dev login failed');
        }
        
        const data = await response.json();
        authToken = data.access_token;
        localStorage.setItem('auth_token', authToken);
        await initDashboard();
      } catch (error) {
        alert('Dev login failed: ' + error.message);
      }
    }

    async function tonWalletLogin() {
      const ton_address = prompt('Enter TON wallet address (UQA...):');
      if (!ton_address) return;
      
      try {
        const response = await fetch(`${API_BASE}/devdash/auth/ton-wallet`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ton_address })
        });
        
        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'TON login failed');
        }
        
        const data = await response.json();
        authToken = data.access_token;
        localStorage.setItem('auth_token', authToken);
        await initDashboard();
      } catch (error) {
        alert('TON login failed: ' + error.message);
      }
    }

    async function nearWalletLogin() {
      const near_account_id = prompt('Enter NEAR account ID (user.near):');
      if (!near_account_id) return;
      
      try {
        const response = await fetch(`${API_BASE}/devdash/auth/near-wallet`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ near_account_id })
        });
        
        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'NEAR login failed');
        }
        
        const data = await response.json();
        authToken = data.access_token;
        localStorage.setItem('auth_token', authToken);
        await initDashboard();
      } catch (error) {
        alert('NEAR login failed: ' + error.message);
      }
    }

    // ============================================
    // API HELPER
    // ============================================
    async function apiCall(endpoint, options = {}) {
      const defaultOptions = {
        headers: {
          'Authorization': `Bearer ${authToken}`,
          'Content-Type': 'application/json'
        }
      };

      const response = await fetch(`${API_BASE}${endpoint}`, {
        ...defaultOptions,
        ...options,
        headers: {
          ...defaultOptions.headers,
          ...(options.headers || {})
        }
      });

      if (!response.ok) {
        if (response.status === 401) {
          logout();
          throw new Error('Not authenticated');
        }
        const error = await response.json().catch(() => ({}));
        throw new Error(error.detail || `HTTP ${response.status}`);
      }

      return response.json();
    }

    // ============================================
    // DASHBOARD INITIALIZATION
    // ============================================
    async function initDashboard() {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('dashboard').classList.add('active');

      try {
        // Load all dashboard data in parallel for all tabs
        await Promise.all([
          loadUserProfile(),
          refreshOverview(),
          loadAnalytics(),
          loadMonitoring(),
          loadBots(),
          loadTokenData(),
          loadAds(),
          loadUsers()
        ]);
        
        setupNavigation();
        
        // Auto-refresh every 30s for overview, 60s for other tabs
        setInterval(refreshOverview, 30000);
        setInterval(loadAnalytics, 60000);
        setInterval(loadMonitoring, 60000);
        setInterval(loadBots, 120000);
        setInterval(loadTokenData, 120000);
      } catch (error) {
        console.error('Failed to initialize dashboard:', error);
        logout();
      }
    }

    // ============================================
    // USER PROFILE
    // ============================================
    async function loadUserProfile() {
      try {
        const data = await apiCall('/devdash/me');
        currentUser = data;

        const userBox = document.getElementById('userBox');
        const profile = data.profile || {};
        const img = profile.photo_url ? `<img src="${profile.photo_url}" alt="Avatar">` : '';

        userBox.innerHTML = `
          ${img}
          <div class="user-info">
            <div class="user-name">@${profile.username || profile.id}</div>
            <div class="user-role">${data.role} ‚Ä¢ ${data.tier}</div>
          </div>
        `;
      } catch (error) {
        console.error('Failed to load user:', error);
      }
    }

    // ============================================
    // NAVIGATION
    // ============================================
    function setupNavigation() {
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tabName = btn.dataset.tab;
          switchTab(tabName);
        });
      });
    }

    function switchTab(tabName) {
      // Hide all
      document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));

      // Show selected
      const tab = document.getElementById(tabName);
      const btn = document.querySelector(`[data-tab="${tabName}"]`);
      
      if (tab && btn) {
        tab.classList.add('active');
        btn.classList.add('active');
        
        // Load tab data
        switch (tabName) {
          case 'content-stats':
            loadContentBotStats();
            break;
          case 'bots':
            loadBots();
            break;
          case 'token':
            loadTokenData();
            break;
          case 'ads':
            loadAds();
            break;
          case 'users':
            loadUsers();
            break;
          case 'monitoring':
            loadMonitoring();
            break;
        }
      }
    }

    // ============================================
    // CONTENT BOT STATISTICS
    // ============================================
    async function loadContentBotStats() {
      try {
        // Load all 7 statistics endpoints in parallel
        const [overview, groups, tokens, moderation, features, retention, network] = await Promise.all([
          apiCall('/devdash/content/stats/overview'),
          apiCall('/devdash/content/stats/groups'),
          apiCall('/devdash/content/stats/tokens'),
          apiCall('/devdash/content/stats/ai-moderation'),
          apiCall('/devdash/content/stats/features'),
          apiCall('/devdash/content/stats/retention'),
          apiCall('/devdash/content/stats/network')
        ]);

        // Update header stats
        document.getElementById('cs_groups').textContent = overview.groups.total_groups || 0;
        document.getElementById('cs_messages').textContent = overview.messages.today || 0;
        document.getElementById('cs_tokens').textContent = overview.tokens.total_distributed || 0;
        document.getElementById('cs_moderation').textContent = moderation.actions.actions_today || 0;

        // Groups - Top by activity
        const groupsHtml = (groups.groups || []).map(g => `
          <div class="list-item">
            <div class="list-item-content">
              <div class="item-title">üë• ${g.name || `Group #${g.id}`}</div>
              <div class="item-desc">
                ${g.member_count} members ‚Ä¢ ${g.messages_total} messages ‚Ä¢ Last active: ${new Date(g.last_activity).toLocaleDateString()}
              </div>
            </div>
            <span class="item-status">${g.messages_today} today</span>
          </div>
        `).join('');
        document.getElementById('contentGroups').innerHTML = groupsHtml || '<p style="color: var(--text-secondary);">No group data</p>';

        // Tokens - Stats and holders
        const tokenStatsHtml = `
          <div style="line-height: 2;">
            <div><strong>üí∞ Distributed:</strong> ${(tokens.EMRD.total_distributed / 1e18).toLocaleString()} EMRD</div>
            <div><strong>‚úÖ Claimed:</strong> ${(tokens.EMRD.total_claimed / 1e18).toLocaleString()} EMRD</div>
            <div><strong>‚è≥ Pending:</strong> ${(tokens.EMRD.total_pending / 1e18).toLocaleString()} EMRD</div>
            <div><strong>üë• Holders:</strong> ${tokens.EMRD.holders_count}</div>
          </div>
        `;
        document.getElementById('contentTokens').innerHTML = tokenStatsHtml;

        const holdersHtml = (tokens.top_holders || []).map(h => `
          <div class="list-item">
            <div class="list-item-content">
              <div class="item-title">Holder ${h.rank}</div>
              <div class="item-desc">${(h.amount / 1e18).toLocaleString()} EMRD</div>
            </div>
            <span class="item-status">${h.percentage.toFixed(2)}%</span>
          </div>
        `).join('');
        document.getElementById('contentHolders').innerHTML = holdersHtml || '<p style="color: var(--text-secondary);">No holders</p>';

        // Features - Story Sharing
        const storiesHtml = `
          <div style="line-height: 1.8;">
            <div><strong>üìä Enabled Groups:</strong> ${features.features.story_sharing.enabled_groups}</div>
            <div><strong>üì§ Total Shares:</strong> ${features.features.story_sharing.total_shares}</div>
            <div><strong>üëÜ Total Clicks:</strong> ${features.features.story_sharing.total_clicks}</div>
            <div><strong>üìà Avg Clicks/Share:</strong> ${features.features.story_sharing.avg_clicks_per_share.toFixed(2)}</div>
          </div>
        `;
        document.getElementById('contentStories').innerHTML = storiesHtml;

        // Features - Affiliate
        const affiliateHtml = `
          <div style="line-height: 1.8;">
            <div><strong>üéØ Active Programs:</strong> ${features.features.affiliate.active_programs}</div>
            <div><strong>üë• Active Referrers:</strong> ${features.features.affiliate.active_referrers}</div>
            <div><strong>üìå Total Referrals:</strong> ${features.features.affiliate.total_referrals}</div>
            <div><strong>üí∞ Total Earned:</strong> ${features.features.affiliate.total_earned.toFixed(2)} EMRD</div>
            <div><strong>üìä Avg Commission:</strong> ${features.features.affiliate.avg_commission.toFixed(2)} EMRD</div>
          </div>
        `;
        document.getElementById('contentAffiliate').innerHTML = affiliateHtml;

        // Features - RSS
        const rssHtml = `
          <div style="line-height: 1.8;">
            <div><strong>üì° Active Feeds:</strong> ${features.features.rss.active_feeds}</div>
            <div><strong>üì∞ Posts Today:</strong> ${features.features.rss.posts_today}</div>
            <div><strong>üìÖ Posts This Week:</strong> ${features.features.rss.posts_week}</div>
            <div><strong>üìÜ Posts This Month:</strong> ${features.features.rss.posts_month}</div>
          </div>
        `;
        document.getElementById('contentRss').innerHTML = rssHtml;

        // Features - Learning
        const learningHtml = `
          <div style="line-height: 1.8;">
            <div><strong>üìö Courses:</strong> ${features.features.learning.courses}</div>
            <div><strong>üë• Enrolled:</strong> ${features.features.learning.users_enrolled}</div>
            <div><strong>‚úÖ Completed:</strong> ${features.features.learning.completed_courses}</div>
            <div><strong>üìà Completion Rate:</strong> ${features.features.learning.completion_rate.toFixed(1)}%</div>
            <div><strong>üéì Certificates:</strong> ${features.features.learning.certificates_issued}</div>
            <div><strong>üéÅ Quizzes Passed:</strong> ${features.features.learning.quizzes_passed}</div>
          </div>
        `;
        document.getElementById('contentLearning').innerHTML = learningHtml;

        // AI Moderation
        const moderationHtml = `
          <div style="line-height: 1.8;">
            <div><strong>‚úÖ Enabled Groups:</strong> ${moderation.enabled_groups}</div>
            <div><strong>üìä Actions Today:</strong> ${moderation.actions.actions_today}</div>
            <div><strong>üìÖ Actions This Week:</strong> ${moderation.actions.actions_week}</div>
            <div><strong>üóëÔ∏è Deleted Messages:</strong> ${moderation.deleted_messages_total}</div>
            <div><strong>‚ö†Ô∏è Warnings Issued:</strong> ${moderation.warnings_total}</div>
            <div><strong>üìà Avg Strike Score:</strong> ${moderation.avg_strike_score.toFixed(2)}</div>
          </div>
          ${moderation.top_offenders && moderation.top_offenders.length > 0 ? `
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
              <strong>üö® Top Offenders:</strong>
              ${moderation.top_offenders.slice(0, 5).map((o, i) => `
                <div style="margin-top: 8px; font-size: 13px;">
                  ${i + 1}. Violations: ${o.violation_count} ‚Ä¢ Deleted: ${o.deleted_count}
                </div>
              `).join('')}
            </div>
          ` : ''}
        `;
        document.getElementById('contentModeration').innerHTML = moderationHtml;

        // Retention
        const retentionHtml = `
          <div style="line-height: 1.8;">
            <div><strong>üë• Total Active Users:</strong> ${retention.retention.active_users_total}</div>
            <div><strong>üìä Active Today:</strong> ${retention.retention.active_today}</div>
            <div><strong>üìà Active This Week:</strong> ${retention.retention.active_week}</div>
            <div><strong>üìÜ Active This Month:</strong> ${retention.retention.active_month}</div>
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
              <div><strong style="color: var(--success);">‚úì Retention Rate:</strong> ${retention.retention.retention_rate.toFixed(1)}%</div>
              <div><strong style="color: var(--warning);">‚ö† Churn Rate:</strong> ${retention.retention.churn_rate.toFixed(1)}%</div>
            </div>
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
              <div><strong>üí¨ Messages per User:</strong> ${retention.engagement.messages_per_user.toFixed(1)}</div>
              <div><strong>üë• Groups per User:</strong> ${retention.engagement.groups_per_user.toFixed(1)}</div>
            </div>
          </div>
        `;
        document.getElementById('contentRetention').innerHTML = retentionHtml;

        // Network
        const networkHtml = `
          <div style="line-height: 1.8;">
            <div><strong>ü§ñ Total Bots:</strong> ${network.network.total_bots}</div>
            <div><strong style="color: var(--success);">‚úì Online:</strong> ${network.network.bots_online}</div>
            <div><strong style="color: var(--warning);">‚úó Offline:</strong> ${network.network.bots_offline}</div>
            <div><strong>üìä Health:</strong> ${network.network.health_percentage.toFixed(1)}%</div>
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
              <div><strong>üîå Total Endpoints:</strong> ${network.network.total_endpoints}</div>
              <div><strong style="color: var(--success);">‚úì Healthy:</strong> ${network.network.healthy_endpoints}</div>
              <div><strong style="color: var(--warning);">‚ö† Unhealthy:</strong> ${network.network.unhealthy_endpoints}</div>
              <div><strong>‚è±Ô∏è Avg Latency:</strong> ${network.network.average_latency_ms}ms</div>
            </div>
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
              <div><strong>‚ùå Errors Today:</strong> ${network.network.errors_today}</div>
              <div><strong>üìä Error Rate:</strong> ${network.network.error_rate.toFixed(2)}%</div>
            </div>
          </div>
          ${network.network.bots && network.network.bots.length > 0 ? `
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
              <strong>ü§ñ Bots Detail:</strong>
              ${network.network.bots.slice(0, 10).map(b => `
                <div style="margin-top: 8px; font-size: 13px; padding: 8px; background: rgba(0,208,132,0.1); border-radius: 4px;">
                  <div><strong>${b.username}</strong> ${b.is_active ? '‚úì' : '‚úó'}</div>
                  <div style="color: var(--text-secondary);">Endpoints: ${b.healthy_endpoints}/${b.endpoint_count} ‚Ä¢ Latency: ${b.endpoint_latency_ms}ms</div>
                </div>
              `).join('')}
            </div>
          ` : ''}
        `;
        document.getElementById('contentNetwork').innerHTML = networkHtml;

      } catch (error) {
        console.error('Failed to load content bot stats:', error);
        const errorMsg = '<p style="color: var(--danger);">Error loading statistics: ' + error.message + '</p>';
        document.getElementById('contentGroups').innerHTML = errorMsg;
      }
    }

    // ============================================
    // OVERVIEW
    // ============================================
    async function refreshOverview() {
      try {
        // Load system health first
        const health = await apiCall('/system/health');
        
        // Update stat cards with real data
        document.getElementById('stat_users').textContent = health.database.users_total || 0;
        document.getElementById('stat_bots').textContent = health.database.bots_active || 0;
        document.getElementById('stat_ads').textContent = health.database.ads_active || 0;
        
        // Update health section
        const healthStatus = health.status === 'healthy' ? '‚úì Healthy' : '‚ö† Degraded';
        const healthColor = health.status === 'healthy' ? 'var(--success)' : 'var(--warning)';
        document.getElementById('health_status').innerHTML = `<span style="color: ${healthColor};">${healthStatus}</span>`;
        document.getElementById('health_response').textContent = `${health.response_time_ms}ms`;
        document.getElementById('health_db').textContent = health.database.status;
        document.getElementById('health_backup').textContent = health.database.last_backup;
        
        // Load analytics (metrics only, no bot activity)
        await loadAnalytics();
      } catch (error) {
        console.error('Failed to load overview:', error);
      }
    }

    async function loadAnalytics() {
      try {
        // Get monitoring data and system health
        const monitoring = await apiCall('/devdash/monitoring');
        const health = await apiCall('/system/health');

        // Remove bot activity, show only metrics
        // Activity Stats
        const activityHtml = `
          <div class="list-item">
            <div class="list-item-content">
              <div class="item-title">üë• Users (24h)</div>
              <div class="item-desc">${monitoring.activity_24h.new_users} new users</div>
            </div>
          </div>
          <div class="list-item">
            <div class="list-item-content">
              <div class="item-title">üì¢ Ads (24h)</div>
              <div class="item-desc">${monitoring.activity_24h.new_ads} new campaigns</div>
            </div>
          </div>
          <div class="list-item">
            <div class="list-item-content">
              <div class="item-title">üíæ Database Events</div>
              <div class="item-desc">${monitoring.database.token_events} token events</div>
            </div>
          </div>
        `;
        document.getElementById('botActivityChart').innerHTML = activityHtml;

        // System Stats with progress bars
        document.getElementById('userGrowthChart').innerHTML = `
          <div class="list-item">
            <div class="list-item-content">
              <div class="item-title">üñ•Ô∏è CPU Usage</div>
              <div class="card .progress" style="margin-top: 8px;">
                <div class="progress-bar" style="width: ${health.system.cpu_percent}%"></div>
              </div>
              <div class="item-desc">${health.system.cpu_percent.toFixed(1)}% (${health.system.cpu_count} cores)</div>
            </div>
          </div>
          <div class="list-item">
            <div class="list-item-content">
              <div class="item-title">üíæ Memory Usage</div>
              <div class="card .progress" style="margin-top: 8px;">
                <div class="progress-bar" style="width: ${health.system.memory_percent}%"></div>
              </div>
              <div class="item-desc">${health.system.memory_percent.toFixed(1)}% (${health.system.memory_used_mb}/${health.system.memory_total_mb} MB)</div>
            </div>
          </div>
          <div class="list-item">
            <div class="list-item-content">
              <div class="item-title">üíø Disk Usage</div>
              <div class="card .progress" style="margin-top: 8px;">
                <div class="progress-bar" style="width: ${health.system.disk_percent}%"></div>
              </div>
              <div class="item-desc">${health.system.disk_percent.toFixed(1)}% (${health.system.disk_used_gb}/${health.system.disk_total_gb} GB)</div>
            </div>
          </div>
        `;

        // Database Status
        document.getElementById('revenueStats').innerHTML = `
          <div style="font-weight: 600; margin-bottom: 12px;">üìä Database Statistics</div>
          <div class="list-item" style="border: none; background: none; padding: 0;">
            <div class="list-item-content">
              <div class="item-title">Total Users</div>
              <div class="item-desc">${monitoring.database.users}</div>
            </div>
          </div>
          <div class="list-item" style="border: none; background: none; padding: 0;">
            <div class="list-item-content">
              <div class="item-title">Active Bots</div>
              <div class="item-desc">${monitoring.database.active_bots}</div>
            </div>
          </div>
          <div class="list-item" style="border: none; background: none; padding: 0;">
            <div class="list-item-content">
              <div class="item-title">Active Ads</div>
              <div class="item-desc">${monitoring.database.active_ads}</div>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Failed to load analytics:', error);
        document.getElementById('botActivityChart').innerHTML = '<p style="color: var(--text-secondary);">Error loading data</p>';
      }
    }

    // ============================================
    // BOTS
    // ============================================
    async function loadBots() {
      try {
        // Load detailed bot information
        const data = await apiCall('/analytics/bot-detailed');
        const botsList = document.getElementById('botsList');

        if (!data.bots || data.bots.length === 0) {
          botsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ü§ñ</div><div class="empty-state-text">No bots yet</div></div>';
          return;
        }

        botsList.innerHTML = data.bots.map(bot => `
          <div class="bot-item">
            <div class="bot-header" onclick="toggleBotDetails(this, '${bot.username}')">
              <div class="bot-header-content">
                <div class="bot-title">ü§ñ ${bot.title || bot.username}</div>
                <div class="bot-meta">
                  <strong>${bot.username}</strong> ‚Ä¢ ${bot.user_count} users ‚Ä¢ ${bot.days_running} days running
                  <span style="color: ${bot.is_active ? 'var(--success)' : 'var(--text-secondary)'}">‚Ä¢ ${bot.is_active ? '‚úÖ Active' : '‚≠ï Inactive'}</span>
                </div>
              </div>
              <span class="bot-toggle">‚ñº</span>
            </div>
            <div class="bot-details" id="details_${bot.username}"></div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Failed to load bots:', error);
        document.getElementById('botsList').innerHTML = '<p style="color: var(--text-secondary);">Error loading bot data</p>';
      }
    }

    async function toggleBotDetails(headerEl, botUsername) {
      const detailsEl = document.getElementById(`details_${botUsername}`);
      const toggleEl = headerEl.querySelector('.bot-toggle');
      
      // If already expanded, just collapse
      if (detailsEl.classList.contains('show')) {
        detailsEl.classList.remove('show');
        headerEl.classList.remove('expanded');
        toggleEl.classList.remove('open');
        return;
      }

      // Load details if not already loaded
      if (!detailsEl.innerHTML) {
        try {
          const data = await apiCall(`/analytics/bot-details?bot=${botUsername}`);
          
          const statsHtml = `
            <div class="bot-stats-grid">
              <!-- Affiliate -->
              <div class="bot-stat-card">
                <h4>üë• Affiliate Stats</h4>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Total Referrals</span>
                  <span class="bot-stat-value">${parseInt(data.affiliate?.total_referrals) || 0}</span>
                </div>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Converted</span>
                  <span class="bot-stat-value">${parseInt(data.affiliate?.converted_referrals) || 0}</span>
                </div>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Total Commissions</span>
                  <span class="bot-stat-value">${(parseFloat(data.affiliate?.total_commissions) || 0).toFixed(2)} EMRD</span>
                </div>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Pending Payouts</span>
                  <span class="bot-stat-value">${(parseFloat(data.affiliate?.pending_payouts) || 0).toFixed(2)} EMRD</span>
                </div>
              </div>

              <!-- Trading -->
              <div class="bot-stat-card">
                <h4>üíπ Trading Stats</h4>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Portfolios</span>
                  <span class="bot-stat-value">${parseInt(data.trade?.portfolios) || 0}</span>
                </div>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Active Positions</span>
                  <span class="bot-stat-value">${parseInt(data.trade?.active_positions) || 0}</span>
                </div>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Total Alerts</span>
                  <span class="bot-stat-value">${parseInt(data.trade?.total_alerts) || 0}</span>
                </div>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Active Strategies</span>
                  <span class="bot-stat-value">${parseInt(data.trade?.active_strategies) || 0}</span>
                </div>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Swap Volume</span>
                  <span class="bot-stat-value">${(parseFloat(data.trade?.total_swap_volume) || 0).toFixed(2)}</span>
                </div>
              </div>

              <!-- Learning -->
              <div class="bot-stat-card">
                <h4>üìö Learning Stats</h4>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Total Courses</span>
                  <span class="bot-stat-value">${parseInt(data.learning?.total_courses) || 0}</span>
                </div>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Enrolled Users</span>
                  <span class="bot-stat-value">${parseInt(data.learning?.enrolled_users) || 0}</span>
                </div>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Completed Courses</span>
                  <span class="bot-stat-value">${parseInt(data.learning?.completed_courses) || 0}</span>
                </div>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Total Quizzes</span>
                  <span class="bot-stat-value">${parseInt(data.learning?.total_quizzes) || 0}</span>
                </div>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Certificates Issued</span>
                  <span class="bot-stat-value">${parseInt(data.learning?.certificates_issued) || 0}</span>
                </div>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Rewards Distributed</span>
                  <span class="bot-stat-value">${(parseFloat(data.learning?.total_rewards_distributed) || 0).toFixed(2)} EMRD</span>
                </div>
              </div>

              <!-- DAO -->
              <div class="bot-stat-card">
                <h4>üèõÔ∏è DAO Stats</h4>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Active Proposals</span>
                  <span class="bot-stat-value">${parseInt(data.dao?.active_proposals) || 0}</span>
                </div>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Total Voters</span>
                  <span class="bot-stat-value">${parseInt(data.dao?.total_voters) || 0}</span>
                </div>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Treasury Balance</span>
                  <span class="bot-stat-value">${(parseFloat(data.dao?.treasury_balance) || 0).toFixed(2)} EMRD</span>
                </div>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Total Delegations</span>
                  <span class="bot-stat-value">${parseInt(data.dao?.total_delegations) || 0}</span>
                </div>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Governance Participation</span>
                  <span class="bot-stat-value">${(parseFloat(data.dao?.governance_participation) || 0).toFixed(1)}%</span>
                </div>
              </div>

              <!-- Support -->
              <div class="bot-stat-card">
                <h4>üõü Support Stats</h4>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Open Tickets</span>
                  <span class="bot-stat-value">${parseInt(data.support?.open_tickets) || 0}</span>
                </div>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Resolved Tickets</span>
                  <span class="bot-stat-value">${parseInt(data.support?.resolved_tickets) || 0}</span>
                </div>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Avg Resolution Time</span>
                  <span class="bot-stat-value">${(parseFloat(data.support?.avg_resolution_time_hours) || 0).toFixed(1)}h</span>
                </div>
              </div>

              <!-- Content -->
              <div class="bot-stat-card">
                <h4>üì∞ Content Stats</h4>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Total Members</span>
                  <span class="bot-stat-value">${parseInt(data.content?.total_members) || 0}</span>
                </div>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Active Topics</span>
                  <span class="bot-stat-value">${parseInt(data.content?.active_topics) || 0}</span>
                </div>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Stories Shared</span>
                  <span class="bot-stat-value">${parseInt(data.content?.stories_shared) || 0}</span>
                </div>
                <div class="bot-stat-item">
                  <span class="bot-stat-label">Trending Stories</span>
                  <span class="bot-stat-value">${parseInt(data.content?.trending_stories) || 0}</span>
                </div>
              </div>
            </div>
          `;
          
          detailsEl.innerHTML = statsHtml;
        } catch (error) {
          console.error('Failed to load bot details:', error);
          detailsEl.innerHTML = `<p style="color: var(--text-secondary); padding: 20px;">Error loading details: ${error.message}</p>`;
        }
      }

      // Show details
      detailsEl.classList.add('show');
      headerEl.classList.add('expanded');
      toggleEl.classList.add('open');
    }

    // ============================================
    // TOKEN
    // ============================================
    async function loadTokenData() {
      try {
        // Load real token data from blockchain
        const tokenInfo = await apiCall('/token/emrd');
        const holders = await apiCall('/token/holders?limit=10');

        // Token Info Card
        document.getElementById('tokenInfo').innerHTML = `
          <div class="item-title">üéØ ${tokenInfo.name}</div>
          <div style="margin-top: 12px; line-height: 1.8;">
            <div><strong>Symbol:</strong> ${tokenInfo.symbol}</div>
            <div><strong>Network:</strong> ${tokenInfo.network}</div>
            <div><strong>Decimals:</strong> ${tokenInfo.decimals}</div>
            <div><strong>Status:</strong> <span style="color: var(--success);">‚óè ${tokenInfo.status}</span></div>
            <div style="margin-top: 10px;"><strong>Contract:</strong><br><code style="font-size: 10px; word-break: break-all; color: var(--text-secondary);">${tokenInfo.contract}</code></div>
          </div>
        `;

        // Token Stats Card
        document.getElementById('tokenStats').innerHTML = `
          <div style="line-height: 2;">
            <div><strong>Total Supply:</strong> ${tokenInfo.supply_units}</div>
            <div><strong>Min Balance:</strong> ${tokenInfo.min_balance}</div>
            <div><strong>Developer:</strong><br><code style="font-size: 10px; word-break: break-all; color: var(--text-secondary);">${tokenInfo.developer_address}</code></div>
            <div style="margin-top: 10px;">
              <a href="${tokenInfo.blockchain_explorer}" target="_blank" style="color: var(--primary); text-decoration: none;">üîó View on Explorer</a>
            </div>
          </div>
        `;

        // Top Holders
        const holdersHtml = (holders.holders || []).map(h => `
          <div class="list-item">
            <div class="list-item-content">
              <div class="item-title">${h.name || h.address.substring(0, 16)}...</div>
              <div class="item-desc">${(parseInt(h.balance) / 1e18).toLocaleString()} EMRD</div>
            </div>
            <span class="item-status">${h.percentage}%</span>
          </div>
        `).join('');
        document.getElementById('tokenHolders').innerHTML = holdersHtml || '<p style="color: var(--text-secondary);">No holder data</p>';

        // Total Holders Info
        document.getElementById('holderCount').textContent = holders.total_holders || 0;
      } catch (error) {
        console.error('Failed to load token data:', error);
        document.getElementById('tokenInfo').innerHTML = '<p style="color: var(--text-secondary);">Error loading token data</p>';
      }
    }

    // ============================================
    // ADS
    // ============================================
    async function loadAds() {
      try {
        const data = await apiCall('/devdash/ads');
        const adsList = document.getElementById('adsList');

        if (!data.ads || data.ads.length === 0) {
          adsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¢</div><div class="empty-state-text">No ads yet</div></div>';
          return;
        }

        adsList.innerHTML = data.ads.map(ad => `
          <div class="list-item">
            <div class="list-item-content">
              <div class="item-title">üì¢ ${ad.name}</div>
              <div class="item-desc">${ad.placement}${ad.bot_slug ? ' ‚Ä¢ ' + ad.bot_slug : ''}</div>
              <div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">${ad.content.substring(0, 100)}...</div>
            </div>
            <span class="item-status ${ad.is_active ? '' : 'inactive'}">
              ${ad.is_active ? 'Active' : 'Inactive'}
            </span>
          </div>
        `).join('');

        // Load bots for dropdown
        const bots = await apiCall('/devdash/bots');
        const botSelect = document.getElementById('adBot');
        botSelect.innerHTML = '<option value="">All Bots</option>' + 
          bots.bots.map(b => `<option value="${b.username}">${b.title || b.username}</option>`).join('');
      } catch (error) {
        console.error('Failed to load ads:', error);
      }
    }

    // ============================================
    // USERS
    // ============================================
    async function loadUsers() {
      try {
        const data = await apiCall('/devdash/users?limit=50');
        const usersList = document.getElementById('usersList');

        if (!data.users || data.users.length === 0) {
          usersList.innerHTML = '<tr><td colspan="5" style="text-align: center;">No users</td></tr>';
          return;
        }

        usersList.innerHTML = data.users.map(user => `
          <tr>
            <td>${user.username || `#${user.telegram_id}`}</td>
            <td>${user.role}</td>
            <td>${user.tier}</td>
            <td>${new Date(user.created_at).toLocaleDateString()}</td>
            <td><button onclick="editUserTier(${user.telegram_id})">Edit</button></td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Failed to load users:', error);
      }
    }

    // ============================================
    // MONITORING
    // ============================================
    async function loadMonitoring() {
      try {
        // Get real monitoring data
        const monitoring = await apiCall('/devdash/monitoring');
        const health = await apiCall('/system/health');
        
        // System metrics with detailed info
        const systemHtml = `
          <tr>
            <td>üñ•Ô∏è CPU Usage</td>
            <td>${health.system.cpu_percent.toFixed(2)}%</td>
            <td><div class="card .progress"><div class="progress-bar" style="width: ${health.system.cpu_percent}%"></div></div></td>
            <td>${health.system.cpu_count} cores</td>
          </tr>
          <tr>
            <td>üíæ Memory Usage</td>
            <td>${health.system.memory_percent.toFixed(2)}%</td>
            <td><div class="card .progress"><div class="progress-bar" style="width: ${health.system.memory_percent}%"></div></div></td>
            <td>${health.system.memory_used_mb}/${health.system.memory_total_mb} MB</td>
          </tr>
          <tr>
            <td>üíø Disk Usage</td>
            <td>${health.system.disk_percent.toFixed(2)}%</td>
            <td><div class="card .progress"><div class="progress-bar" style="width: ${health.system.disk_percent}%"></div></div></td>
            <td>${health.system.disk_used_gb}/${health.system.disk_total_gb} GB</td>
          </tr>
        `;
        document.getElementById('systemLogs').innerHTML = systemHtml;

        // Database stats with full details
        const dbHtml = `
          <tr>
            <td>üë• Total Users</td>
            <td>${health.database.users_total}</td>
          </tr>
          <tr>
            <td>ü§ñ Active Bots</td>
            <td>${health.database.bots_active}/${health.database.bots_total}</td>
          </tr>
          <tr>
            <td>üì¢ Active Ads</td>
            <td>${health.database.ads_active}/${health.database.ads_total}</td>
          </tr>
          <tr>
            <td>üîó Token Events</td>
            <td>${health.database.token_events}</td>
          </tr>
        `;
        document.getElementById('botGroups').innerHTML = dbHtml;

        // Activity in last 24h
        const activityHtml = `
          <tr>
            <td>üìà New Users (24h)</td>
            <td>${monitoring.activity_24h.new_users}</td>
          </tr>
          <tr>
            <td>üì¢ New Ads (24h)</td>
            <td>${monitoring.activity_24h.new_ads}</td>
          </tr>
          <tr>
            <td>üíæ Database Status</td>
            <td><span class="item-status">${health.database.status.toUpperCase()}</span></td>
          </tr>
          <tr>
            <td>üïê Last Activity</td>
            <td>${health.database.last_activity ? new Date(health.database.last_activity).toLocaleString() : 'Unknown'}</td>
          </tr>
        `;
        document.getElementById('rssFeeds').innerHTML = activityHtml;

        // Health status with full metrics
        document.getElementById('moderationStats').innerHTML = `
          <div><strong>üè• System Status:</strong> <span style="color: ${health.status === 'healthy' ? 'var(--success)' : 'var(--warning)'}">${health.status.toUpperCase()}</span></div>
          <div><strong>‚è±Ô∏è Response Time:</strong> ${health.response_time_ms}ms</div>
          <div><strong>üîå DB Connection:</strong> ${health.database.status.toUpperCase()}</div>
          <div><strong>üì¶ Backup:</strong> ${health.database.last_backup}</div>
          <div style="margin-top: 10px;"><strong>üìä Platform:</strong> ${health.system.platform} ‚Ä¢ Python ${health.system.python_version}</div>
        `;
      } catch (error) {
        console.error('Failed to load monitoring:', error);
        document.getElementById('systemLogs').innerHTML = '<tr><td colspan="3">Error loading data</td></tr>';
      }
    }

    // ============================================
    // MODALS
    // ============================================
    function showModal(modalId) {
      document.getElementById(modalId).classList.add('show');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }

    async function submitAddBot(event) {
      event.preventDefault();
      try {
        const response = await apiCall('/devdash/bots', {
          method: 'POST',
          body: JSON.stringify({
            name: document.getElementById('botName').value,
            slug: document.getElementById('botSlug').value,
            description: document.getElementById('botDescription').value,
            is_active: true
          })
        });

        closeModal('addBotModal');
        event.target.reset();
        await loadBots();
        alert('Bot created successfully!');
      } catch (error) {
        alert('Failed to create bot: ' + error.message);
      }
    }

    async function submitAddAd(event) {
      event.preventDefault();
      try {
        const response = await apiCall('/devdash/ads', {
          method: 'POST',
          body: JSON.stringify({
            name: document.getElementById('adName').value,
            placement: document.getElementById('adPlacement').value,
            content: document.getElementById('adContent').value,
            bot_slug: document.getElementById('adBot').value || null,
            is_active: true
          })
        });

        closeModal('addAdModal');
        event.target.reset();
        await loadAds();
        alert('Ad campaign created successfully!');
      } catch (error) {
        alert('Failed to create ad: ' + error.message);
      }
    }

    // ============================================
    // LOGOUT
    // ============================================
    function logout() {
      localStorage.removeItem('auth_token');
      authToken = null;
      document.getElementById('dashboard').classList.remove('active');
      document.getElementById('loginPage').style.display = 'flex';
      setupLoginButton();
    }
  </script>
</body>
</html>

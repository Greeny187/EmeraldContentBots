<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Emerald DevDashboard</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#0b1020; color:#cbd5e1; margin:20px; }
    .card { background:#111827; border:1px solid #1f2937; border-radius:12px; padding:16px; margin:12px 0; }
    .row  { display:flex; gap:12px; flex-wrap:wrap; }
    button { background:#10b98122; border:1px solid #10b98160; color:#e5e7eb; border-radius:8px; padding:8px 12px; cursor:pointer; }
    pre { white-space: pre-wrap; word-break: break-word; }
    .pill { padding:2px 8px; border:1px solid #374151; border-radius:999px; font-size:12px; }
    input { background:#0b1020; color:#cbd5e1; border:1px solid #1f2937; border-radius:8px; padding:6px 8px; }
    h4 { margin: 8px 0; }    
  </style>
  <script src="https://telegram.org/js/telegram-widget.js?22" async></script>

  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'/%3E">

  <script>
    // ===== GLOBAL CONFIG (edit these) =====
    window.API_BASE     = "https://emeraldcontent-aac379fc581e.herokuapp.com/devdash";  // <- anpassen
    window.BOT_USERNAME = "EmeraldContentBot";                       // <- ohne @
    window.NEAR_NETWORK = "testnet";                                 // oder "testnet"
  </script>
  
  <script>
    window.authHeaders  = authHeaders;
    const tokenKey = "emerald_token";
    const setToken = t => localStorage.setItem(tokenKey, t);
    const getToken = () => localStorage.getItem(tokenKey);
    const authHeaders = () => {
      const t = getToken();
      return t ? { "Authorization":"Bearer "+t, "Content-Type":"application/json" }
               : { "Content-Type":"application/json" };
    };

    window.addEventListener("error", e => console.error("[DevDash] window.error:", e.message, e.filename, e.lineno));

    // ===== TELEGRAM LOGIN CALLBACK =====
    window.onTelegramAuth = async function(user){
      try {
        const res = await fetch(window.API_BASE+"/auth/telegram", {
          method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(user)
        });
        if (!res.ok) { alert("Login fehlgeschlagen: "+ await res.text()); return; }
        const data = await res.json();
        setToken(data.access_token);
        document.getElementById("login").style.display = "none";
        await bootAfterLogin();
      } catch (err) {
        alert("Netzwerkfehler beim Login: "+(err && err.message ? err.message : err));
      }
    };

    // ===== UI Boot (after login) =====
    async function bootAfterLogin(){
      document.getElementById("meCard").style.display = "";
      document.getElementById("overviewCard").style.display = "";
      document.getElementById("botsCard").style.display = "";
      document.getElementById("walletCard").style.display = "";
      document.getElementById("tokenCard").style.display = "";
      document.getElementById("meshCard").style.display = "";
      document.getElementById("walletsCard").style.display = "";

      const me = await (await fetch(window.API_BASE+"/me", { headers: authHeaders() })).json();
      document.getElementById("me").textContent = JSON.stringify(me, null, 2);

      const ov = await (await fetch(window.API_BASE+"/metrics/overview", { headers: authHeaders() })).json();
      document.getElementById("overview").textContent = JSON.stringify(ov, null, 2);

      await loadBots();
      await nearInit();
      await refreshNearToken();
      await meshRefresh();
      await refreshWallets();

      // Wire buttons
      document.getElementById("btnReloadBots").onclick = loadBots;
      document.getElementById("btnAddBot").onclick = addBot;
      document.getElementById("btnNearConnect").onclick = nearConnect;
      document.getElementById("btnNearDisconnect").onclick = nearDisconnect;
      document.getElementById("btnTokenReload").onclick = refreshNearToken;
      document.getElementById("btnMeshReload").onclick = meshRefresh;
      document.getElementById("btnSaveTon").onclick = saveTon;
    }

    async function loadBots(){
      const res  = await fetch(window.API_BASE+"/bots", { headers: authHeaders() });
      const bots = await res.json();
      document.getElementById("bots").textContent = JSON.stringify(bots, null, 2);
    }

    async function addBot(){
      const name = prompt("Bot Name?"); if (!name) return;
      const slug = prompt("Slug (unique)?"); if (!slug) return;
      const description = prompt("Beschreibung (optional)") || null;
      const res = await fetch(window.API_BASE+"/bots", {
        method:"POST", headers: authHeaders(), body: JSON.stringify({ name, slug, description, is_active:true })
      });
      if (!res.ok) { alert(await res.text()); return; }
      await loadBots();
    }

    function mountLogin(){
      const slot = document.getElementById("tgSlot");
      slot.innerHTML = "";
      const s = document.createElement("script");
      s.src = "https://telegram.org/js/telegram-widget.js?22";
      s.async = true;
      s.setAttribute("data-telegram-login", window.BOT_USERNAME);
      s.setAttribute("data-size", "large");
      s.setAttribute("data-userpic", "true");
      s.setAttribute("data-request-access", "write");
      s.setAttribute("data-onauth", "onTelegramAuth");
      slot.appendChild(s);
    }

    function boot(){
      mountLogin();
      if (getToken()) {
        document.getElementById("login").style.display = "none";
        bootAfterLogin();
      }
    }
    document.addEventListener("DOMContentLoaded", boot);
  </script>

  <!-- Wallet Selector (ESM) -->
  <link rel="stylesheet" href="https://unpkg.com/@near-wallet-selector/modal-ui@8.3.1/styles.css" />
  <script type="module">
  // 1) Erst versuchen wir esm.sh OHNE harte Version (manche Builds sind nicht gecached):
  const sources = [
    "https://esm.sh/@near-wallet-selector/core?target=es2020&bundle",
    "https://esm.sh/@near-wallet-selector/modal-ui?target=es2020&bundle",
    "https://esm.sh/@near-wallet-selector/meteor-wallet?target=es2020&bundle",
    "https://esm.sh/@near-wallet-selector/my-near-wallet?target=es2020&bundle",
  ];

  // 2) Fallback auf jsDelivr (falls esm.sh 404 liefert). jsDelivr benötigt ?module:
  const fallbacks = [
    "https://cdn.jsdelivr.net/npm/@near-wallet-selector/core/dist/index.js?module",
    "https://cdn.jsdelivr.net/npm/@near-wallet-selector/modal-ui/dist/index.js?module",
    "https://cdn.jsdelivr.net/npm/@near-wallet-selector/meteor-wallet/dist/index.js?module",
    "https://cdn.jsdelivr.net/npm/@near-wallet-selector/my-near-wallet/dist/index.js?module",
  ];

  async function importAll(arr) {
    return Promise.all(arr.map(u => import(u)));
  }

  async function bootSelector() {
    try {
      var [
        core, modalUi, meteor, mynear
      ] = await importAll(sources);
    } catch (e1) {
      console.warn("esm.sh Import fehlgeschlagen, versuche jsDelivr…", e1);
      try {
        [core, modalUi, meteor, mynear] = await importAll(fallbacks);
      } catch (e2) {
        console.warn("jsDelivr auch fehlgeschlagen – NEAR-Connect wird vorübergehend deaktiviert.", e2);
        // Soft-Disable: UI bleibt benutzbar; Wallet-Übersicht kommt serverseitig.
        window.nearInit = async function(){
          document.getElementById("nearConnected").textContent = "nicht verbunden";
          document.getElementById("nearAccount").textContent   = "—";
        };
        window.nearConnect = ()=>alert("NEAR-Connect ist vorübergehend deaktiviert (CDN-Import).");
        window.nearDisconnect = ()=>{};
        return;
      }
    }

    const { setupWalletSelector } = core;
    const { setupModal } = modalUi;
    const { setupMeteorWallet } = meteor;
    const { setupMyNearWallet } = mynear;

    // Globale Struktur wie bisher
    window.__near = { selector:null, modal:null };

    window.nearInit = async function(){
      const selector = await setupWalletSelector({
        network: window.NEAR_NETWORK,
        modules: [ setupMeteorWallet(), setupMyNearWallet() ],
      });
      const modal = setupModal(selector, { contractId: "example.near" });
      window.__near.selector = selector;
      window.__near.modal = modal;
      await window.nearRefreshUi();
    };

    async function findSignedIn(){
      if (!window.__near.selector) return null;
      const wallet = await window.__near.selector.wallet();
      const accs = await wallet.getAccounts();
      return accs?.[0]?.accountId || null;
    }

    window.nearConnect = () => window.__near?.modal?.show();
    window.nearDisconnect = async () => {
      const w = await window.__near.selector.wallet();
      try { await w.signOut(); } catch {}
      await window.nearRefreshUi();
    };

    window.nearRefreshUi = async () => {
      const acc = await findSignedIn();
      document.getElementById("nearAccount").textContent   = acc || "—";
      document.getElementById("nearConnected").textContent = acc ? "verbunden" : "nicht verbunden";
      document.getElementById("btnNearConnect").disabled    = !!acc;
      document.getElementById("btnNearDisconnect").disabled = !acc;
      // Binding/Signaturen können wir später wieder aktivieren; heute reicht Anzeige.
    };
  }

  // Start
  bootSelector().catch(e => console.error("Wallet-Selector init error:", e));
</script>

</head>

<body>
  <h1>Emerald DevDashboard <span class="pill">v1.1</span></h1>

  <!-- Login -->
  <div class="card" id="login">
    <h3>Anmeldung</h3>
    <div id="tgSlot"></div>
    <small>Login wird serverseitig verifiziert.</small>
  </div>

  <!-- Me -->
  <div class="card" id="meCard" style="display:none">
    <h3>Angemeldet</h3>
    <pre id="me"></pre>
  </div>

  <!-- Overview -->
  <div class="card" id="overviewCard" style="display:none">
    <h3>Overview</h3>
    <pre id="overview"></pre>
  </div>

  <!-- Bots -->
  <div class="card" id="botsCard" style="display:none">
    <h3>Bots</h3>
    <div class="row">
      <button id="btnReloadBots">Neu laden</button>
      <button id="btnAddBot">Bot hinzufügen</button>
    </div>
    <pre id="bots"></pre>
  </div>

  <!-- NEAR Wallet / Connect -->
  <div class="card" id="walletCard" style="display:none">
    <h3>NEAR Connect</h3>
    <div class="row">
      <button id="btnNearConnect">Wallet verbinden</button>
      <button id="btnNearDisconnect" disabled>Trennen</button>
      <span class="pill">Status: <span id="nearConnected">—</span></span>
      <span class="pill">Account: <span id="nearAccount">—</span></span>
    </div>
    <p><small>Nach Verbindung wird die Wallet mit deiner Telegram‑ID verknüpft (Server‑Verify).</small></p>
    <pre id="nearBindResult"></pre>
  </div>

  <!-- Token Dynamics (NEP‑141 + Off‑chain Events) -->
  <div class="card" id="tokenCard" style="display:none">
    <h3>Token Dynamics</h3>
    <div class="row"><button id="btnTokenReload">Neu laden</button></div>
    <pre id="tokenSummary"></pre>
  </div>

  <!-- Wallets (NEAR + TON) -->
  <div class="card" id="walletsCard" style="display:none">
    <h3>Wallets</h3>
    <div class="row" style="gap:8px; align-items:center">
      <span class="pill">NEAR Watch: emeraldcontent.near</span>
      <span class="pill">NEAR Watch: pay.emeraldcontent.near</span>
    </div>
    <div class="row" style="margin-top:8px">
      <div style="flex:1">
        <h4>emeraldcontent.near</h4>
        <pre id="nearAcc1"></pre>
      </div>
      <div style="flex:1">
        <h4>pay.emeraldcontent.near</h4>
        <pre id="nearAcc2"></pre>
      </div>
    </div>
    <hr>
    <div>
      <h4>TON Wallet</h4>
      <div class="row">
        <input id="tonAddress" placeholder="EQC... (TON Adresse)" />
        <button id="btnSaveTon">Speichern</button>
      </div>
      <pre id="tonInfo"></pre>
    </div>
  </div>

  <!-- Mesh: alle Bots ansprechen -->
  <div class="card" id="meshCard" style="display:none">
    <h3>Bot‑Mesh</h3>
    <div class="row"><button id="btnMeshReload">Pingen & Laden</button></div>
    <h4>Health</h4>
    <pre id="meshHealth"></pre>
    <h4>Metrics</h4>
    <pre id="meshMetrics"></pre>
  </div>
</body>
</html>
